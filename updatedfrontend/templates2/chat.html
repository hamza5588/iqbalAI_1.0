<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
    <script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f7f7f7;
            color: #333;
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 300px;
            background: #202123;
            color: #fff;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Action Buttons Container */
        .sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: #202123;
            padding: 10px 0;
            z-index: 10;
        }

        .new-conversation-btn,
        .logout-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #565869;
            border-radius: 8px;
            background: transparent;
            color: hsl(0, 0%, 100%);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s ease;
        }

        .new-conversation-btn:hover,
        .logout-btn:hover {
            background: #343541;
        }

        /* Conversation List */
        #conversationList {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            background: #343541;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid transparent;
            position: relative;
        }

        .history-item:hover {
            background: #40414f;
        }

        .history-item.active {
            background: #40414f;
            border-left-color: #10a37f;
        }

        .history-item i {
            color: #8e8ea0;
        }

        .history-item-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #fff;
        }

        .delete-conversation-btn {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: block;
            transition: all 0.3s ease;
        }

        .download-conversation-btn {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: block;
            transition: all 0.3s ease;
        }

        .history-item:hover .delete-conversation-btn,
        .history-item:hover .download-conversation-btn {
            display: block;
        }

        .delete-conversation-btn:hover {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .download-conversation-btn:hover {
            color: #10a37f;
            background: rgba(16, 163, 127, 0.1);
        }

        /* Sidebar for Chat History */
        .sidebar {
            width: 300px;
            background: #202123;
            color: #fff;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #fff;
        }

        .history-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #343541;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: #40414f;
        }

        .history-item.active {
            background: #40414f;
            border-left: 4px solid #10a37f;
        }

        /* Main Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            height: 100vh;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f7f7f7;
            scrollbar-width: thin;
            scrollbar-color: #565869 #f7f7f7;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: #f7f7f7;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: #565869;
            border-radius: 4px;
        }

        .message {
            padding: 15px;
            margin-bottom: 15px;
            max-width: 80%;
            border-radius: 12px;
            opacity: 0;
            transform: translateY(20px);
            animation: messageAppear 0.5s forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px;
            margin-bottom: 15px;
            max-width: 80%;
            border-radius: 12px;
            background: #40414f;
            color: #fff;
            margin-right: auto;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-5px);
            }
        }

        .user-message {
            background: #10a37f;
            color: #fff;
            margin-left: auto;
        }

        .bot-message {
            background: #40414f;
            color: white;
            margin-right: auto;
        }

        /* Input Area */
        .input-area {
            background: #fff;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .message-input {
            flex: 1;
            padding: 12px 20px;
            background: #f7f7f7;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #10a37f;
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
        }

        .message-input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .send-button {
            background: #10a37f;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .send-button:hover {
            background: #0d8a6a;
        }

        .send-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .file-upload-btn {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            padding: 12px;
            border: 1px solid #565869;
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s ease;
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .file-upload-btn:hover {
            background: #343541;
        }


        /* Media Queries for different screen sizes */
        @media (max-width: 768px) {
            .file-upload-btn {
                padding: 10px 12px;
                font-size: 35px;
                /* Consistent with other buttons */
            }
        }


        @media (max-width: 480px) {
            .file-upload-btn {
                padding: 8px 10px;
                font-size: 16px;
            }
        }

        .file-list {
            margin-top: 15px;
            display: none;

        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.2s ease;
        }

        .file-item:hover {
            background: #e9ecef;
        }

        .file-item>div {
            display: flex;
            align-items: center;
        }



        .file-icon {
            color: #6c757d;
            margin-right: 10px;
            font-size: 16px;
        }

        .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .remove-file:hover {
            background: #c82333;
        }

        /* Processing Spinner */
        #processingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }


        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }


        .voice-input-btn,
        .voice-output-btn {
            background: #40414f;
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .voice-input-btn:hover,
        .voice-output-btn:hover {
            background: #343541;
        }

        .voice-input-btn.active {
            background: #10a37f;
        }

        .voice-output-btn.active {
            background: #10a37f;
        }


        .sidebar {
            width: 300px;
            background: #202123;
            color: #fff;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Action Buttons Container */
        .sidebar-actions {
            position: sticky;
            top: 0;
            background: #202123;
            padding: 10px 0;
            margin-bottom: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .new-conversation-btn,
        .logout-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #565869;
            border-radius: 8px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s ease;
        }

        .new-conversation-btn:hover,
        .logout-btn:hover {
            background: #343541;
        }

        /* Conversation List */
        #conversationList {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            background: #343541;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid transparent;
        }

        .history-item:hover {
            background: #40414f;
        }

        .history-item.active {
            background: #40414f;
            border-left-color: #10a37f;
        }

        .history-item i {
            color: #8e8ea0;
        }

        .history-item-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #fff;
        }

        .settings-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #565869;
            border-radius: 8px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s ease;
        }

        .settings-btn:hover {
            background: #343541;
        }

        .settings-btn.blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% {
                background: transparent;
            }

            50% {
                background: #e74c3c;
            }

            100% {
                background: transparent;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .api-key-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .api-key-steps {
            padding-left: 20px;
            margin: 15px 0;
        }

        .api-key-steps li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .api-key-steps a {
            color: #007bff;
            text-decoration: none;
        }

        .api-key-steps a:hover {
            text-decoration: underline;
        }

        .api-key-note {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .api-key-input-container {
            margin-bottom: 20px;
        }

        .api-key-input-group {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .api-key-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #toggleApiKey {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0 10px;
            cursor: pointer;
        }

        .update-btn {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .update-btn:hover {
            background-color: #0056b3;
        }

        .update-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Add these responsive styles to your existing <style> section */

        /* Base mobile-first styles */
        @media screen and (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 70px;
                overflow: hidden;
                position: fixed;
                top: 0;
                z-index: 100;
                transition: height 0.3s ease;
            }

            .sidebar button {
                display: none;
            }

            .sidebar.expanded {
                height: 100vh;
                display: block;
                overflow-y: auto;
            }

            .sidebar.expanded button {
                display: block;
            }

            /* Hamburger menu for mobile */
            .mobile-menu-toggle {
                display: block;
                position: absolute;
                right: 20px;
                top: 15px;
                background: none;
                border: none;
                color: #fff;
                font-size: 24px;
                cursor: pointer;
                z-index: 101;
            }

            .chat-container {
                margin-top: 70px;
                height: calc(100vh - 70px);
            }

            .input-container {
                flex-wrap: wrap;
                gap: 8px;
            }

            .message-input {
                width: calc(100% - 16px);
                order: 1;
            }

            .button-group {
                display: flex;
                gap: 8px;
                /* width: 100%; */
                order: 2;
                justify-content: space-between;
            }

            .send-button,
            .voice-input-btn,
            .voice-output-btn {
                flex: 1;
                padding: 10px;
                min-width: 0;
            }

            .message {
                max-width: 85%;
                font-size: 14px;
            }

            /* Modal adjustments for mobile */
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
            }

            /* File list adjustments */
            .file-list {
                margin: 10px 0;
            }

            /* Settings and prompt modal adjustments */
            .settings-group,
            .prompt-group {
                margin-bottom: 15px;
            }

            .api-key-input-group {
                flex-direction: column;
            }

            .api-key-input-group input {
                width: 100%;
                margin-bottom: 8px;
            }
        }

        /* Larger screen adjustments */
        @media screen and (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }

            .button-group {
                display: flex;
                gap: 8px;
            }
        }

        /* Updated mobile input area styles */
        @media screen and (max-width: 768px) {
            .input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #fff;
                padding: 12px;
                border-top: 1px solid #e0e0e0;
            }

            .input-container {
                display: flex;
                align-items: center;
                gap: 8px;
                max-width: 100%;
                margin: 0;
                padding: 0 4px;
            }

            .message-input {
                flex: 1;
                min-height: 40px;
                max-height: 100px;
                padding: 8px 12px;
                margin: 0;
                border-radius: 20px;
                font-size: 14px;
                border: 1px solid #e0e0e0;
                background: #f7f7f7;
            }

            /* Button group styling */
            .button-group {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            /* Individual button styling */
            .send-button,
            .voice-input-btn,
            .voice-output-btn {
                width: 40px;
                height: 40px;
                padding: 0;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #10a37f;
            }

            .voice-input-btn,
            .voice-output-btn {
                background: #40414f;
            }

            /* Icon sizing */
            .button-group i {
                font-size: 16px;
            }

            /* Messages container adjustment */
            .messages-container {
                padding-bottom: 80px;
                /* Space for input area */
                margin-bottom: 0;
            }

            /* File list adjustments */
            .file-list {
                position: absolute;
                bottom: 100%;
                left: 0;
                right: 0;
                background: #fff;
                border-top: 1px solid #e0e0e0;
                padding: 8px;
                max-height: 150px;
                overflow-y: auto;
            }
        }

        .markdown-content {
            position: relative;
        }

        .copy-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
            z-index: 2;
        }

        .copy-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .copy-button i {
            font-size: 14px;
        }

        /* Voice Chat Styles */
        .voice-chat-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            z-index: 1000;
        }

        .ring-box {
            background: linear-gradient(135deg, #10a37f 0%, #0d8a6a 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            min-width: 200px;
        }

        .call-status {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 24px;
            margin: 10px 0;
            font-family: monospace;
        }

        #endCallBtn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 10px;
        }

        #endCallBtn:hover {
            background: #c0392b;
        }

        /* Add these styles after the existing modal styles */
        .survey-group {
            margin-bottom: 20px;
        }

        .survey-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 500;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        #submitSurvey {
            background: #10a37f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            transition: background 0.3s ease;
            margin-top: 20px;
        }

        #submitSurvey:hover {
            background: #0d8a6a;
        }

        /* Mobile styles for survey modal */
        @media screen and (max-width: 768px) {
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Rating buttons styles */
        .rating-group {
            margin-top: 20px;
        }

        .rating-buttons {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rating-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #10a37f;
            background: white;
            color: #10a37f;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rating-btn:hover {
            background: #10a37f;
            color: white;
            transform: translateY(-2px);
        }

        .rating-btn.selected {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
        }

        @media screen and (max-width: 480px) {
            .rating-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .rating-buttons {
                gap: 6px;
            }
        }

        /* Survey Modal Styles */
        .survey-modal {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 400px;
            width: 90%;
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease;
            margin: 15% auto;
            position: relative;
        }

        .modal.show .survey-modal {
            transform: scale(1);
            opacity: 1;
        }

        .survey-description {
            color: #666;
            text-align: center;
            margin-bottom: 24px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .rating-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .emoji-rating {
            text-align: center;
            margin-bottom: 10px;
        }

        .emoji-display {
            font-size: 48px;
            margin-bottom: 10px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .rating-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }

        .rating-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .rating-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rating-btn:hover {
            border-color: #10a37f;
            color: #10a37f;
            transform: translateY(-2px);
        }

        .rating-btn.selected {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
        }

        .rating-feedback {
            text-align: center;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rating-message {
            color: #666;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .rating-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .rating-success {
            display: none;
            color: #10a37f;
            font-size: 0.95rem;
            align-items: center;
            gap: 8px;
            animation: successFadeIn 0.5s ease forwards;
        }

        @keyframes successFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Responsiveness */
        @media screen and (max-width: 480px) {
            .survey-modal {
                width: 95%;
                margin: 10px;
            }

            .rating-buttons {
                gap: 8px;
            }

            .rating-btn {
                width: 45px;
                height: 45px;
                font-size: 14px;
            }

            .emoji-display {
                font-size: 40px;
                height: 50px;
            }
        }

        .api-key-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .api-key-steps {
            margin: 10px 0;
            padding-left: 20px;
        }

        .api-key-steps li {
            margin-bottom: 8px;
            color: #666;
        }

        .api-key-steps a {
            color: #10a37f;
            text-decoration: none;
        }

        .api-key-steps a:hover {
            text-decoration: underline;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .api-key-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .api-key-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .api-key-input-group button {
            background: none;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0 12px;
            cursor: pointer;
        }

        .update-btn {
            background: #10a37f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .update-btn:hover {
            background: #0d8a6a;
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #565869;
            border-radius: 8px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s ease;
        }

        .reset-btn:hover {
            background: #343541;
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(40, 167, 69, 0.3);
        }

        .download-section {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #007bff;
        }

        .download-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(40, 167, 69, 0.4);
        }

        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .download-btn:hover {
            background: #343541;
        }

        .voice-btn-disabled {
            opacity: 0.5 !important;
            pointer-events: none !important;
            filter: grayscale(60%);
            transition: opacity 0.2s, filter 0.2s;
        }

        .error-details {
            margin-top: 8px;
            padding: 8px;
            background: #f8d7da;
            border-radius: 4px;
            color: #721c24;
            font-size: 12px;
        }

        /* Message Styles */
        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 12px;
        }

        .bot-message {
            background: #40414f;
            color: white;
        }

        .bot-message .message-content {
            color: #495057;
        }

        /* Success/Error Icons */
        .fas.fa-check-circle {
            color: #28a745;
        }

        .fas.fa-exclamation-triangle {
            color: #dc3545;
        }

        .fas.fa-graduation-cap {
            color: #007bff;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .voice-chat-btn {
                width: 100%;
                justify-content: center;
                padding: 15px;
            }

            .download-btn {
                width: 100%;
                justify-content: center;
                padding: 15px;
            }

            .lesson-preview {
                margin: 10px 0;
                padding: 15px;
            }

            .file-item {
                padding: 12px;
            }
        }


        /*token usage meter related styling */


        /* Token Meter Styles */
        <!-- .token-meter-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .token-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .token-tooltip {
            position: relative;
            cursor: pointer;
            color: #aaa;
        }

        .token-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }

        .token-progress-container {
            position: relative;
            height: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .token-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease, background 0.5s ease;
        }

        .token-progress-labels {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
        }

        .token-history {
            display: flex;
            justify-content: space-between;
            height: 40px;
            align-items: flex-end;
        }

        .history-bar {
            width: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px 3px 0 0;
            height: calc(var(--usage) * 0.4px);
            position: relative;
        }

        .history-bar::after {
            content: attr(data-day);
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: #aaa;
        }

        #today-bar {
            background: rgba(76, 175, 80, 0.7);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .token-meter-container {
                padding: 10px;
                margin: 10px 5px;
            }

            .token-progress-container {
                height: 15px;
            }

            .token-progress-labels {
                font-size: 10px;
            }
        } -->
  


/* Token Meter Styles - Compact Sidebar Version */
.token-meter-container {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 8px;
    margin: 10px 5px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
    max-width: 250px;
    min-width: 180px;
    position: relative;
    z-index: 10;
    overflow: hidden;
}

.token-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.token-header h4 {
    margin: 0;
    font-size: 12px;
    font-weight: 600;
    color: #e0e0e0;
}

.token-tooltip {
    position: relative;
    cursor: pointer;
    color: #aaa;
    font-size: 12px;
}

.token-tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

.tooltip-text {
    visibility: hidden;
    width: 160px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 4px;
    padding: 6px;
    position: absolute;
    z-index: 1000;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 10px;
    font-weight: normal;
}

.token-progress-container {
    position: relative;
    height: 14px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 7px;
    margin-bottom: 8px;
    overflow: hidden;
}

.token-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    border-radius: 7px;
    width: 0%;
    transition: width 0.5s ease, background 0.5s ease;
}

.token-progress-labels {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
}

.token-history {
    display: flex;
    justify-content: space-between;
    height: 25px;
    align-items: flex-end;
    gap: 1px;
}

.history-bar {
    width: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px 2px 0 0;
    height: calc(var(--usage) * 0.25px);
    position: relative;
    min-height: 2px;
}

.history-bar::after {
    content: attr(data-day);
    position: absolute;
    bottom: -14px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 7px;
    color: #aaa;
    white-space: nowrap;
}

#today-bar {
    background: rgba(76, 175, 80, 0.7);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .token-meter-container {
        padding: 6px;
        margin: 8px 3px;
        min-width: 160px;
        max-width: 200px;
        position: static;
        transform: none;
        left: auto;
        right: auto;
        top: auto;
    }

    .token-header h4 {
        font-size: 11px;
    }

    .token-tooltip {
        font-size: 11px;
    }

    .tooltip-text {
        width: 140px;
        font-size: 9px;
        padding: 4px;
    }

    .token-progress-container {
        height: 12px;
    }

    .token-progress-labels {
        font-size: 8px;
    }

    .token-history {
        height: 20px;
    }

    .history-bar {
        width: 6px;
        height: calc(var(--usage) * 0.2px);
    }

    .history-bar::after {
        font-size: 6px;
        bottom: -12px;
    }
}

@media (max-width: 480px) {
    .token-meter-container {
        padding: 5px;
        margin: 5px 2px;
        min-width: 140px;
        max-width: 180px;
        position: static;
        transform: none;
        left: auto;
        right: auto;
        top: auto;
        box-sizing: border-box;
    }

    .token-header h4 {
        font-size: 10px;
    }

    .token-tooltip {
        font-size: 10px;
    }

    .tooltip-text {
        width: 120px;
        font-size: 8px;
    }

    .token-progress-container {
        height: 10px;
        margin-bottom: 6px;
    }

    .token-progress-labels {
        font-size: 7px;
    }

    .token-history {
        height: 18px;
    }

    .history-bar {
        width: 5px;
        height: calc(var(--usage) * 0.18px);
    }

    .history-bar::after {
        font-size: 5px;
        bottom: -10px;
    }
}

/* Extra small screens */
@media (max-width: 320px) {
    .token-meter-container {
        min-width: 120px;
        max-width: 160px;
        padding: 4px;
        position: static;
        transform: none;
        left: auto;
        right: auto;
        top: auto;
        box-sizing: border-box;
    }

    .token-header h4 {
        font-size: 9px;
    }

    .history-bar {
        width: 4px;
    }
}

/* Additional fixes for sidebar toggle issues */
.sidebar-closed .token-meter-container {
    display: none;
}

.sidebar-open .token-meter-container {
    display: block;
}

/* Alternative fix if you need it always visible */
.token-meter-container.sidebar-hidden {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.token-meter-container.sidebar-visible {
    opacity: 1;
    pointer-events: auto;
    transition: opacity 0.3s ease;
}

        /* New Floating Token Meter Styles */
        .token-meter-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 320px;
            min-width: 280px;
        }

        .token-meter-floating .token-meter-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 4px 16px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInFromTop 0.6s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .token-meter-floating .token-meter-container:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 6px 20px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .token-meter-floating .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .token-meter-floating .token-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .token-meter-floating .token-header h4 i {
            color: #10a37f;
            font-size: 18px;
        }

        .token-meter-floating .token-tooltip {
            position: relative;
            cursor: pointer;
            color: #718096;
            transition: color 0.2s ease;
        }

        .token-meter-floating .token-tooltip:hover {
            color: #10a37f;
        }

        .token-meter-floating .tooltip-text {
            visibility: hidden;
            width: 240px;
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            right: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 12px;
            font-weight: normal;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .token-meter-floating .token-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .token-meter-floating .token-progress-container {
            position: relative;
            height: 12px;
            background: rgba(226, 232, 240, 0.8);
            border-radius: 6px;
            margin-bottom: 16px;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        .token-meter-floating .token-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10a37f, #34d399);
            border-radius: 6px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), background 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .token-meter-floating .token-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .token-meter-floating .token-progress-labels {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: #4a5568;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .token-meter-floating .token-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .token-meter-floating .token-stat {
            text-align: center;
            padding: 8px;
            background: rgba(247, 250, 252, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(226, 232, 240, 0.5);
            transition: all 0.2s ease;
        }

        .token-meter-floating .token-stat:hover {
            background: rgba(237, 242, 247, 0.9);
            transform: translateY(-1px);
        }

        .token-meter-floating .stat-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: #718096;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token-meter-floating .stat-value {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: #2d3748;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }

        /* High usage warning states */
        .token-meter-floating .token-progress-bar.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .token-meter-floating .token-progress-bar.danger {
            background: linear-gradient(90deg, #ef4444, #f87171);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Mobile Responsiveness */
        @media screen and (max-width: 768px) {
            .token-meter-floating {
                position: fixed;
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                min-width: auto;
            }

            .token-meter-floating .token-meter-container {
                padding: 16px;
                border-radius: 12px;
            }

            .token-meter-floating .token-header h4 {
                font-size: 14px;
            }

            .token-meter-floating .token-stats {
                gap: 8px;
            }

            .token-meter-floating .stat-value {
                font-size: 12px;
            }

            .token-meter-floating .tooltip-text {
                width: 200px;
                font-size: 11px;
                padding: 10px;
            }
        }

        @media screen and (max-width: 480px) {
            .token-meter-floating {
                top: 5px;
                right: 5px;
                left: 5px;
            }

            .token-meter-floating .token-meter-container {
                padding: 12px;
            }

            .token-meter-floating .token-header h4 {
                font-size: 13px;
            }

            .token-meter-floating .token-stats {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }

        /* Collapse animation for mobile */
        .token-meter-floating.collapsed .token-meter-container {
            transform: scale(0.8);
            opacity: 0.7;
        }

        .token-meter-floating.collapsed:hover .token-meter-container {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- Sidebar for Chat History -->
    <div class="sidebar">
        <div class="sidebar-actions">
            <button id="newConversationBtn" class="new-conversation-btn">
                <i class="fas fa-plus" title="New Chat"></i>
                New Chat
            </button>
            <button id="voiceChatBtn" class="voice-chat-btn">
                <i class="fas fa-microphone" title="Voice Chat"></i>
                Real Time Chat
            </button>
            <button id="genrateBtn" class="voice-chat-btn">
                <i class="fas fa-microphone"></i>
                Generate Lesson
            </button>
            <button id="settingsBtn" class="settings-btn">
                <i class="fas fa-cog" title="Update Api Key"></i>
                Update Api Key
            </button>
            <button id="testSurveyBtn" class="settings-btn" onclick="testSurvey()">
                <i class="fas fa-clipboard-check" title="Test Survey"></i>
                Test Survey
            </button>
            <button id="resetSurveyBtn" class="settings-btn" onclick="resetSurvey()">
                <i class="fas fa-undo" title="Reset Survey"></i>
                Reset Survey
            </button>
            <button id="resetBtn" class="reset-btn" onclick="resetChat()">
                <i class="fas fa-redo" title="Reset Chat"></i>
                Reset Chat
            </button>
            <!-- <button id="logoutBtn" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt" title="Logout"></i>
                Logout
            </button> -->
            <button id="logoutBtn" class="logout-btn" type="button">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <!-- Add a How it Works button to the sidebar -->
            <button id="howItWorksBtn" class="settings-btn">
                <i class="fas fa-info-circle"></i> How it Works
            </button>
        </div>
        <div id="conversationList"></div>
    </div>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>


    <!-- Main Chat Container -->
    <div class="chat-container">
        <!-- Token Meter - Floating Card in Top Right -->
        <div class="token-meter-floating">
            <div class="token-meter-container">
                <div class="token-header">
                    <h4><i class="fas fa-chart-line"></i> Token Usage</h4>
                    <div class="token-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">
                            You have <span id="token-remaining">100,000</span> tokens remaining today.
                            Resets in <span id="token-reset-time">24h 0m</span>.
                            Tokens refresh every 24 hours.
                        </span>
                    </div>
                </div>

                <div class="token-progress-container">
                    <div class="token-progress-bar" id="token-progress-bar"></div>
                    <div class="token-progress-labels">
                        <span id="token-used">0</span> / <span id="token-limit">100,000</span>
                    </div>
                </div>

                <div class="token-stats">
                    <div class="token-stat">
                        <span class="stat-label">Used</span>
                        <span class="stat-value" id="token-used-display">0</span>
                    </div>
                    <div class="token-stat">
                        <span class="stat-label">Remaining</span>
                        <span class="stat-value" id="token-remaining-display">100,000</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-container" id="chatContainer">
            <!-- Messages will be dynamically added here -->
        </div>
        <!-- Input Area -->
        <div class="input-area">
            <div class="input-container">
                <textarea id="messageInput" class="message-input" placeholder="Type your message here..." rows="1"
                    onInput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';"></textarea>
                <button class="send-button" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="voice-input-btn" id="voiceInputBtn" onclick="toggleVoiceInput()">
                    <i class="fas fa-microphone" title="Voice Input"></i>
                </button>
                <button class="voice-output-btn" id="voiceOutputBtn" onclick="toggleVoiceOutput()">
                    <i class="fas fa-volume-up" title="Voice Output"></i>
                </button>

                <!-- Add a loading indicator for voice processing -->
                <div id="voiceProcessing" style="display: none;">
                    <div class="loader"></div> Processing voice...
                </div>
                <input type="file" id="fileInput" multiple accept=".txt,.pdf,.doc,.docx" style="display: none;"
                    onchange="handleFileSelect(event)">
            </div>
            <div class="file-list" id="fileList"></div>
            <div id="processingSpinner">
                <div class="loader"></div> Processing files...
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update API Key</h2>
                <button class="close-modal" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <div class="api-key-info">
                        <h4>How to get your GROQ API Key:</h4>
                        <ol class="api-key-steps">
                            <li>Visit <a href="https://console.groq.com/keys" target="_blank">Groq Console</a></li>
                            <li>Sign up or log in to your account</li>
                            <li>Go to the API Keys section</li>
                            <li>Click "Create API Key"</li>
                            <li>Copy your API key and paste it below</li>
                        </ol>
                        <div class="api-key-note">
                            <i class="fas fa-info-circle"></i>
                            <span>Your API key should start with "gsk_"</span>
                        </div>
                    </div>
                    <div class="api-key-input-container">
                        <label for="apiKeyInput">API Key</label>
                        <div class="api-key-input-group">
                            <input type="password" id="apiKeyInput" placeholder="Enter your API key">
                            <button id="toggleApiKey" type="button">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button id="updateApiKey" class="update-btn">
                        <i class="fas fa-key"></i> Update API Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Modal -->
    <div id="surveyModal" class="modal" style="display: none;">
        <div class="modal-content survey-modal">
            <div class="modal-header">
                <h2>How was your experience?</h2>
                <button class="close-modal" id="closeSurveyBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="survey-description">
                    Your feedback helps us improve our AI chat experience. Please rate your interaction with us.
                </div>

                <div class="rating-container">
                    <div class="emoji-rating">
                        <div class="emoji-display">
                            <i class="far fa-meh"></i>
                        </div>
                        <div class="rating-label">Select your rating</div>
                    </div>

                    <div class="rating-buttons">
                        <button class="rating-btn" data-value="1" data-emoji="far fa-angry">1</button>
                        <button class="rating-btn" data-value="2" data-emoji="far fa-frown">2</button>
                        <button class="rating-btn" data-value="3" data-emoji="far fa-meh">3</button>
                        <button class="rating-btn" data-value="4" data-emoji="far fa-smile">4</button>
                        <button class="rating-btn" data-value="5" data-emoji="far fa-grin">5</button>
                        <button class="rating-btn" data-value="6" data-emoji="far fa-grin-alt">6</button>
                        <button class="rating-btn" data-value="7" data-emoji="far fa-grin-beam">7</button>
                        <button class="rating-btn" data-value="8" data-emoji="far fa-grin-beam-sweat">8</button>
                        <button class="rating-btn" data-value="9" data-emoji="far fa-grin-stars">9</button>
                        <button class="rating-btn" data-value="10" data-emoji="far fa-grin-hearts">10</button>
                    </div>

                    <div class="rating-feedback">
                        <div class="rating-message"></div>
                        <div class="rating-success">
                            <i class="fas fa-check-circle"></i>
                            Thank you for your feedback!
                        </div>
                    </div>

                    <div class="survey-fields" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="surveyMessage">Message</label>
                            <textarea id="surveyMessage" class="form-control" rows="3"
                                placeholder="Please share your thoughts about the chat experience..."></textarea>
                        </div>
                    </div>

                    <button id="submitSurvey" class="update-btn" style="margin-top: 20px;">
                        <i class="fas fa-paper-plane"></i> Submit Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this new modal for initial API key setup -->
    <div id="apiKeySetupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Setup API Key</h2>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <p class="mb-3">Please enter your API key to continue using the chat interface.</p>
                    <div class="api-key-input-group">
                        <input type="password" id="initialApiKeyInput" placeholder="Enter your API key">
                        <button id="toggleInitialApiKey" type="button">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <button id="submitInitialApiKey" class="update-btn">Submit API Key</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add How it Works Modal -->
    <div id="howItWorksModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lesson Generation Workflow</h2>
                <button class="close-modal" id="closeHowItWorksModal">&times;</button>
            </div>
            <div class="modal-body">
                <ol style="line-height:1.7;">
                    <li><strong>Select "Generate Lesson"</strong> from the sidebar.</li>
                    <li><strong>Upload a PDF file</strong> (e.g., textbook, handout).</li>
                    <li><strong>Enter lesson plan details</strong> in the form that appears (e.g., lesson title, objectives, focus areas).</li>
                    <li><strong>iqbalAI processes</strong> your file and inputs, and generates a structured lesson plan.</li>
                    <li><strong>Review the lesson</strong> in the preview area. <br> <em>You can ask follow-up questions, edit, or refine specific lesson parts.</em></li>
                    <li><strong>After final screening and edits</strong>, the final document is ready.</li>
                    <li><strong>Download</strong> the final version as a DOCX file.</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Lesson Details Modal -->
    <div id="lessonDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lesson Details</h2>
                <button class="close-modal" id="closeLessonDetailsModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="lessonDetailsForm">
                    <div class="form-group">
                        <label for="lessonTitle">Lesson Title</label>
                        <input type="text" id="lessonTitle" name="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="lessonObjectives">Learning Objectives</label>
                        <textarea id="lessonObjectives" name="objectives" class="form-control" rows="3" placeholder="List objectives, one per line" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="lessonFocus">Focus Areas</label>
                        <textarea id="lessonFocus" name="focus_areas" class="form-control" rows="2" placeholder="Key topics or focus areas"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="lessonGrade">Grade Level</label>
                        <input type="text" id="lessonGrade" name="grade" class="form-control" placeholder="e.g., 5th Grade, High School">
                    </div>
                    <div class="form-group">
                        <label for="lessonNotes">Additional Notes</label>
                        <textarea id="lessonNotes" name="notes" class="form-control" rows="2" placeholder="Any special instructions or notes"></textarea>
                    </div>
                    <button type="submit" class="update-btn" style="margin-top: 15px;">Generate Lesson</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lesson Review/Edit Modal -->
    <div id="lessonReviewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Review & Edit Lesson</h2>
                <button class="close-modal" id="closeLessonReviewModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="lessonReviewForm">
                    <div class="form-group">
                        <label for="reviewTitle">Lesson Title</label>
                        <input type="text" id="reviewTitle" name="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="reviewSummary">Summary</label>
                        <textarea id="reviewSummary" name="summary" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Learning Objectives</label>
                        <ul id="reviewObjectivesList"></ul>
                        <button type="button" id="addObjectiveBtn" class="update-btn">Add Objective</button>
                    </div>
                    <div class="form-group">
                        <label>Sections</label>
                        <div id="reviewSectionsList"></div>
                        <button type="button" id="addSectionBtn" class="update-btn">Add Section</button>
                    </div>
                    <div class="form-group">
                        <label>Key Concepts</label>
                        <ul id="reviewKeyConceptsList"></ul>
                        <button type="button" id="addKeyConceptBtn" class="update-btn">Add Key Concept</button>
                    </div>
                    <div class="form-group">
                        <label>Activities</label>
                        <div id="reviewActivitiesList"></div>
                        <button type="button" id="addActivityBtn" class="update-btn">Add Activity</button>
                    </div>
                    <div class="form-group">
                        <label>Quiz</label>
                        <div id="reviewQuizList"></div>
                        <button type="button" id="addQuizBtn" class="update-btn">Add Quiz Question</button>
                    </div>
                    <button type="submit" class="update-btn" style="margin-top: 15px;">Download</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lesson Markdown Editor Modal -->
    <div id="lessonMarkdownModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Review & Edit Lesson (Markdown)</h2>
                <button class="close-modal" id="closeLessonMarkdownModal">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="lessonMarkdownEditor" style="width:100%;height:350px;font-family:monospace;font-size:1.1em;"></textarea>
                <div id="aiEditControls" style="margin-top:18px;display:flex;flex-direction:column;gap:8px;">
                    <button id="showPromptBtn" class="update-btn" style="width:160px;align-self:flex-start;display:flex;align-items:center;gap:6px;">
                        <i class="fas fa-check"></i> Check
                    </button>
                    <div id="promptInputRow" style="display:none;flex-direction:row;gap:8px;align-items:center;">
                        <input type="text" id="lessonEditPrompt" class="form-control" placeholder="Type a prompt to modify the lesson (e.g., 'Expand section 2', 'Add a summary', etc.)" style="flex:1; min-width:250px; height:44px; font-size:1.1em; padding:10px;">
                        <button id="sendEditPromptBtn" class="update-btn">Send</button>
                    </div>
                </div>
                <div id="lessonEditSpinner" style="display:none;margin-top:10px;">Processing...</div>
                <div id="lessonEditError" style="color:red;margin-top:10px;"></div>
                <div style="margin-top:20px;text-align:right;">
                    <button id="downloadLessonBtn" class="update-btn">Download</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Download Modal -->
    <div id="downloadModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h2>Download Lesson</h2>
                <button class="close-modal" id="closeDownloadModal">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;">
                <button id="downloadAsDocxBtn" class="update-btn" style="width:80%;margin:10px auto;">Download as DOCX</button>
                <button id="downloadAsPptBtn" class="update-btn" style="width:80%;margin:10px auto;">Download as PPT</button>
            </div>
        </div>
    </div>

    <script>

        // TOKEN USAGE METER RELATED JavaScript 


let tokenUpdateInterval;

function updateTokenMeter() {
    console.log("Updating token meter..."); // Debug log
    
    fetch('/token_status')
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    console.error("Full error response:", errData);
                    throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Token data received:", data); // Debug log
            
            if (data.error) {
                console.error('Token API Error:', data.error);
                document.getElementById('token-progress-bar').style.width = '0%';
                document.getElementById('token-used').textContent = 'Error';
                document.getElementById('token-reset-time').textContent = data.error.substring(0, 50) + '...';
                return;
            }

            // Update progress bar
            const progressBar = document.getElementById('token-progress-bar');
            const percentUsed = Math.min(100, (data.used / data.limit) * 100);
            progressBar.style.width = `${percentUsed}%`;
            
            // Update colors based on usage
            progressBar.classList.remove('warning', 'danger');
            if (percentUsed > 90) {
                progressBar.classList.add('danger');
            } else if (percentUsed > 75) {
                progressBar.classList.add('warning');
            }

            // Update numbers in progress labels
            document.getElementById('token-used').textContent = data.used.toLocaleString();
            document.getElementById('token-limit').textContent = data.limit.toLocaleString();
            
            // Update stat displays
            document.getElementById('token-used-display').textContent = data.used.toLocaleString();
            document.getElementById('token-remaining-display').textContent = (data.limit - data.used).toLocaleString();
            
            // Update reset time in tooltip
            const hours = Math.floor(data.reset_in / 3600);
            const minutes = Math.floor((data.reset_in % 3600) / 60);
            document.getElementById('token-reset-time').textContent = `${hours}h ${minutes}m`;
            
            console.log("Token meter updated successfully"); // Debug log
        })
        .catch(error => {
            console.error('Error updating token meter:', error);
            // Optional: Show error to user
            document.getElementById('token-used').textContent = "Error";
            document.getElementById('token-used-display').textContent = "Error";
            document.getElementById('token-remaining-display').textContent = "Error";
            document.getElementById('token-reset-time').textContent = "";
        });
}

// More aggressive updating for testing
function startTokenMeterUpdates() {
    updateTokenMeter(); // Initial update
    tokenUpdateInterval = setInterval(updateTokenMeter, 5000); // Update every 5s for testing
}

// Call this when your app initializes
document.addEventListener('DOMContentLoaded', function() {
    console.log("Starting token meter updates...");
    startTokenMeterUpdates();
    
    // Also update after each message
    const originalSendMessage = window.sendMessage;
    window.sendMessage = function() {
        const result = originalSendMessage.apply(this, arguments);
        setTimeout(updateTokenMeter, 1000); // Update after 1 second
        return result;
    };
});












        // FILE UPLOADING AND LESSON GENERATION SETUP 

        let uploadedFiles = [];
        let processingFiles = false;

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const spinner = document.getElementById('processingSpinner');
            const fileList = document.getElementById('fileList');

            // Show spinner
            spinner.style.display = 'block';

            // Clear and show file list
            fileList.style.display = 'block';
            fileList.innerHTML = '';

            // Clear previous uploads
            uploadedFiles = [];

            // Display selected files
            for (const file of files) {
                uploadedFiles.push(file);
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
            <div>
                <i class="fas fa-file file-icon"></i>
                <span>${file.name}</span>
            </div>
            <button class="remove-file" onclick="removeFile('${file.name}')">
                <i class="fas fa-times"></i>
            </button>
        `;
                fileList.appendChild(fileItem);
            }

            // Process files and generate lesson
            generateLessonFromFiles(files);
        }

        // FIXED: Added the missing generateLessonFromFiles function
        async function generateLessonFromFiles(files) {
            if (processingFiles || files.length === 0) {
                hideSpinner();
                return;
            }

            processingFiles = true;
            const spinner = document.getElementById('processingSpinner');

            try {
                // Show processing message
                showProcessingMessage("Processing files and generating lesson...");

                // Process the first file (you can extend this for multiple files)
                const file = files[0];

                // Validate file type
                const allowedTypes = ['.pdf', '.doc', '.docx', '.txt'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                if (!allowedTypes.includes(fileExtension)) {
                    throw new Error('File type not supported. Please upload PDF, DOC, DOCX, or TXT files.');
                }

                // Use the working uploadAndDownloadFile function
                await uploadAndDownloadFile(file);

                // Show success message
                showSuccessMessage("Lesson generated and downloaded successfully!");

            } catch (error) {
                console.error('Error generating lesson:', error);
                showErrorMessage(error.message || 'Failed to generate lesson. Please try again.');
            } finally {
                processingFiles = false;
                hideSpinner();
            }
        }

        // FIXED: Updated uploadAndDownloadFile with better error handling
        async function uploadAndDownloadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showProcessingMessage("Uploading file and generating lesson...");

                const response = await fetch('/generate_lesson', {
                    method: 'POST',
                    body: formData,
                    // Important: Don't set Content-Type header, let browser set it with boundary
                });

                if (!response.ok) {
                    let errorMessage = 'Failed to generate lesson';
                    try {
                        const error = await response.json();
                        errorMessage = error.error || errorMessage;
                    } catch (e) {
                        // If JSON parsing fails, use status text
                        errorMessage = response.statusText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                // Extract filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                const filenameMatch = contentDisposition ? contentDisposition.match(/filename="(.+)"/) : null;
                const filename = filenameMatch ? filenameMatch[1] : `lesson_${file.name.split('.')[0]}.docx`;

                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                // Get metadata from headers if available
                const title = response.headers.get('X-Lesson-Title');
                if (title) {
                    console.log('Downloaded lesson:', title);
                }

                return { success: true, filename };

            } catch (error) {
                console.error('Upload error:', error);
                throw error; // Re-throw to be handled by caller
            }
        }

        // FIXED: Added utility functions for better UX
        function showProcessingMessage(message) {
            const spinner = document.getElementById('processingSpinner');
            if (spinner) {
                spinner.innerHTML = `<div class="loader"></div> ${message}`;
                spinner.style.display = 'block';
            }
        }

        function showSuccessMessage(message) {
            // customize this to show success messages in your UI
            // For now, using console and potentially showing in chat
            console.log('Success:', message);

            // If you have an addMessage function for chat, use it
            if (typeof addMessage === 'function') {
                addMessage('bot', `<div class="success-message"><i class="fas fa-check-circle"></i> ${message}</div>`);
            } else {
                alert(message); // Fallback
            }
        }

        function showErrorMessage(message) {
            // You can customize this to show error messages in your UI
            console.error('Error:', message);

            // If you have an addMessage function for chat, use it
            if (typeof addMessage === 'function') {
                addMessage('bot', `<div class="error-message"><i class="fas fa-exclamation-circle"></i> ${message}</div>`);
            } else {
                alert(`Error: ${message}`); // Fallback
            }
        }

        function hideSpinner() {
            const spinner = document.getElementById('processingSpinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        // FIXED: Updated removeFile function with better error handling
        function removeFile(filename) {
            try {
                uploadedFiles = uploadedFiles.filter(file => file.name !== filename);

                // Remove from UI
                const fileItems = document.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    const filenameSpan = item.querySelector('span');
                    if (filenameSpan && filenameSpan.textContent === filename) {
                        item.remove();
                    }
                });

                // Hide file list if no files
                if (uploadedFiles.length === 0) {
                    const fileList = document.getElementById('fileList');
                    if (fileList) {
                        fileList.style.display = 'none';
                    }
                    hideSpinner();
                }
            } catch (error) {
                console.error('Error removing file:', error);
            }
        }

        // FIXED: Added click handler for generate button
        document.addEventListener('DOMContentLoaded', function () {
            const generateBtn = document.getElementById('genrateBtn'); // Note: your ID has a typo
            const fileInput = document.getElementById('fileInput');

            if (generateBtn && fileInput) {
                generateBtn.addEventListener('click', function () {
                    if (processingFiles) {
                        showErrorMessage('Already processing files. Please wait...');
                        return;
                    }

                    // Trigger file input
                    fileInput.click();
                });
            }
        });

        // Keep your existing displayLessonPreview function as is
        function displayLessonPreview(lesson) {
            let previewHtml = '<div class="lesson-preview">';

            // Add title
            if (lesson.title) {
                previewHtml += `<h3><i class="fas fa-graduation-cap me-2"></i>${lesson.title}</h3>`;
            }

            // Add summary
            if (lesson.summary) {
                previewHtml += `<div class="lesson-summary"><strong>Summary:</strong> ${lesson.summary}</div>`;
            }

            // Add learning objectives
            if (lesson.learning_objectives && lesson.learning_objectives.length > 0) {
                previewHtml += '<div class="learning-objectives"><strong>Learning Objectives:</strong><ul>';
                lesson.learning_objectives.forEach(obj => {
                    previewHtml += `<li>${obj}</li>`;
                });
                previewHtml += '</ul></div>';
            }

            // Add sections preview (first 2 sections)
            if (lesson.sections && lesson.sections.length > 0) {
                previewHtml += '<div class="lesson-sections"><strong>Lesson Sections:</strong>';
                lesson.sections.slice(0, 2).forEach(section => {
                    previewHtml += `<div class="section-preview">
                <h4>${section.heading}</h4>
                <p>${section.content.substring(0, 200)}${section.content.length > 200 ? '...' : ''}</p>
            </div>`;
                });
                if (lesson.sections.length > 2) {
                    previewHtml += `<p><em>... and ${lesson.sections.length - 2} more sections</em></p>`;
                }
                previewHtml += '</div>';
            }

            // Add quiz info
            if (lesson.quiz && lesson.quiz.length > 0) {
                previewHtml += `<div class="quiz-info"><strong>Quiz Questions:</strong> ${lesson.quiz.length} questions included</div>`;
            }

            previewHtml += '</div>';

            if (typeof addMessage === 'function') {
                addMessage('bot', previewHtml);
            }
        }










        // Global variables
        let currentConversationId = null;
        let isListening = false;
        let isSpeaking = false;
        let recognition;
        let synthesis;
        let isWaitingForResponse = false;  // Add this line here

        // Global variables for voice chat
        let peerConnection = null;
        let dataChannel = null;
        let isConnected = false;
        let timerInterval = null;
        let seconds = 0;

        // Add a global variable to track if voice input was used
        let usedVoiceInput = false;

        // Voice chat container HTML
        const voiceChatHTML = `
    <div id="voiceChatContainer" class="voice-chat-container" style="display: none;">
        <div id="ringBox" class="ring-box" style="display: none;">
            <div class="call-status">Ready to call</div>
            <div class="timer" style="display: none;">00:00:00</div>
            <button id="endCallBtn" style="display: none;">End Call</button>
        </div>
    </div>
`;

        // Add voice chat container to body
        document.body.insertAdjacentHTML('beforeend', voiceChatHTML);

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing components...'); // Debug log

            // Initialize everything
            initializeSidebar();
            setupEventListeners();
            initializeSettings();
            loadConversations();

            // Initialize voice synthesis
            loadVoices().then(() => {
                console.log('Available voices:', allVoices.map(v => `${v.name} (${v.lang})`).join('\n'));
            });

            // Setup message input auto-resize
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', () => autoResizeTextarea(messageInput));

            // Initialize survey
            // initializeSurvey();

            // Show survey after 5 minutes
            // console.log('Setting up survey timer for 5 minutes...');
            // setTimeout(function() {
            //     console.log('5 minutes passed, showing survey...');
            //     showSurvey();
            // }, 5 * 6 * 1000); // 5 minutes in milliseconds
        });





        function handleError(error, details = '') {
            let errorMessage = `<i class="fas fa-exclamation-triangle me-2"></i> ${error}`;
            if (details) {
                errorMessage += `<div class="error-details"><small>${details}</small></div>`;
            }
            addMessage('bot', errorMessage);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // File input event listener
            const fileInput = document.getElementById('fileInput');
            // if (fileInput) {
            //     fileInput.addEventListener('change', handleFileSelect);
            // }

            // Generate button event listener
            const generateBtn = document.getElementById('genrateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', function () {
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) {
                        fileInput.click();
                    }
                });
            }
        });

        // Utility function to add messages to chat (you might need to adjust this based on your chat implementation)
        function addMessage(sender, message) {
            // This function should match your existing chat message display logic
            // Example implementation:
            const chatContainer = document.getElementById('chatContainer') || document.querySelector('.chat-messages');
            if (chatContainer) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                messageDiv.innerHTML = `
            <div class="message-content">
                ${message}
            </div>
        `;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }


        // Initialization functions
        function initializeSidebar() {
            console.log('Initializing sidebar...');  // Debug log
            const sidebar = document.querySelector('.sidebar');

            // First, clear the existing content
            sidebar.innerHTML = `
        <div class="sidebar-actions">
            <button id="newConversationBtn" class="new-conversation-btn">
                <i class="fas fa-plus" title="New Chat"></i>
                New Chat
            </button>
            <button id="voiceChatBtn" class="voice-chat-btn">
                <i class="fas fa-microphone" title="Voice Chat"></i>
                Real Time Chat
            </button>
       <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-paperclip"></i>
                    Generate Lesson
                </button>
            <input type="file" id="hiddenFileInput" style="display: none;">
            <button id="settingsBtn" class="settings-btn">
                <i class="fas fa-cog" title="Update Api Key"></i>
                Update Api Key
            </button>
            <button id="resetBtn" class="reset-btn" onclick="resetChat()">
                <i class="fas fa-redo" title="Reset Chat"></i>
                Reset Chat
            </button>
            <!-- <button id="logoutBtn" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt" title="Logout"></i>
                Logout
            </button> -->
           <button id="logoutBtn" class="logout-btn" type="button">
                  <i class="fas fa-sign-out-alt"></i> Logout
             </button>
            <!-- Add a How it Works button to the sidebar -->
            <button id="howItWorksBtn" class="settings-btn">
                <i class="fas fa-info-circle"></i> How it Works
             </button>





  




<!-- 
            <div class="token-meter-container">
                <div class="token-header">
                    <h4>Token Usage</h4>
                    <div class="token-tooltip">
                         <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">
                            You have <span id="token-remaining">100,000</span> tokens remaining today.
                            Resets in <span id="token-reset-time">24h 0m</span>.
                            Tokens refresh every 24 hours.
                        </span> 
                    </div>
                </div>

                <div class="token-progress-container">
                    <div class="token-progress-bar" id="token-progress-bar"></div>
                    <div class="token-progress-labels">
                        <span id="token-used">0 </span>
                        <span id="token-limit"> - 100,000</span>
                    </div>
                </div>

                <!-- <div class="token-history">
                    <div class="history-bar" style="--usage:0%"></div>
                    <div class="history-bar" style="--usage:0%"></div>
                    <div class="history-bar" style="--usage:0%"></div>
                    <div class="history-bar" style="--usage:0%"></div>
                    <div class="history-bar" style="--usage:0%"></div>
                    <div class="history-bar" style="--usage:0%"></div>
                    <div class="history-bar" style="--usage:0%" id="today-bar"></div>
                </div> -->
            <!-- </div> -->











        </div>
        
        <div id="conversationList"></div>
    `;

            // Add these styles dynamically to ensure they're applied
            const styles = document.createElement('style');
            styles.textContent = `

    .voice-chat-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #565869;
            border-radius: 8px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s ease;
}
        .voice-chat-btn:hover {
    background: #343541;
}

.lesson-preview {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.lesson-preview h3 {
    color: #007bff;
    margin-bottom: 15px;
    font-size: 24px;
    font-weight: 600;
}

.lesson-summary {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
}
            

.learning-objectives {
    margin-bottom: 15px;
}

        .voice-chat-btn.active {
            background: #10a37f;
            border-color: #10a37f;
        }

        .voice-chat-btn i {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }
    `;
            document.head.appendChild(styles);

            // Add event listener for voice chat button
            const voiceChatBtn = document.getElementById('voiceChatBtn');
            if (voiceChatBtn) {
                console.log('Voice chat button found, adding event listener...'); // Debug log
                voiceChatBtn.addEventListener('click', async () => {
                    console.log('Voice chat button clicked'); // Debug log
                    try {
                        if (!isConnected) {
                            voiceChatBtn.classList.add('active');
                            showNotification('Connecting to voice chat...', 'info');
                            await initializeVoiceChat();
                        } else {
                            endVoiceChat();
                            voiceChatBtn.classList.remove('active');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('Failed to connect to voice chat', 'error');
                        voiceChatBtn.classList.remove('active');
                    }
                });
            } else {
                console.error('Voice chat button not found!'); // Debug log
            }
        }

        // Add this notification function if it doesn't exist
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Make sure these styles are added to your CSS
        const notificationStyles = `
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .notification.info {
        background: #3498db;
    }

    .notification.error {
        background: #e74c3c;
    }

    .notification.success {
        background: #2ecc71;
    }
`;

        // Update the mobile menu toggle JavaScript
        document.addEventListener('DOMContentLoaded', function () {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.querySelector('.sidebar');

            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('expanded');
                    const icon = this.querySelector('i');
                    if (sidebar.classList.contains('expanded')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });

                // Close sidebar when clicking outside
                document.addEventListener('click', function (event) {
                    if (!sidebar.contains(event.target) &&
                        !mobileMenuToggle.contains(event.target) &&
                        sidebar.classList.contains('expanded')) {
                        sidebar.classList.remove('expanded');
                        const icon = mobileMenuToggle.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            }

            // Reorganize input container buttons
            const inputContainer = document.querySelector('.input-container');
            if (inputContainer) {
                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'button-group';

                // Move all buttons to the button group
                const buttons = inputContainer.querySelectorAll('button');
                buttons.forEach(button => {
                    buttonGroup.appendChild(button.cloneNode(true));
                    button.remove();
                });

                inputContainer.appendChild(buttonGroup);
            }
        });

        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            const newChatBtn = document.getElementById('newConversationBtn');
            if (newChatBtn) {
                newChatBtn.addEventListener('click', createNewConversation);
            }
        }

        // Conversation management functions
        function createNewConversation() {
            fetch('/create_conversation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: 'New Chat' })
            })
                .then(response => response.json())
                .then(data => {
                    currentConversationId = data.conversation_id;
                    clearChatContainer();
                    loadConversations();
                });
        }

        function loadConversations() {
            fetch('/get_conversations')
                .then(response => response.json())
                .then(data => {
                    const conversationList = document.getElementById('conversationList');
                    conversationList.innerHTML = '';

                    data.forEach(conversation => {
                        const conversationItem = document.createElement('div');
                        conversationItem.className = 'history-item';
                        if (conversation.id === currentConversationId) {
                            conversationItem.classList.add('active');
                        }

                        conversationItem.innerHTML = `
                    <i class="fas fa-message" title="Conversation"></i>
                    <span class="history-item-title">${conversation.title || 'New Chat'}</span>
                    <button class="download-conversation-btn" onclick="downloadChat(${conversation.id})">
                        <i class="fas fa-download" title="Download Conversation"></i>
                    </button>
                    <button class="delete-conversation-btn" onclick="deleteConversation(${conversation.id})">
                        <i class="fas fa-trash" title="Delete Conversation"></i>
                    </button>
                `;

                        conversationItem.addEventListener('click', (e) => {
                            // Don't trigger conversation selection if clicking the delete button
                            if (!e.target.closest('.delete-conversation-btn')) {
                                document.querySelectorAll('.history-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                conversationItem.classList.add('active');
                                currentConversationId = conversation.id;
                                loadMessages(conversation.id);
                            }
                        });

                        conversationList.appendChild(conversationItem);
                    });
                });
        }

        function loadMessages(conversationId) {
            fetch(`/get_messages/${conversationId}`)
                .then(response => response.json())
                .then(data => {
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.innerHTML = '';

                    data.forEach(message => {
                        addMessage(message.role, message.message);
                    });

                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
        }

        // Message handling functions
        function sendMessage() {
            if (isWaitingForResponse) {
                showNotification('Please wait for the current response to complete', 'info');
                return;
            }

            stopVoiceInput();
            stopVoiceOutput();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            isWaitingForResponse = true;
            // Don't disable the input field
            document.querySelector('.send-button').disabled = true;

            // Show typing indicator after the last message
            const chatContainer = document.getElementById('chatContainer');
            const lastMessage = chatContainer.lastElementChild;
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    `;

            if (lastMessage) {
                chatContainer.insertBefore(typingIndicator, lastMessage.nextSibling);
            } else {
                chatContainer.appendChild(typingIndicator);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (!currentConversationId) {
                fetch('/create_conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: message })
                })
                    .then(response => response.json())
                    .then(data => {
                        currentConversationId = data.conversation_id;
                        sendMessageToServer(message);
                    });
            } else {
                sendMessageToServer(message);
            }
        }

        function sendMessageToServer(message) {
            addMessage('user', message);
            const messageInput = document.getElementById('messageInput');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Set a 30-second timeout to match backend
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => {
                    reject(new Error('Request timed out after 30 seconds'));
                }, 30000); // 30 seconds
            });

            // Race between the fetch and timeout
            Promise.race([
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        input: message,
                        conversation_id: currentConversationId
                    })
                }),
                timeoutPromise
            ])
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Remove typing indicator
                    const typingIndicator = document.querySelector('.typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    if (data.error) {
                        addMessage('bot', `<i class="fas fa-exclamation-circle"></i> ${data.error}`);
                    } else {
                        addMessage('bot', data.response);
                        // Only start voice output if voice input was used
                        if (usedVoiceInput) {
                            setTimeout(() => {
                                startVoiceOutput();
                                const voiceOutputBtn = document.getElementById('voiceOutputBtn');
                                if (voiceOutputBtn) {
                                    voiceOutputBtn.classList.add('active');
                                }
                            }, 100);
                        }
                        loadConversations();
                    }

                    // Reset voice input flag after response
                    usedVoiceInput = false;

                    // Re-enable button
                    isWaitingForResponse = false;
                    document.querySelector('.send-button').disabled = false;
                })
                .catch(error => {
                    // Remove typing indicator
                    const typingIndicator = document.querySelector('.typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    if (error.message.includes('timed out')) {
                        addMessage('bot', `<i class="fas fa-clock"></i> The request is taking longer than expected. Please wait a moment and try again.`);
                    } else if (error.message.includes('API key')) {
                        addMessage('bot', `<i class="fas fa-key"></i> ${error.message}`);
                    } else {
                        addMessage('bot', `<i class="fas fa-exclamation-circle"></i> ${error.message || 'Sorry, there was an error processing your message.'}`);
                    }

                    // Reset voice input flag after error
                    usedVoiceInput = false;

                    // Re-enable button
                    isWaitingForResponse = false;
                    document.querySelector('.send-button').disabled = false;
                });
        }

        function addMessage(type, content) {
            // Configure marked options
            marked.setOptions({
                gfm: true, // GitHub Flavored Markdown
                breaks: true, // Convert line breaks to <br>
                headerIds: true,
                mangle: false,
                smartLists: true,
                smartypants: true
            });

            // Create custom renderer
            const renderer = new marked.Renderer();
            renderer.code = (code, language) => {
                return `<pre><code class="language-${language}">${code}</code></pre>`;
            };
            marked.use({ renderer });

            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            // Process content through marked and sanitize it
            let formattedContent;
            if (typeof content === 'string') {
                // Sanitize and parse markdown
                const sanitizedContent = DOMPurify.sanitize(content);
                formattedContent = marked.parse(sanitizedContent);
            } else {
                formattedContent = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
            }

            // Add markdown-content class for styling and include copy button for bot messages
            if (type === 'bot') {
                messageDiv.innerHTML = `
            <div class="markdown-content">
                ${formattedContent}
                <button class="copy-button" onclick="copyMessage(this)">
                    <i class="far fa-clone"></i>
                </button>
            </div>`;
            } else {
                messageDiv.innerHTML = `<div class="markdown-content">${formattedContent}</div>`;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add this helper function for copying content
        function copyMessage(button) {
            const messageContent = button.parentElement.innerText.replace('copy', '').trim();
            navigator.clipboard.writeText(messageContent).then(() => {
                // Change icon temporarily to show success
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = '<i class="far fa-clone"></i>';
                }, 2000);
            });
        }

        // Voice input/output functions
        function toggleVoiceInput() {
            const voiceInputBtn = document.getElementById('voiceInputBtn');
            const voiceOutputBtn = document.getElementById('voiceOutputBtn');
            if (!isListening) {
                startVoiceInput();
                voiceInputBtn.classList.add('active');
                // Speaker visible but disabled
                if (voiceOutputBtn) voiceOutputBtn.classList.add('voice-btn-disabled');
            } else {
                stopVoiceInput();
                voiceInputBtn.classList.remove('active');
                // Speaker enabled
                if (voiceOutputBtn) voiceOutputBtn.classList.remove('voice-btn-disabled');
            }
        }

        function startVoiceInput() {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();
            isListening = true;
            usedVoiceInput = true; // Set flag when voice input starts

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('messageInput').value = transcript;
                stopVoiceInput();
                sendMessage();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopVoiceInput();
            };

            recognition.onend = () => {
                if (isListening) {
                    recognition.start();
                }
            };
        }

        function stopVoiceInput() {
            if (recognition) {
                recognition.stop();
            }
            isListening = false;
            document.getElementById('voiceInputBtn').classList.remove('active');
            // Always enable the speaker button when mic is off
            const voiceOutputBtn = document.getElementById('voiceOutputBtn');
            if (voiceOutputBtn) voiceOutputBtn.classList.remove('voice-btn-disabled');
        }

        function toggleVoiceOutput() {
            const voiceOutputBtn = document.getElementById('voiceOutputBtn');
            if (!isSpeaking) {
                startVoiceOutput();
                voiceOutputBtn.classList.add('active');
            } else {
                stopVoiceOutput();
                voiceOutputBtn.classList.remove('active');
            }
        }

        function startVoiceOutput() {
            const lastBotMessage = document.querySelector('.bot-message:last-child');
            if (lastBotMessage) {
                const text = lastBotMessage.innerText;
                synthesis = new SpeechSynthesisUtterance(text);

                // Get all available voices
                const voices = window.speechSynthesis.getVoices();

                // Try to find one of these female voices in order of preference
                const preferredVoices = [
                    "Microsoft Zira - English (United States)",
                    "Microsoft Emma Online (Natural) - English (United States)",
                    "Microsoft Jenny Online (Natural) - English (United States)",
                    "Microsoft Michelle Online (Natural) - English (United States)",
                    "Microsoft Aria Online (Natural) - English (United States)"
                ];

                let selectedVoice = null;
                for (const preferred of preferredVoices) {
                    selectedVoice = voices.find(voice => voice.name.includes(preferred));
                    if (selectedVoice) break;
                }

                if (selectedVoice) {
                    synthesis.voice = selectedVoice;
                    console.log("Selected voice:", selectedVoice.name);
                }

                // Set voice properties
                synthesis.pitch = 1.1;    // Slightly higher pitch
                synthesis.rate = 1.0;     // Normal speed
                synthesis.volume = 1.0;   // Full volume

                synthesis.onend = () => {
                    isSpeaking = false;
                    document.getElementById('voiceOutputBtn').classList.remove('active');
                };

                synthesis.onerror = (event) => {
                    console.error('Speech synthesis error:', event.error);
                    isSpeaking = false;
                    document.getElementById('voiceOutputBtn').classList.remove('active');
                };

                window.speechSynthesis.speak(synthesis);
                isSpeaking = true;
            }
        }

        function stopVoiceOutput() {
            if (synthesis) {
                window.speechSynthesis.cancel();
            }
            isSpeaking = false;
            document.getElementById('voiceOutputBtn').classList.remove('active');
        }

        // Settings management functions
        function initializeSettings() {
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeButtons = document.querySelectorAll('.close-modal');
            const toggleApiKeyBtn = document.getElementById('toggleApiKey');
            const updateApiKeyBtn = document.getElementById('updateApiKey');

            // Settings modal event listeners
            if (settingsBtn && settingsModal) {
                settingsBtn.addEventListener('click', () => {
                    settingsModal.style.display = 'block';
                    settingsModal.classList.add('show');
                });
            }

            // Close button event listeners
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    settingsModal.classList.remove('show');
                    setTimeout(() => {
                        settingsModal.style.display = 'none';
                    }, 300);
                });
            });

            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === settingsModal) {
                    settingsModal.classList.remove('show');
                    setTimeout(() => {
                        settingsModal.style.display = 'none';
                    }, 300);
                }
            });

            // Toggle API key visibility
            if (toggleApiKeyBtn) {
                toggleApiKeyBtn.addEventListener('click', () => {
                    const apiKeyInput = document.getElementById('apiKeyInput');
                    const type = apiKeyInput.type;
                    apiKeyInput.type = type === 'password' ? 'text' : 'password';
                    toggleApiKeyBtn.innerHTML = `<i class="fas fa-eye${type === 'password' ? '' : '-slash'}"></i>`;
                });
            }

            // Update API key
            if (updateApiKeyBtn) {
                updateApiKeyBtn.addEventListener('click', updateApiKey);
            }
        }

        function updateApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const newApiKey = apiKeyInput.value.trim();
            const updateBtn = document.getElementById('updateApiKey');
            const originalBtnText = updateBtn.textContent;

            if (!newApiKey) {
                showNotification('Please enter an API key', 'error');
                return;
            }

            // Disable button and show loading state
            updateBtn.disabled = true;
            updateBtn.textContent = 'Updating...';

            fetch('/update_api_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: newApiKey })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Failed to update API key');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('API key updated successfully', 'success');
                        const settingsModal = document.getElementById('settingsModal');
                        settingsModal.classList.remove('show');
                        setTimeout(() => {
                            settingsModal.style.display = 'none';
                            // Remove blinking animation
                            const settingsBtn = document.getElementById('settingsBtn');
                            if (settingsBtn) {
                                settingsBtn.classList.remove('blink');
                            }
                            // Reload the page to ensure everything is properly initialized with the new API key
                            window.location.reload();
                        }, 300);
                        apiKeyInput.value = '';
                    } else {
                        throw new Error(data.error || 'Failed to update API key');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification(error.message || 'Error updating API key', 'error');
                })
                .finally(() => {
                    // Re-enable button and restore text
                    updateBtn.disabled = false;
                    updateBtn.textContent = originalBtnText;
                });
        }

        function checkApiKeyStatus() {
            fetch('/check_api_key_status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to check API key status');
                    }
                    return response.json();
                })
                .then(data => {
                    const settingsBtn = document.getElementById('settingsBtn');
                    if (!data.has_api_key || data.is_expired) {
                        // Show settings modal instead of apiKeySetupModal
                        const settingsModal = document.getElementById('settingsModal');
                        settingsModal.style.display = 'block';
                        // Force a reflow before adding the show class
                        settingsModal.offsetHeight;
                        settingsModal.classList.add('show');

                        // Add blinking animation to settings button
                        if (settingsBtn) {
                            settingsBtn.classList.add('blink');
                        }
                    } else {
                        // Remove blinking animation if it exists
                        if (settingsBtn) {
                            settingsBtn.classList.remove('blink');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking API key status:', error);
                    showNotification('Error checking API key status. Please try updating your API key.', 'error');
                    // Show settings modal on error
                    const settingsModal = document.getElementById('settingsModal');
                    settingsModal.style.display = 'block';
                    settingsModal.offsetHeight;
                    settingsModal.classList.add('show');
                    // Add blinking animation to settings button on error
                    const settingsBtn = document.getElementById('settingsBtn');
                    if (settingsBtn) {
                        settingsBtn.classList.add('blink');
                    }
                });
        }









        function logout() {
            // Show loading state
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                const originalHtml = logoutBtn.innerHTML;
                logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
                logoutBtn.disabled = true;

                // Use absolute URL to ensure correct path

                const logoutUrl = window.location.origin + '/auth/logout';
                const timestamp = Date.now();

                console.log('Attempting logout to:', logoutUrl); // Debug log

                fetch(`${logoutUrl}?t=${timestamp}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        console.log('Response status:', response.status); // Debug log
                        console.log('Response headers:', response.headers); // Debug log

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data); // Debug log

                        if (data.success && data.redirect_url) {
                            window.location.href = data.redirect_url + '?t=' + timestamp;
                        } else {
                            // Fallback redirect
                            window.location.href = '/login?t=' + timestamp;
                        }
                    })
                    .catch(error => {
                        console.error('Logout error:', error);

                        // Check if it's a 404 error specifically
                        if (error.message.includes('404')) {
                            console.error('Route not found - check blueprint registration');
                            alert('Logout route not found. Please check server configuration.');
                        }

                        // Final fallback - try GET request
                        window.location.href = '/logout?t=' + timestamp;
                    })
                    .finally(() => {
                        // Reset button state only if still on page
                        if (document.contains(logoutBtn)) {
                            logoutBtn.innerHTML = originalHtml;
                            logoutBtn.disabled = false;
                        }
                    });
            } else {
                console.error('Logout button not found');
                // Fallback if button not found
                window.location.href = '/logout?t=' + Date.now();
            }
        }

        // Event listener with error handling
        document.addEventListener('DOMContentLoaded', function () {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    logout();
                });
                console.log('Logout button event listener attached');
            } else {
                console.error('Logout button not found in DOM');
            }
        });








        // Event listener with error handling
        document.addEventListener('DOMContentLoaded', function () {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    logout();
                });
            } else {
                console.error('Logout button not found');
            }
        });



        function clearChatContainer() {
            document.getElementById('chatContainer').innerHTML = '';
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleError(error, customMessage = 'An error occurred') {
            console.error(error);
            addMessage('bot', `<i class="fas fa-exclamation-circle"></i> ${customMessage}`);
        }

        // Initialize voice chat
        async function initializeVoiceChat() {
            try {
                console.log('Initializing voice chat...');

                // Disable chat controls
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.querySelector('.send-button');
                const voiceInputBtn = document.getElementById('voiceInputBtn');
                const voiceOutputBtn = document.getElementById('voiceOutputBtn');

                messageInput.disabled = true;
                sendButton.disabled = true;

                // Disable and style voice buttons
                voiceInputBtn.disabled = true;
                voiceInputBtn.classList.add('voice-btn-disabled');
                voiceInputBtn.style.opacity = '0.5';
                voiceInputBtn.style.cursor = 'not-allowed';

                voiceOutputBtn.disabled = true;
                voiceOutputBtn.classList.add('voice-btn-disabled');
                voiceOutputBtn.style.opacity = '0.5';
                voiceOutputBtn.style.cursor = 'not-allowed';

                // Request microphone permission first
                const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Get session token
                const tokenResponse = await fetch("/session");
                if (!tokenResponse.ok) {
                    throw new Error('Failed to get session token');
                }

                const data = await tokenResponse.json();
                if (!data.client_secret || !data.client_secret.value) {
                    throw new Error('Invalid session token response');
                }

                const EPHEMERAL_KEY = data.client_secret.value;

                // Create RTCPeerConnection
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // Add local audio track
                mediaStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, mediaStream);
                });

                // Setup audio output
                const audioElement = document.createElement('audio');
                audioElement.autoplay = true;

                peerConnection.ontrack = event => {
                    audioElement.srcObject = event.streams[0];
                };

                // Create data channel
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();

                // Create and send offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Send offer to OpenAI
                const apiUrl = "https://api.openai.com/v1/realtime";
                const model = "gpt-4o-realtime-preview-2024-12-17";

                const sdpResponse = await fetch(`${apiUrl}?model=${model}`, {
                    method: "POST",
                    body: offer.sdp,
                    headers: {
                        Authorization: `Bearer ${EPHEMERAL_KEY}`,
                        "Content-Type": "application/sdp"
                    },
                });

                if (!sdpResponse.ok) {
                    throw new Error('Failed to establish connection with OpenAI');
                }

                const answer = {
                    type: "answer",
                    sdp: await sdpResponse.text(),
                };
                await peerConnection.setRemoteDescription(answer);

                // Show voice chat UI
                document.getElementById('voiceChatContainer').style.display = 'block';
                document.getElementById('ringBox').style.display = 'block';

                // Update connection state
                isConnected = true;
                startTimer();

                // Update UI
                document.querySelector('.call-status').textContent = 'Connected';
                document.querySelector('.timer').style.display = 'block';
                const endCallBtn = document.getElementById('endCallBtn');
                endCallBtn.style.display = 'block';

                // Add event listener for end call button
                endCallBtn.addEventListener('click', () => {
                    endVoiceChat();
                });

            } catch (error) {
                console.error('Voice chat initialization error:', error);
                showNotification(error.message, 'error');
                endVoiceChat();
                throw error;
            }
        }

        function setupDataChannel() {
            if (!dataChannel) return;

            dataChannel.onopen = () => {
                console.log('Data channel opened');
                configureVoiceChat();
            };

            dataChannel.onclose = () => {
                console.log('Data channel closed');
                if (isConnected) {
                    showNotification('Voice chat disconnected', 'error');
                    endVoiceChat();
                }
            };

            dataChannel.onmessage = async (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('Received message:', message);

                    if (message.type === 'transcript') {
                        addMessage('bot', message.text);
                    }
                } catch (error) {
                    console.error('Error handling message:', error);
                }
            };
        }

        function configureVoiceChat() {
            const config = {
                type: 'session.update',
                session: {
                    modalities: ['text', 'audio'],
                    tools: [
                        {
                            type: 'function',
                            name: 'changeBackgroundColor',
                            description: 'Changes the background gradient of the calling interface',
                            parameters: {
                                type: 'object',
                                properties: {
                                    color1: { type: 'string', description: 'First gradient color' },
                                    color2: { type: 'string', description: 'Second gradient color' }
                                },
                                required: ['color1', 'color2']
                            }
                        }
                    ]
                }
            };

            if (dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(config));
            }
        }

        function startTimer() {
            seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                const timer = document.querySelector('.timer');
                if (timer) {
                    timer.textContent = formatTime(seconds);
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function endVoiceChat() {
            try {
                // Stop all media tracks
                if (peerConnection) {
                    peerConnection.getSenders().forEach(sender => {
                        if (sender.track) {
                            sender.track.stop();
                        }
                    });
                    peerConnection.close();
                    peerConnection = null;
                }

                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                if (dataChannel) {
                    dataChannel.close();
                    dataChannel = null;
                }

                isConnected = false;

                // Re-enable chat controls
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.querySelector('.send-button');
                const voiceInputBtn = document.getElementById('voiceInputBtn');
                const voiceOutputBtn = document.getElementById('voiceOutputBtn');

                messageInput.disabled = false;
                sendButton.disabled = false;

                // Re-enable and style voice buttons
                voiceInputBtn.disabled = false;
                voiceInputBtn.classList.remove('voice-btn-disabled');
                voiceInputBtn.style.opacity = '1';
                voiceInputBtn.style.cursor = 'pointer';

                voiceOutputBtn.disabled = false;
                voiceOutputBtn.classList.remove('voice-btn-disabled');
                voiceOutputBtn.style.opacity = '1';
                voiceOutputBtn.style.cursor = 'pointer';

                // Update UI
                const voiceChatContainer = document.getElementById('voiceChatContainer');
                const ringBox = document.getElementById('ringBox');
                const voiceChatBtn = document.getElementById('voiceChatBtn');

                if (voiceChatContainer) voiceChatContainer.style.display = 'none';
                if (ringBox) ringBox.style.display = 'none';
                if (voiceChatBtn) voiceChatBtn.classList.remove('active');

                showNotification('Voice chat ended', 'info');
            } catch (error) {
                console.error('Error ending voice chat:', error);
                showNotification('Error ending voice chat', 'error');
            }
        }

        // Survey handling
        let hasSubmittedSurvey = false;
        let selectedRating = null;

        // Update checkSurveyStatus to use the correct endpoint
        function getAuthToken() {
            // Get token from cookies or localStorage
            return localStorage.getItem('authToken') ||
                document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
        }

        function checkSurveyStatus() {
            return new Promise((resolve, reject) => {
                // Remove token checking - just use session cookies
                fetch('/api/check_survey_status', {  // Use the correct API endpoint
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'  // This sends session cookies
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        hasSubmittedSurvey = data.has_submitted;
                        console.log('Survey status checked:', hasSubmittedSurvey);
                        resolve(data);
                    })
                    .catch(error => {
                        console.error('Error checking survey status:', error);
                        // Proceed as if survey hasn't been submitted
                        hasSubmittedSurvey = false;
                        resolve({ has_submitted: false });
                    });
            });
        }

        function showSurvey() {
            console.log('showSurvey called, hasSubmittedSurvey:', hasSubmittedSurvey); // Debug log
            
            // Don't show survey if already submitted
            if (hasSubmittedSurvey) {
                console.log('Survey already submitted, not showing');
                return;
            }

            const surveyModal = document.getElementById('surveyModal');
            if (!surveyModal) {
                console.error('Survey modal not found');
                return;
            }

            // Make sure the modal is visible
            surveyModal.style.display = 'block';

            // Force a reflow
            surveyModal.offsetHeight;

            // Add the show class
            surveyModal.classList.add('show');

            // Log the modal's state
            console.log('Modal display:', surveyModal.style.display);
            console.log('Modal classes:', surveyModal.className);
            console.log('Modal position:', surveyModal.getBoundingClientRect());
        }

        function hideSurvey() {
            console.log('Hiding survey...'); // Debug log
            const surveyModal = document.getElementById('surveyModal');
            if (!surveyModal) {
                console.error('Survey modal not found');
                return;
            }
            surveyModal.classList.remove('show');
            setTimeout(() => {
                surveyModal.style.display = 'none';
            }, 300);
        }

        // Update the rating button click handler and submission logic
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize survey elements
            const surveyModal = document.getElementById('surveyModal');
            const closeSurveyBtn = document.getElementById('closeSurveyBtn');
            const ratingButtons = document.querySelectorAll('.rating-btn');
            const emojiDisplay = document.querySelector('.emoji-display i');
            const ratingMessage = document.querySelector('.rating-message');
            const surveyMessage = document.getElementById('surveyMessage');
            const submitSurveyBtn = document.getElementById('submitSurvey');

            if (!surveyModal || !closeSurveyBtn || !ratingButtons.length || !emojiDisplay ||
                !ratingMessage || !surveyMessage || !submitSurveyBtn) {
                console.error('Some survey elements are missing');
                return;
            }

            const ratingMessages = {
                1: "We're sorry to hear that. We'll work on improving.",
                2: "Thanks for the feedback. We'll try to do better.",
                3: "Thank you for your feedback.",
                4: "We appreciate your feedback.",
                5: "Thank you for your rating.",
                6: "Glad you had a good experience!",
                7: "Great! We're happy to hear that.",
                8: "Excellent! Thank you for the high rating.",
                9: "Fantastic! We're thrilled with your feedback.",
                10: "Amazing! Thank you for the perfect rating!"
            };

            // Handle rating button clicks
            ratingButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const value = parseInt(this.dataset.value);
                    console.log('Rating clicked:', value);

                    // Remove selected class from all buttons
                    ratingButtons.forEach(btn => btn.classList.remove('selected'));

                    // Add selected class to clicked button
                    this.classList.add('selected');
                    selectedRating = value;

                    // Show rating message
                    ratingMessage.textContent = ratingMessages[value];
                    ratingMessage.classList.add('show');

                    // Update emoji
                    emojiDisplay.className = this.dataset.emoji;
                });
            });

            // Add enter key handler for survey message
            surveyMessage.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitSurveyBtn.click();
                }
            });

            // Add submit button click handler
            submitSurveyBtn.addEventListener('click', async function () {
                if (!selectedRating) {
                    showNotification('Please select a rating', 'error');
                    return;
                }

                const message = surveyMessage.value.trim();

                try {
                    await submitRating(selectedRating, message);
                    document.getElementById('surveyModal').style.display = 'none';
                } catch (error) {
                    document.getElementById('surveyModal').style.display = 'none';
                    console.error('Error submitting rating:', error);
                    showNotification('Failed to submit rating. Please try again.', 'error');
                }
            });

            // Close survey modal when clicking outside
            window.addEventListener('click', function (event) {
                if (event.target === surveyModal) {
                    hideSurvey();
                }
            });

            // Close survey with close button
            closeSurveyBtn.addEventListener('click', hideSurvey);
        });
        async function submitRating(rating, message) {
            try {
                const response = await fetch('/api/survey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rating, message }),
                    credentials: 'include'
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Success response:', data);

                if (data.success) {
                    // Success handling
                    const successElement = document.querySelector('.rating-success');
                    if (successElement) {
                        successElement.style.display = 'flex';
                    }

                    showNotification('Thank you for your feedback!', 'success');
                    hasSubmittedSurvey = true;
                    
                    // Hide the survey modal
                    hideSurvey();
                    
                    // Update the survey status to prevent showing again
                    setTimeout(() => {
                        checkSurveyStatus();
                    }, 1000);
                }

                return data;
            } catch (error) {
                console.error('Submission error:', error);

                let errorMessage = 'Failed to submit rating. Please try again.';

                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to server. Please check your connection.';
                } else if (error.message.includes('401')) {
                    errorMessage = 'Please log in to submit feedback.';
                } else if (error.message.includes('400')) {
                    errorMessage = 'Invalid rating. Please select a rating between 1-10.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                showNotification(errorMessage, 'error');
                throw error;
            }
        }


        // Add this to the JavaScript section
        function resetChat() {
            if (confirm('Are you sure you want to reset the chat? This will delete all conversations and start fresh.')) {
                // Delete all conversations from the database
                fetch('/delete_all_conversations', {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to delete conversations');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Clear the chat container
                        clearChatContainer();

                        // Reset the current conversation ID
                        currentConversationId = null;

                        // Clear the message input
                        const messageInput = document.getElementById('messageInput');
                        messageInput.value = '';
                        messageInput.style.height = 'auto';

                        // Remove active class from all conversation items
                        document.querySelectorAll('.history-item').forEach(item => {
                            item.classList.remove('active');
                        });

                        // Stop any ongoing voice input/output
                        stopVoiceInput();
                        stopVoiceOutput();

                        // Reload conversations to show empty state
                        loadConversations();

                        showNotification('All conversations have been deleted', 'success');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Failed to delete conversations', 'error');
                    });
            }
        }

        // Add this function to the JavaScript section
        function downloadChat() {
            if (!currentConversationId) {
                showNotification('No active conversation to download', 'error');
                return;
            }

            fetch(`/download_chat/${currentConversationId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to download chat');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Create a URL for the blob
                    const url = window.URL.createObjectURL(blob);

                    // Create a temporary link element
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat_conversation_${currentConversationId}.docx`;

                    // Append to body, click, and remove
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    // Clean up the URL
                    window.URL.revokeObjectURL(url);

                    showNotification('Chat downloaded successfully', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Failed to download chat', 'error');
                });
        }

        // Add this new function to initialize survey
        function initializeSurvey() {
            console.log('Initializing survey...'); // Debug log

            const surveyModal = document.getElementById('surveyModal');
            const closeSurveyBtn = document.getElementById('closeSurveyBtn');
            const ratingButtons = document.querySelectorAll('.rating-btn');
            const emojiDisplay = document.querySelector('.emoji-display i');
            const ratingMessage = document.querySelector('.rating-message');
            const surveyMessage = document.getElementById('surveyMessage');
            const submitSurveyBtn = document.getElementById('submitSurvey');

            if (!surveyModal || !closeSurveyBtn || !ratingButtons.length || !emojiDisplay ||
                !ratingMessage || !surveyMessage || !submitSurveyBtn) {
                console.error('Some survey elements are missing:', {
                    surveyModal: !!surveyModal,
                    closeSurveyBtn: !!closeSurveyBtn,
                    ratingButtons: ratingButtons.length,
                    emojiDisplay: !!emojiDisplay,
                    ratingMessage: !!ratingMessage,
                    surveyMessage: !!surveyMessage,
                    submitSurveyBtn: !!submitSurveyBtn
                });
                return;
            }

            const ratingMessages = {
                1: "We're sorry to hear that. We'll work on improving.",
                2: "Thanks for the feedback. We'll try to do better.",
                3: "Thank you for your feedback.",
                4: "We appreciate your feedback.",
                5: "Thank you for your rating.",
                6: "Glad you had a good experience!",
                7: "Great! We're happy to hear that.",
                8: "Excellent! Thank you for the high rating.",
                9: "Fantastic! We're thrilled with your feedback.",
                10: "Amazing! Thank you for the perfect rating!"
            };

            // Handle rating button clicks
            ratingButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const value = parseInt(this.dataset.value);
                    console.log('Rating clicked:', value);

                    // Remove selected class from all buttons
                    ratingButtons.forEach(btn => btn.classList.remove('selected'));

                    // Add selected class to clicked button
                    this.classList.add('selected');
                    selectedRating = value;

                    // Show rating message
                    ratingMessage.textContent = ratingMessages[value];
                    ratingMessage.classList.add('show');

                    // Update emoji
                    emojiDisplay.className = this.dataset.emoji;
                });
            });

            // Add enter key handler for survey message
            surveyMessage.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitSurveyBtn.click();
                }
            });

            // Add submit button click handler
            submitSurveyBtn.addEventListener('click', async function () {
                if (!selectedRating) {
                    showNotification('Please select a rating', 'error');
                    return;
                }

                const message = surveyMessage.value.trim();
                try {
                    await submitRating(selectedRating, message);
                } catch (error) {
                    console.error('Error submitting rating:', error);
                    showNotification('Failed to submit rating. Please try again.', 'error');
                }
            });

            // Close survey modal when clicking outside
            window.addEventListener('click', function (event) {
                if (event.target === surveyModal) {
                    hideSurvey();
                }
            });

            // Close survey with close button
            closeSurveyBtn.addEventListener('click', hideSurvey);
        }

        // Add this function to test the survey
        function testSurvey() {
            console.log('Testing survey display...');
            const surveyModal = document.getElementById('surveyModal');
            if (!surveyModal) {
                console.error('Survey modal not found');
                return;
            }

            // Make sure the modal is visible
            surveyModal.style.display = 'block';

            // Force a reflow
            surveyModal.offsetHeight;

            // Add the show class
            surveyModal.classList.add('show');

            // Log the modal's state
            console.log('Modal display:', surveyModal.style.display);
            console.log('Modal classes:', surveyModal.className);
            console.log('Modal position:', surveyModal.getBoundingClientRect());
        }

        // Update the showSurvey function
        function showSurvey() {
            console.log('Showing survey...'); // Debug log

            const surveyModal = document.getElementById('surveyModal');
            if (!surveyModal) {
                console.error('Survey modal not found');
                return;
            }

            // Make sure the modal is visible
            surveyModal.style.display = 'block';

            // Force a reflow
            surveyModal.offsetHeight;

            // Add the show class
            surveyModal.classList.add('show');

            // Log the modal's state
            console.log('Modal display:', surveyModal.style.display);
            console.log('Modal classes:', surveyModal.className);
            console.log('Modal position:', surveyModal.getBoundingClientRect());
        }

        // Update the initialization code
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing components...');

            // Initialize survey
            initializeSurvey();
            
            // Check survey status on load and only show if not submitted
            checkSurveyStatus().then(() => {
                // Only set up the timer if survey hasn't been submitted
                if (!hasSubmittedSurvey) {
                    console.log('Setting up survey timer for 5 minutes...');
                    setTimeout(function () {
                        console.log('5 minutes passed, checking if survey should be shown...');
                        if (!hasSubmittedSurvey) {
                            showSurvey();
                        } else {
                            console.log('Survey already submitted, not showing');
                        }
                    }, 5 * 1000); // 5 minutes in milliseconds
                } else {
                    console.log('Survey already submitted, skipping timer setup');
                }
            });
        }); 

        // Add function to reset survey for testing
        async function resetSurvey() {
            try {
                const response = await fetch('/api/reset_survey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Survey reset response:', data);

                if (data.success) {
                    showNotification('Survey reset successfully', 'success');
                    hasSubmittedSurvey = false;
                    
                    // Update the survey status
                    setTimeout(() => {
                        checkSurveyStatus();
                    }, 1000);
                }

            } catch (error) {
                console.error('Error resetting survey:', error);
                showNotification('Failed to reset survey', 'error');
            }
        }

        // Add event listeners for How it Works modal
        document.addEventListener('DOMContentLoaded', function () {
            const howItWorksBtn = document.getElementById('howItWorksBtn');
            const howItWorksModal = document.getElementById('howItWorksModal');
            const closeHowItWorksModal = document.getElementById('closeHowItWorksModal');
            if (howItWorksBtn && howItWorksModal && closeHowItWorksModal) {
                howItWorksBtn.addEventListener('click', function () {
                    howItWorksModal.style.display = 'block';
                    howItWorksModal.classList.add('show');
                });
                closeHowItWorksModal.addEventListener('click', function () {
                    howItWorksModal.classList.remove('show');
                    setTimeout(() => { howItWorksModal.style.display = 'none'; }, 300);
                });
                window.addEventListener('click', function (event) {
                    if (event.target === howItWorksModal) {
                        howItWorksModal.classList.remove('show');
                        setTimeout(() => { howItWorksModal.style.display = 'none'; }, 300);
                    }
                });
            }
        });

        // Lesson Details Modal logic
        let selectedFile = null;

        function showLessonDetailsModal(file) {
            selectedFile = file;
            document.getElementById('lessonDetailsModal').style.display = 'block';
            document.getElementById('lessonDetailsModal').classList.add('show');
        }
        function hideLessonDetailsModal() {
            document.getElementById('lessonDetailsModal').classList.remove('show');
            setTimeout(() => { document.getElementById('lessonDetailsModal').style.display = 'none'; }, 300);
        }
        document.addEventListener('DOMContentLoaded', function () {
            // ... existing ...
            const closeLessonDetailsModal = document.getElementById('closeLessonDetailsModal');
            if (closeLessonDetailsModal) {
                closeLessonDetailsModal.addEventListener('click', hideLessonDetailsModal);
            }
            window.addEventListener('click', function (event) {
                const modal = document.getElementById('lessonDetailsModal');
                if (event.target === modal) hideLessonDetailsModal();
            });
            // Intercept file input to show lesson details modal
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function (event) {
                    const files = event.target.files;
                    if (files && files.length > 0) {
                        showLessonDetailsModal(files[0]);
                    }
                });
            }
            // Handle lesson details form submit
            const lessonDetailsForm = document.getElementById('lessonDetailsForm');
            if (lessonDetailsForm) {
                lessonDetailsForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    hideLessonDetailsModal();
                    if (!selectedFile) {
                        showErrorMessage('No file selected.');
                        return;
                    }
                    // Gather lesson details
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    const details = {
                        title: document.getElementById('lessonTitle').value,
                        objectives: document.getElementById('lessonObjectives').value,
                        focus_areas: document.getElementById('lessonFocus').value,
                        grade: document.getElementById('lessonGrade').value,
                        notes: document.getElementById('lessonNotes').value
                    };
                    formData.append('lesson_details', JSON.stringify(details));
                    try {
                        showProcessingMessage('Generating lesson...');
                        const response = await fetch('/generate_lesson', {
                            method: 'POST',
                            body: formData
                        });
                        if (!response.ok) {
                            let errorMessage = 'Failed to generate lesson';
                            try {
                                const error = await response.json();
                                errorMessage = error.error || errorMessage;
                            } catch (e) {
                                errorMessage = response.statusText || errorMessage;
                            }
                            showErrorMessage(errorMessage);
                            return;
                        }
                        // Parse lesson JSON from header and show markdown modal
                        const lessonJsonB64 = response.headers.get('X-Lesson-Json');
                        let lessonJson = null;
                        if (lessonJsonB64) {
                            try {
                                lessonJson = JSON.parse(atob(lessonJsonB64));
                            } catch (e) { lessonJson = null; }
                        }
                        let markdown = '';
                        if (lessonJson) {
                            // Convert lesson JSON to markdown (simple fallback)
                            markdown = `# ${lessonJson.title}\n\n${lessonJson.summary}\n\n## Learning Objectives\n${(lessonJson.learning_objectives||[]).map(o=>'- '+o).join('\n')}\n\n## Sections\n${(lessonJson.sections||[]).map(s=>`### ${s.heading}\n${s.content}`).join('\n\n')}\n\n## Key Concepts\n${(lessonJson.key_concepts||[]).map(k=>'- '+k).join('\n')}\n\n## Activities\n${(lessonJson.activities||[]).map(a=>`- ${a.name}: ${a.description} (${a.duration})`).join('\n')}\n\n## Quiz\n${(lessonJson.quiz||[]).map(q=>`- ${q.question}\n  - ${q.options.join(' | ')}\n  - Answer: ${q.answer}\n  - ${q.explanation}`).join('\n\n')}`;
                        }
                        showLessonMarkdownModal(markdown, lessonJson);
                    } catch (error) {
                        showErrorMessage(error.message || 'Failed to generate lesson. Please try again.');
                    } finally {
                        hideSpinner();
                        selectedFile = null;
                    }
                });
            }
        });

        // Lesson Review/Edit Modal logic
        let lastGeneratedLesson = null;
        function showLessonReviewModal(lesson) {
            lastGeneratedLesson = lesson;
            // Populate fields
            document.getElementById('reviewTitle').value = lesson.title || '';
            document.getElementById('reviewSummary').value = lesson.summary || '';
            // Objectives
            const objList = document.getElementById('reviewObjectivesList');
            objList.innerHTML = '';
            (lesson.learning_objectives || []).forEach((obj, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `<input type='text' value="${obj}" data-idx="${idx}" class="form-control objective-input"> <button type='button' class='remove-btn' onclick='removeObjective(${idx})'>Remove</button>`;
                objList.appendChild(li);
            });
            // Sections
            const secList = document.getElementById('reviewSectionsList');
            secList.innerHTML = '';
            (lesson.sections || []).forEach((sec, idx) => {
                const div = document.createElement('div');
                div.className = 'section-edit';
                div.innerHTML = `<input type='text' value="${sec.heading}" data-idx="${idx}" class="form-control section-heading-input" placeholder="Heading">
        <textarea class="form-control section-content-input" data-idx="${idx}" rows="2">${sec.content}</textarea>
        <button type='button' class='remove-btn' onclick='removeSection(${idx})'>Remove</button>`;
        secList.appendChild(div);
    });
    // Key Concepts
    const kcList = document.getElementById('reviewKeyConceptsList');
    kcList.innerHTML = '';
    (lesson.key_concepts || []).forEach((kc, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<input type='text' value="${kc}" data-idx="${idx}" class="form-control keyconcept-input"> <button type='button' class='remove-btn' onclick='removeKeyConcept(${idx})'>Remove</button>`;
        kcList.appendChild(li);
    });
    // Activities
    const actList = document.getElementById('reviewActivitiesList');
    actList.innerHTML = '';
    (lesson.activities || []).forEach((act, idx) => {
        const div = document.createElement('div');
        div.className = 'activity-edit';
        div.innerHTML = `<input type='text' value="${act.name}" data-idx="${idx}" class="form-control activity-name-input" placeholder="Name">
        <textarea class="form-control activity-desc-input" data-idx="${idx}" rows="1" placeholder="Description">${act.description}</textarea>
        <input type='text' value="${act.duration}" data-idx="${idx}" class="form-control activity-duration-input" placeholder="Duration">
        <button type='button' class='remove-btn' onclick='removeActivity(${idx})'>Remove</button>`;
        actList.appendChild(div);
    });
    // Quiz
    const quizList = document.getElementById('reviewQuizList');
    quizList.innerHTML = '';
    (lesson.quiz || []).forEach((q, idx) => {
        const div = document.createElement('div');
        div.className = 'quiz-edit';
        div.innerHTML = `<input type='text' value="${q.question}" data-idx="${idx}" class="form-control quiz-question-input" placeholder="Question">
        <input type='text' value="${(q.options||[])[0]||''}" class="form-control quiz-option-input" data-idx="${idx}" data-opt="0" placeholder="Option A">
        <input type='text' value="${(q.options||[])[1]||''}" class="form-control quiz-option-input" data-idx="${idx}" data-opt="1" placeholder="Option B">
        <input type='text' value="${(q.options||[])[2]||''}" class="form-control quiz-option-input" data-idx="${idx}" data-opt="2" placeholder="Option C">
        <input type='text' value="${(q.options||[])[3]||''}" class="form-control quiz-option-input" data-idx="${idx}" data-opt="3" placeholder="Option D">
        <input type='text' value="${q.answer}" data-idx="${idx}" class="form-control quiz-answer-input" placeholder="Answer (A/B/C/D)">
        <textarea class="form-control quiz-explanation-input" data-idx="${idx}" rows="1" placeholder="Explanation">${q.explanation}</textarea>
        <button type='button' class='remove-btn' onclick='removeQuiz(${idx})'>Remove</button>`;
        quizList.appendChild(div);
    });
    document.getElementById('lessonReviewModal').style.display = 'block';
    document.getElementById('lessonReviewModal').classList.add('show');
}
function hideLessonReviewModal() {
    document.getElementById('lessonReviewModal').classList.remove('show');
    setTimeout(() => { document.getElementById('lessonReviewModal').style.display = 'none'; }, 300);
}
document.addEventListener('DOMContentLoaded', function () {
    const closeLessonReviewModal = document.getElementById('closeLessonReviewModal');
    if (closeLessonReviewModal) {
        closeLessonReviewModal.addEventListener('click', hideLessonReviewModal);
    }
    window.removeObjective = function(idx) {
        lastGeneratedLesson.learning_objectives.splice(idx, 1);
        showLessonReviewModal(lastGeneratedLesson);
    };
    window.removeSection = function(idx) {
        lastGeneratedLesson.sections.splice(idx, 1);
        showLessonReviewModal(lastGeneratedLesson);
    };
    window.removeKeyConcept = function(idx) {
        lastGeneratedLesson.key_concepts.splice(idx, 1);
        showLessonReviewModal(lastGeneratedLesson);
    };
    window.removeActivity = function(idx) {
        lastGeneratedLesson.activities.splice(idx, 1);
        showLessonReviewModal(lastGeneratedLesson);
    };
    window.removeQuiz = function(idx) {
        lastGeneratedLesson.quiz.splice(idx, 1);
        showLessonReviewModal(lastGeneratedLesson);
    };
    document.getElementById('addObjectiveBtn').onclick = function() {
        lastGeneratedLesson.learning_objectives.push('');
        showLessonReviewModal(lastGeneratedLesson);
    };
    document.getElementById('addSectionBtn').onclick = function() {
        lastGeneratedLesson.sections.push({heading:'',content:''});
        showLessonReviewModal(lastGeneratedLesson);
    };
    document.getElementById('addKeyConceptBtn').onclick = function() {
        lastGeneratedLesson.key_concepts.push('');
        showLessonReviewModal(lastGeneratedLesson);
    };
    document.getElementById('addActivityBtn').onclick = function() {
        lastGeneratedLesson.activities.push({name:'',description:'',duration:''});
        showLessonReviewModal(lastGeneratedLesson);
    };
    document.getElementById('addQuizBtn').onclick = function() {
        lastGeneratedLesson.quiz.push({question:'',options:['','','',''],answer:'',explanation:''});
        showLessonReviewModal(lastGeneratedLesson);
    };
    // Save edits and download
    document.getElementById('lessonReviewForm').onsubmit = async function(e) {
        e.preventDefault();
        // Gather edits
        lastGeneratedLesson.title = document.getElementById('reviewTitle').value;
        lastGeneratedLesson.summary = document.getElementById('reviewSummary').value;
        // Objectives
        lastGeneratedLesson.learning_objectives = Array.from(document.querySelectorAll('.objective-input')).map(i=>i.value);
        // Sections
        lastGeneratedLesson.sections = Array.from(document.querySelectorAll('.section-edit')).map(div=>({
            heading: div.querySelector('.section-heading-input').value,
            content: div.querySelector('.section-content-input').value
        }));
        // Key Concepts
        lastGeneratedLesson.key_concepts = Array.from(document.querySelectorAll('.keyconcept-input')).map(i=>i.value);
        // Activities
        lastGeneratedLesson.activities = Array.from(document.querySelectorAll('.activity-edit')).map(div=>({
            name: div.querySelector('.activity-name-input').value,
            description: div.querySelector('.activity-desc-input').value,
            duration: div.querySelector('.activity-duration-input').value
        }));
        // Quiz
        lastGeneratedLesson.quiz = Array.from(document.querySelectorAll('.quiz-edit')).map(div=>({
            question: div.querySelector('.quiz-question-input').value,
            options: [0,1,2,3].map(i=>div.querySelector(`.quiz-option-input[data-opt="${i}"]`).value),
            answer: div.querySelector('.quiz-answer-input').value,
            explanation: div.querySelector('.quiz-explanation-input').value
        }));
        // Send to backend for DOCX download
        try {
            showProcessingMessage('Downloading edited lesson...');
            const response = await fetch('/download_edited_lesson', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lesson: lastGeneratedLesson})
            });
            if (!response.ok) {
                showErrorMessage('Failed to download edited lesson.');
                return;
            }
            const contentDisposition = response.headers.get('Content-Disposition');
            const filenameMatch = contentDisposition ? contentDisposition.match(/filename="(.+)"/) : null;
            const filename = filenameMatch ? filenameMatch[1] : `lesson_edited.docx`;
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showSuccessMessage('Edited lesson downloaded successfully!');
            hideLessonReviewModal();
        } catch (error) {
            showErrorMessage('Failed to download edited lesson.');
        } finally {
            hideSpinner();
        }
    };
});

// Markdown Editor Modal logic
let currentLessonMarkdown = '';
let currentLessonJson = null;
function showLessonMarkdownModal(lessonMarkdown, lessonJson) {
    currentLessonMarkdown = lessonMarkdown;
    currentLessonJson = lessonJson;
    document.getElementById('lessonMarkdownEditor').value = lessonMarkdown;
    document.getElementById('lessonEditError').textContent = '';
    document.getElementById('lessonEditSpinner').style.display = 'none';
    document.getElementById('lessonMarkdownModal').style.display = 'block';
    document.getElementById('lessonMarkdownModal').classList.add('show');
    // Setup AI Edit Prompt workflow every time modal is shown
    const showPromptBtn = document.getElementById('showPromptBtn');
    const promptInputRow = document.getElementById('promptInputRow');
    const lessonEditPrompt = document.getElementById('lessonEditPrompt');
    const sendEditPromptBtn = document.getElementById('sendEditPromptBtn');
    if (!showPromptBtn || !promptInputRow || !lessonEditPrompt || !sendEditPromptBtn) {
        console.error('AI Edit Prompt elements missing:', {showPromptBtn, promptInputRow, lessonEditPrompt, sendEditPromptBtn});
        return;
    }
    function showPromptInput() {
        console.log('showPromptInput called');
        showPromptBtn.style.display = 'none';
        promptInputRow.style.display = 'flex';
        lessonEditPrompt.value = '';
        lessonEditPrompt.focus();
    }
    function hidePromptInput() {
        console.log('hidePromptInput called');
        promptInputRow.style.display = 'none';
        showPromptBtn.style.display = 'flex';
    }
    showPromptBtn.onclick = showPromptInput;
    async function sendEditPrompt() {
        const prompt = lessonEditPrompt.value.trim();
        if (!prompt) return;
        document.getElementById('lessonEditSpinner').style.display = 'block';
        document.getElementById('lessonEditError').textContent = '';
        try {
            const response = await fetch('/edit_lesson_with_prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lesson_text: document.getElementById('lessonMarkdownEditor').value, user_prompt: prompt})
            });
            if (!response.ok) {
                document.getElementById('lessonEditError').textContent = 'Failed to edit lesson.';
                return;
            }
            const data = await response.json();
            if (data.lesson_markdown) {
                document.getElementById('lessonMarkdownEditor').value = data.lesson_markdown;
                currentLessonMarkdown = data.lesson_markdown;
                lessonEditPrompt.value = '';
                hidePromptInput();
            } else {
                document.getElementById('lessonEditError').textContent = 'No lesson returned.';
            }
        } catch (e) {
            document.getElementById('lessonEditError').textContent = 'Error editing lesson.';
        } finally {
            document.getElementById('lessonEditSpinner').style.display = 'none';
        }
    }
    sendEditPromptBtn.onclick = sendEditPrompt;
    lessonEditPrompt.onkeydown = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendEditPrompt();
        }
    };
    // Always reset to initial state
    hidePromptInput();
    console.log('AI Edit Prompt handlers attached');
}
function hideLessonMarkdownModal() {
    document.getElementById('lessonMarkdownModal').classList.remove('show');
    setTimeout(() => { document.getElementById('lessonMarkdownModal').style.display = 'none'; }, 300);
}
function showDownloadModal() {
    document.getElementById('downloadModal').style.display = 'block';
    document.getElementById('downloadModal').classList.add('show');
}
function hideDownloadModal() {
    document.getElementById('downloadModal').classList.remove('show');
    setTimeout(() => { document.getElementById('downloadModal').style.display = 'none'; }, 300);
}
document.addEventListener('DOMContentLoaded', function () {
    // Close modals
    document.getElementById('closeLessonMarkdownModal').onclick = hideLessonMarkdownModal;
    document.getElementById('closeDownloadModal').onclick = hideDownloadModal;
    window.addEventListener('click', function (event) {
        if (event.target === document.getElementById('lessonMarkdownModal')) hideLessonMarkdownModal();
        if (event.target === document.getElementById('downloadModal')) hideDownloadModal();
    });
    // Send edit prompt
    document.getElementById('sendEditPromptBtn').onclick = async function() {
        const prompt = document.getElementById('lessonEditPrompt').value.trim();
        if (!prompt) return;
        document.getElementById('lessonEditSpinner').style.display = 'block';
        document.getElementById('lessonEditError').textContent = '';
        try {
            const response = await fetch('/edit_lesson_with_prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lesson_text: document.getElementById('lessonMarkdownEditor').value, user_prompt: prompt})
            });
            if (!response.ok) {
                document.getElementById('lessonEditError').textContent = 'Failed to edit lesson.';
                return;
            }
            const data = await response.json();
            if (data.lesson_markdown) {
                document.getElementById('lessonMarkdownEditor').value = data.lesson_markdown;
                currentLessonMarkdown = data.lesson_markdown;
            } else {
                document.getElementById('lessonEditError').textContent = 'No lesson returned.';
            }
        } catch (e) {
            document.getElementById('lessonEditError').textContent = 'Error editing lesson.';
        } finally {
            document.getElementById('lessonEditSpinner').style.display = 'none';
        }
    };
    // Download button
    document.getElementById('downloadLessonBtn').onclick = showDownloadModal;
    // Download as DOCX
    document.getElementById('downloadAsDocxBtn').onclick = async function() {
        hideDownloadModal();
        try {
            showProcessingMessage('Downloading as DOCX...');
            const response = await fetch('/download_edited_lesson', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lesson_markdown: document.getElementById('lessonMarkdownEditor').value})
            });
            if (!response.ok) {
                showErrorMessage('Failed to download as DOCX.');
                return;
            }
            const contentDisposition = response.headers.get('Content-Disposition');
            const filenameMatch = contentDisposition ? contentDisposition.match(/filename="(.+)"/) : null;
            const filename = filenameMatch ? filenameMatch[1] : `lesson.docx`;
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showSuccessMessage('Lesson downloaded as DOCX!');
        } catch (e) {
            showErrorMessage('Failed to download as DOCX.');
        } finally {
            hideSpinner();
        }
    };
    // Download as PPT
    document.getElementById('downloadAsPptBtn').onclick = async function() {
        hideDownloadModal();
        try {
            showProcessingMessage('Downloading as PPT...');
            // Always send a valid lesson JSON structure
            let lesson = currentLessonJson;
            if (!lesson) {
                // Parse markdown into a basic lesson structure
                const md = document.getElementById('lessonMarkdownEditor').value;
                lesson = {
                    title: 'Lesson',
                    summary: '',
                    learning_objectives: [],
                    sections: [{heading: 'Lesson', content: md}],
                    key_concepts: [],
                    activities: [],
                    quiz: []
                };
            }
            const response = await fetch('/download_lesson_ppt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lesson})
            });
            if (!response.ok) {
                showErrorMessage('Failed to download as PPT.');
                return;
            }
            const contentDisposition = response.headers.get('Content-Disposition');
            const filenameMatch = contentDisposition ? contentDisposition.match(/filename="(.+)"/) : null;
            const filename = filenameMatch ? filenameMatch[1] : `lesson.pptx`;
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showSuccessMessage('Lesson downloaded as PPT!');
        } catch (e) {
            showErrorMessage('Failed to download as PPT.');
        } finally {
            hideSpinner();
        }
    };
});
    </script>
</body>

</html>