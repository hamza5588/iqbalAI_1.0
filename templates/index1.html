<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            myblue: '#05B0FC',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts & Font Awesome -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <title>AI Chat Interface</title>
</head>
<body class="h-screen bg-gray-100 font-inter">
  <div class="flex h-full">

    <!-- Sidebar -->
    <div id="sidebar" class="w-[275px] md:w-[275px] bg-white shadow-md p-4 fixed md:static top-0 left-0 h-full md:h-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40">
      <div class="flex justify-between items-center">
        <img src="/logo.png" height="80" width="140" alt="Logo">
        <button onclick="hideSidebar()" class="mt-4 hover:bg-gray-100 p-1 rounded">
          <img src="/slider.png" alt="Toggle" class="w-6 h-6">
        </button>
      </div>
      
      <!-- Border Line -->
      <div class="mt-4 border-t-2 border-gray-300 -mx-4"></div>
      
      <div class="flex flex-col space-y-4 justify-center items-center mt-6 mb-2">

        <!-- New Chat -->
        <button onclick="startNewChat()" class="w-[200px] h-[50px] mt-3 mb-2 px-4 flex items-center justify-center gap-2 bg-[#05B0FC] text-white font-bold rounded transition duration-200 ease-in-out hover:bg-blue-600">
          <img src="/msg.png" alt="Message" class="w-5 h-5">
          <span>New Chat</span>
        </button>

        <!-- Action Buttons -->
        <button onclick="openLessonGenerator()" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
          <img src="/lesson.png" alt="Lesson" class="w-5 h-5">
          <span>Generate Lessons</span>
        </button>

        <button onclick="updateApiKey()" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
         <img src="/key.png" alt="Key" class="w-5 h-5">
          <span>Update API Key</span>
        </button>

        <button onclick="startRealTimeChat()" id="realTimeChatBtn" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
         <img src="/timer.png" alt="Timer" class="w-5 h-5">
          <span>Real Time Chat</span>
        </button>

        <button onclick="resetChat()" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
          <i class="fas fa-refresh text-[#B7B7B7] w-5 h-5"></i>
          <span>Reset Chat</span>
        </button>

        <!-- Chat History Button -->
        <button onclick="toggleDropdown()" class="w-[260px] h-[40px] px-4 flex items-center justify-between font-semibold text-[16px] text-gray-700 mt-2 hover:bg-gray-50 rounded transition-colors">
          <i class="fas fa-history text-[#B7B7B7]"></i>
          <span>Chat History</span>
          <i class="fas fa-chevron-down text-[#666]" id="historyArrow"></i>
        </button>

        <!-- Dropdown Chat History -->
        <div id="dropdownContent" class="mt-2 hidden flex-col gap-3 w-[240px] max-h-48 overflow-y-auto">
          <!-- Chat history items will be populated here -->
        </div>

        <!-- Logout Button -->
        <button onclick="logout()" class="fixed bottom-4 w-[230px] h-[40px] px-4 flex items-center justify-center gap-3 font-semibold text-[16px] text-gray-700 bg-white shadow rounded hover:bg-gray-50 transition-colors">
          <i class="fas fa-sign-out-alt text-[#F50D0D]"></i>
          <span class="text-[#F50D0D]">Log out</span>
        </button>

      </div>
    </div>
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <div class="flex-1 bg-white min-h-screen flex flex-col md:ml-0">
        
        <!-- Search Section -->
        <div class="px-6 py-4">
            <div class="relative flex gap-2">
                <button id="mobileMenuBtn" class="md:hidden w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                  <img src="/slider.png" alt="Menu" class="w-6 h-6">
                </button>
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input
                        type="text"
                        placeholder="Search Conversations and Knowledge base..."
                        class="w-full pl-12 pr-4 py-3 border-0 rounded-xl bg-gray-100 focus:outline-none text-gray-600 placeholder-gray-500"
                        onkeypress="handleSearchKeyPress(event)"
                    />
                </div>
                <button class="w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i class="fas fa-bell text-gray-500"></i>
                </button>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="flex items-center justify-between px-6 py-4">
            <div class="bg-gray-100 rounded-2xl p-1 flex">
                <button
                    onclick="changeTab(this)"
                    class="tab-btn px-8 py-3 text-blue-500 font-semibold bg-white rounded-xl shadow-sm"
                >
                    Chat
                </button>
                <button
                    onclick="changeTab(this)"
                    class="tab-btn px-8 py-3 text-gray-500 font-semibold hover:text-gray-700"
                >
                    Knowledge Base
                </button>
            </div>
            <div class="w-11 h-11 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                AI
            </div>
        </div>

        <!-- Chat Header Section -->
        <div class="flex items-center justify-between px-6 py-4 border-t border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                    AI
                </div>
                <div>
                    <h3 class="text-gray-900 font-semibold text-lg" id="chatTitle">New Chat</h3>
                    <p class="text-gray-500 text-sm" id="chatStatus">Online</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="downloadCurrentChat()" class="w-10 h-10 border border-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors">
                    <i class="fas fa-download text-gray-500 text-sm"></i>
                </button>
                <button class="w-10 h-10 border border-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors">
                    <i class="fas fa-ellipsis-h text-gray-500 text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="flex-1 px-6 py-8 overflow-y-auto" id="chatMessages">
            <div class="flex items-start gap-4">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                    AI
                </div>
                <div class="bg-gray-100 rounded-2xl px-5 py-4 max-w-lg">
                    <p class="text-gray-700 leading-relaxed">
                        Hello! I'm your AI assistant. How can I help you today?
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Voice Recording Indicator -->
        <div id="voiceRecordingIndicator" class="hidden px-6 py-2 bg-red-50 border-l-4 border-red-500">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-red-700 font-medium">Recording... Click to stop</span>
                <button onclick="stopRecording()" class="ml-auto text-red-700 hover:text-red-900">
                    <i class="fas fa-stop-circle text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Input Area -->
        <div class="px-6 py-4 border-t border-gray-100">
            <div class="flex items-center gap-3">
                <button onclick="toggleVoiceRecording()" id="micButton" class="w-12 h-12 border border-gray-200 rounded-xl flex items-center justify-center hover:bg-gray-50 transition-colors">
                  <img src="/recorder.png" alt="">
                </button>
                <button onclick="toggleVoiceOutput()" id="voiceOutputBtn" class="w-12 h-12 border border-gray-200 rounded-xl flex items-center justify-center hover:bg-gray-50 transition-colors">
                      <img src="/voice.png" alt="">
                </button>
                
                <div class="flex-1 relative">
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Type your message"
                        class="w-full px-6 py-4 bg-gray-100 rounded-full border-0 focus:outline-none text-gray-700 placeholder-gray-500"
                        onkeypress="handleKeyPress(event)"
                    />
                    <button class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i class="far fa-smile text-xl"></i>
                    </button>
                </div>
                
                <button onclick="sendMessage()" class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center hover:bg-blue-600 transition-colors">
                    <img src="/sender.png" alt="">
                </button>
            </div>
        </div>
    </div>

  </div>

  <!-- File Upload Modal for Lesson Generator -->
  <div id="fileUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-96 max-w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Upload File for Lesson Generation</h3>
        <button onclick="closeFileUploadModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
        <p class="text-gray-600 mb-4">Drag and drop your file here, or click to browse</p>
        <input type="file" id="lessonFileInput" class="hidden" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx" onchange="handleFileSelect(event)">
        <button onclick="document.getElementById('lessonFileInput').click()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          Choose File
        </button>
      </div>
      
      <div id="selectedFileName" class="hidden mt-4 p-3 bg-gray-100 rounded-lg">
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-700"></span>
          <button onclick="removeSelectedFile()" class="text-red-500 hover:text-red-700">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button onclick="closeFileUploadModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
          Cancel
        </button>
        <button onclick="generateLesson()" id="generateLessonBtn" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50" disabled>
          Generate Lesson
        </button>
      </div>
    </div>
  </div>

  <!-- API Key Update Modal -->
  <div id="apiKeyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-96 max-w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-blue-500 text-center ">Update API Key</h3>
        <button onclick="closeApiKeyModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <ul class="text-gray-500 space-y-3">
          <li class="text-bold text-blue-500 text-xl">How to get your GROQ API Key:</li>
          <li>1. Visit <span class="text-red-500">Groq Console</span></li>
          <li>2. Sign up or log in to your account</li>
          <li>3. Go to the API Keys section</li>
            <li>
          4.Click "Create API Key"
        </li>
           <li>5.Copy your API key and paste it below
 Your API key should start with "gsk_"</li>
        </ul>
      
      <div class="mb-4">
        <div class="relative">
          
          <input type="password" id="apiKeyInput" placeholder="Enter your GROQ API key..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
          <button onclick="toggleApiKeyVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
            <i class="fas fa-eye" id="toggleApiKeyIcon"></i>
          </button>
        </div>
        </div>
      
      <div class="flex gap-3">
        <button onclick="closeApiKeyModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
          Cancel
        </button>
        <button onclick="saveApiKey()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- Real-time Voice Chat Modal -->
  <div id="voiceChatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-80 max-w-full mx-4">
      <div class="text-center">
        <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center animate-pulse">
          <i class="fas fa-microphone text-white text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Real-time Voice Chat</h3>
        <p class="text-gray-600 mb-4" id="voiceChatStatus">Connecting...</p>
        <div id="voiceChatTimer" class="text-2xl font-mono text-gray-800 mb-4">00:00</div>
        <button onclick="endVoiceChat()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
          End Call
        </button>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    // Global variables
    let chatHistory = [];
    let currentChatId = null;
    let isRecording = false;
    let isVoiceOutputEnabled = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let recognition = null;
    let synthesis = null;
    let voiceChatConnection = null;
    let voiceChatTimer = null;
    let voiceChatSeconds = 0;
    let isCollapsed = false;

    // Initialize
    window.onload = function() {
      loadChatHistory();
      startNewChat();
      updateTokenMeter();
      checkApiKeyStatus();
      setupSidebarListeners();
      
      // Initialize mobile state
      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
      }
    };

    // Sidebar setup
    function setupSidebarListeners() {
      const overlay = document.getElementById('overlay');
      
      if (overlay) {
        overlay.addEventListener('click', hideSidebar);
      }
      
      window.addEventListener('resize', handleResize);
    }

    function handleResize() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      
      if (window.innerWidth >= 768) {
        // Desktop: show sidebar
        sidebar.classList.remove('-translate-x-full');
        if (overlay) overlay.classList.add('hidden');
        
        // If sidebar was collapsed, restore it
        if (isCollapsed) {
          restoreFullSidebar();
        }
      } else {
        // Mobile: hide sidebar by default
        sidebar.classList.add('-translate-x-full');
        if (overlay) overlay.classList.add('hidden');
        isCollapsed = false;
      }
    }

    function hideSidebar() {
      const sidebar = document.getElementById('sidebar');
      
      if (window.innerWidth < 768) {
        // Mobile: slide out
        sidebar.classList.add('-translate-x-full');
        const overlay = document.getElementById('overlay');
        if (overlay) overlay.classList.add('hidden');
      } else {
        // Desktop: collapse to icon bar
        const mainContent = document.querySelector('.flex-1');
        
        sidebar.innerHTML = `
          <div class="flex flex-col h-full justify-between items-center py-4">
            <button onclick="showSidebar()" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center justify-center transition-colors">
              <img src="/slider.png" alt="Toggle" class="w-6 h-6">
            </button>
            <button onclick="logout()" class="w-10 h-10 bg-white shadow hover:bg-gray-50 text-red-600 rounded-lg flex items-center justify-center transition-colors">
              <i class="fas fa-sign-out-alt text-[#F50D0D]"></i>
            </button>
          </div>
        `;
        sidebar.className = "w-16 bg-white shadow-md";
        if (mainContent) mainContent.style.marginLeft = "8px";
        isCollapsed = true;
      }
    }

    function showSidebar() {
      if (window.innerWidth < 768) {
        // Mobile: slide in
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('-translate-x-full');
        const overlay = document.getElementById('overlay');
        if (overlay) overlay.classList.remove('hidden');
      } else {
        // Desktop: restore full sidebar
        restoreFullSidebar();
      }
    }

    function restoreFullSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.querySelector('.flex-1');
      
      sidebar.innerHTML = `
        <div class="flex justify-between items-center">
          <img src="/logo.png" height="80" width="140" alt="Logo">
          <button onclick="hideSidebar()" class="mt-4 hover:bg-gray-100 p-1 rounded md:hidden">
            <img src="/slider.png" alt="Toggle" class="w-6 h-6">
          </button>
        </div>
        
        <div class="mt-4 border-t-2 border-gray-300 -mx-4"></div>
        
        <div class="flex flex-col space-y-4 justify-center items-center mt-6 mb-2">
          <button onclick="startNewChat()" class="w-[200px] h-[50px] mt-3 mb-2 px-4 flex items-center justify-center gap-2 bg-[#05B0FC] text-white font-bold rounded transition duration-200 ease-in-out hover:bg-blue-600">
            <img src="/msg.png" alt="Message" class="w-5 h-5">
            <span>New Chat</span>
          </button>
          <button onclick="openLessonGenerator()" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
            <img src="/lesson.png" alt="Lesson" class="w-5 h-5">
            <span>Generate Lessons</span>
          </button>
          <button onclick="updateApiKey()" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
           <img src="/key.png" alt="Key" class="w-5 h-5">
            <span>Update API Key</span>
          </button>
          <button onclick="startRealTimeChat()" id="realTimeChatBtn" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
           <img src="/timer.png" alt="Timer" class="w-5 h-5">
            <span>Real Time Chat</span>
          </button>
          <button onclick="resetChat()" class="w-[230px] h-[40px] px-4 flex items-center gap-3 font-semibold text-[16px] text-gray-700 hover:bg-gray-50 rounded transition-colors">
            <i class="fas fa-refresh text-[#B7B7B7] w-5 h-5"></i>
            <span>Reset Chat</span>
          </button>
          <button onclick="toggleDropdown()" class="w-[260px] h-[40px] px-4 flex items-center justify-between font-semibold text-[16px] text-gray-700 mt-2 hover:bg-gray-50 rounded transition-colors">
            <i class="fas fa-history text-[#B7B7B7]"></i>
            <span>Chat History</span>
            <i class="fas fa-chevron-down text-[#666]" id="historyArrow"></i>
          </button>
          <div id="dropdownContent" class="mt-2 hidden flex-col gap-3 w-[240px] max-h-48 overflow-y-auto">
          </div>
          <button onclick="logout()" class="fixed bottom-4 w-[230px] h-[40px] px-4 flex items-center justify-center gap-3 font-semibold text-[16px] text-gray-700 bg-white shadow rounded hover:bg-gray-50 transition-colors">
            <i class="fas fa-sign-out-alt text-[#F50D0D]"></i>
            <span class="text-[#F50D0D]">Log out</span>
          </button>
        </div>
      `;
      
      sidebar.className = "w-[275px] md:w-[275px] bg-white shadow-md p-4 fixed md:static top-0 left-0 h-full md:h-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40";
      
      if (mainContent) mainContent.style.marginLeft = "0";
      updateChatHistoryDisplay();
      isCollapsed = false;
    }

    // API Integration Functions
    async function startNewChat() {
      try {
        const response = await fetch('/create_conversation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title: 'New Chat' })
        });
        
        if (response.ok) {
          const data = await response.json();
          currentChatId = data.conversation_id;
        } else {
          currentChatId = Date.now();
        }
      } catch (error) {
        console.error('Error creating conversation:', error);
        currentChatId = Date.now();
      }

      document.getElementById('chatTitle').textContent = 'New Chat';
      document.getElementById('chatStatus').textContent = 'Online';
      
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = `
        <div class="flex items-start gap-4">
          <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
            AI
          </div>
          <div class="bg-gray-100 rounded-2xl px-5 py-4 max-w-lg">
            <p class="text-gray-700 leading-relaxed">
              Hello! I'm your AI assistant. How can I help you today?
            </p>
          </div>
        </div>
      `;
      
      document.getElementById('messageInput').value = '';
      loadChatHistory();
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (message) {
        addMessageToChat('user', message);
        input.value = '';
        
        showTypingIndicator();
        
        try {
          const response = await fetch('/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              input: message,
              conversation_id: currentChatId
            })
          });

          hideTypingIndicator();
          
          if (response.ok) {
            const data = await response.json();
            if (data.error) {
              addMessageToChat('ai', `Error: ${data.error}`);
            } else {
              addMessageToChat('ai', data.response);
              
              if (isVoiceOutputEnabled) {
                speakText(data.response);
              }
            }
          } else {
            const errorData = await response.json();
            addMessageToChat('ai', `Error: ${errorData.error || 'Failed to get response'}`);
          }
          
          updateTokenMeter();
          
        } catch (error) {
          hideTypingIndicator();
          console.error('Error sending message:', error);
          addMessageToChat('ai', 'Sorry, there was an error processing your message. Please try again.');
        }
        
        saveChatToHistory();
      }
    }

    async function loadChatHistory() {
      try {
        const response = await fetch('/get_conversations');
        if (response.ok) {
          const conversations = await response.json();
          chatHistory = conversations.map(conv => ({
            id: conv.id,
            title: conv.title || 'New Chat',
            timestamp: conv.created_at || new Date().toISOString(),
            messageCount: conv.message_count || 0
          }));
        } else {
          chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        }
      } catch (error) {
        console.error('Error loading chat history:', error);
        chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      }
      
      updateChatHistoryDisplay();
    }

    async function loadChat(chatId) {
      try {
        const response = await fetch(`/get_messages/${chatId}`);
        if (response.ok) {
          const messages = await response.json();
          
          currentChatId = chatId;
          const chat = chatHistory.find(c => c.id === chatId);
          if (chat) {
            document.getElementById('chatTitle').textContent = chat.title;
          }
          
          const chatMessages = document.getElementById('chatMessages');
          chatMessages.innerHTML = '';
          
          messages.forEach(message => {
            addMessageToChat(message.role === 'user' ? 'user' : 'ai', message.message);
          });
          
        } else {
          console.error('Failed to load messages');
        }
      } catch (error) {
        console.error('Error loading chat:', error);
      }
    }

    async function resetChat() {
      if (confirm('Are you sure you want to reset all chats? This will delete all conversations.')) {
        try {
          const response = await fetch('/delete_all_conversations', {
            method: 'DELETE'
          });
          
          if (response.ok) {
            chatHistory = [];
            updateChatHistoryDisplay();
            startNewChat();
            showNotification('All conversations have been deleted', 'success');
          } else {
            showNotification('Failed to delete conversations', 'error');
          }
        } catch (error) {
          console.error('Error resetting chat:', error);
          showNotification('Error deleting conversations', 'error');
        }
      }
    }

    async function downloadCurrentChat() {
      if (!currentChatId) {
        showNotification('No active conversation to download', 'error');
        return;
      }

      try {
        const response = await fetch(`/download_chat/${currentChatId}`);
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `chat_conversation_${currentChatId}.docx`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
          showNotification('Chat downloaded successfully', 'success');
        } else {
          showNotification('Failed to download chat', 'error');
        }
      } catch (error) {
        console.error('Error downloading chat:', error);
        showNotification('Error downloading chat', 'error');
      }
    }

    async function saveApiKey() {
      const apiKeyInput = document.getElementById('apiKeyInput');
      const newApiKey = apiKeyInput.value.trim();

      if (!newApiKey) {
        showNotification('Please enter an API key', 'error');
        return;
      }

      try {
        const response = await fetch('/update_api_key', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ api_key: newApiKey })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            showNotification('API key updated successfully', 'success');
            closeApiKeyModal();
            apiKeyInput.value = '';
          } else {
            showNotification(data.error || 'Failed to update API key', 'error');
          }
        } else {
          const errorData = await response.json();
          showNotification(errorData.error || 'Failed to update API key', 'error');
        }
      } catch (error) {
        console.error('Error updating API key:', error);
        showNotification('Error updating API key', 'error');
      }
    }

    async function checkApiKeyStatus() {
      try {
        const response = await fetch('/check_api_key_status');
        if (response.ok) {
          const data = await response.json();
          if (!data.has_api_key || data.is_expired) {
            setTimeout(() => {
              updateApiKey();
              const modal = document.getElementById('apiKeyModal');
              modal.classList.add('animate-pulse');
            }, 2000);
          }
        }
      } catch (error) {
        console.error('Error checking API key status:', error);
      }
    }

    async function generateLesson() {
      const fileInput = document.getElementById('lessonFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        showNotification('Please select a file', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      closeFileUploadModal();
      addMessageToChat('user', `Generate a lesson from: ${file.name}`);
      showTypingIndicator();

      try {
        const response = await fetch('/generate_lesson', {
          method: 'POST',
          body: formData
        });

        hideTypingIndicator();

        if (response.ok) {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document')) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lesson_${file.name.split('.')[0]}.docx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
            addMessageToChat('ai', `I've successfully generated a lesson from "${file.name}" and downloaded it as a Word document. The lesson includes structured content, learning objectives, and assessment questions based on your uploaded material.`);
          } else {
            const data = await response.json();
            if (data.error) {
              addMessageToChat('ai', `Error generating lesson: ${data.error}`);
            } else {
              addMessageToChat('ai', data.message || 'Lesson generated successfully');
            }
          }
        } else {
          const errorData = await response.json();
          addMessageToChat('ai', `Error generating lesson: ${errorData.error || 'Failed to generate lesson'}`);
        }
      } catch (error) {
        hideTypingIndicator();
        console.error('Error generating lesson:', error);
        addMessageToChat('ai', 'Sorry, there was an error generating the lesson. Please try again.');
      }

      saveChatToHistory();
    }

    async function updateTokenMeter() {
      try {
        const response = await fetch('/token_status');
        if (response.ok) {
          const data = await response.json();
          
          if (!data.error) {
            const percentUsed = Math.min(100, (data.used / data.limit) * 100);
            
            const progressBar = document.getElementById('tokenProgressBar');
            if (progressBar) {
              progressBar.style.width = `${percentUsed}%`;
              
              if (percentUsed > 90) {
                progressBar.className = 'h-full bg-gradient-to-r from-red-400 to-red-600 rounded-full transition-all duration-300';
              } else if (percentUsed > 75) {
                progressBar.className = 'h-full bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all duration-300';
              } else {
                progressBar.className = 'h-full bg-gradient-to-r from-green-400 to-blue-500 rounded-full transition-all duration-300';
              }
              
              const tokenUsed = document.getElementById('tokenUsed');
              const tokenLimit = document.getElementById('tokenLimit');
              if (tokenUsed) tokenUsed.textContent = data.used.toLocaleString();
              if (tokenLimit) tokenLimit.textContent = data.limit.toLocaleString();
            }
          }
        }
      } catch (error) {
        console.error('Error updating token meter:', error);
      }
    }

    // Real-time Voice Chat
    async function startRealTimeChat() {
      const btn = document.getElementById('realTimeChatBtn');
      
      if (voiceChatConnection) {
        endVoiceChat();
        return;
      }

      try {
        const sessionResponse = await fetch('/session');
        if (!sessionResponse.ok) {
          throw new Error('Failed to get session token');
        }

        const sessionData = await sessionResponse.json();
        const ephemeralKey = sessionData.client_secret.value;

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        document.getElementById('voiceChatModal').classList.remove('hidden');
        document.getElementById('voiceChatStatus').textContent = 'Connecting...';
        
        const peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        stream.getTracks().forEach(track => {
          peerConnection.addTrack(track, stream);
        });

        const audioElement = document.createElement('audio');
        audioElement.autoplay = true;
        peerConnection.ontrack = event => {
          audioElement.srcObject = event.streams[0];
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        const response = await fetch('https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17', {
          method: 'POST',
          body: offer.sdp,
          headers: {
            'Authorization': `Bearer ${ephemeralKey}`,
            'Content-Type': 'application/sdp'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to establish voice connection');
        }

        const answer = {
          type: 'answer',
          sdp: await response.text()
        };
        await peerConnection.setRemoteDescription(answer);

        voiceChatConnection = peerConnection;
        document.getElementById('voiceChatStatus').textContent = 'Connected';
        
        startVoiceChatTimer();
        
        btn.innerHTML = `
          <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
          <span>End Voice Chat</span>
        `;
        btn.classList.add('bg-red-50', 'text-red-700');

      } catch (error) {
        console.error('Voice chat error:', error);
        showNotification('Failed to start voice chat: ' + error.message, 'error');
        endVoiceChat();
      }
    }

    function startVoiceChatTimer() {
      voiceChatSeconds = 0;
      voiceChatTimer = setInterval(() => {
        voiceChatSeconds++;
        const minutes = Math.floor(voiceChatSeconds / 60);
        const seconds = voiceChatSeconds % 60;
        document.getElementById('voiceChatTimer').textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function endVoiceChat() {
      if (voiceChatConnection) {
        voiceChatConnection.close();
        voiceChatConnection = null;
      }
      
      if (voiceChatTimer) {
        clearInterval(voiceChatTimer);
        voiceChatTimer = null;
      }
      
      document.getElementById('voiceChatModal').classList.add('hidden');
      
      const btn = document.getElementById('realTimeChatBtn');
      btn.innerHTML = `
        <img src="/timer.png" alt="Timer" class="w-5 h-5">
        <span>Real Time Chat</span>
      `;
      btn.classList.remove('bg-red-50', 'text-red-700');
      
      showNotification('Voice chat ended', 'info');
    }

    // Voice Input/Output Functions
    function toggleVoiceRecording() {
      if (!isRecording) {
        startVoiceInput();
      } else {
        stopVoiceInput();
      }
    }

    function startVoiceInput() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.start();
        isRecording = true;
        
        document.getElementById('voiceRecordingIndicator').classList.remove('hidden');
        const micBtn = document.getElementById('micButton');
        micBtn.classList.add('bg-red-50', 'border-red-300');

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById('messageInput').value = transcript;
          stopVoiceInput();
          sendMessage();
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          stopVoiceInput();
          showNotification('Voice recognition error: ' + event.error, 'error');
        };

        recognition.onend = () => {
          stopVoiceInput();
        };
      } else {
        showNotification('Speech recognition not supported in this browser', 'error');
      }
    }

    function stopVoiceInput() {
      if (recognition) {
        recognition.stop();
      }
      isRecording = false;
      document.getElementById('voiceRecordingIndicator').classList.add('hidden');
      const micBtn = document.getElementById('micButton');
      micBtn.classList.remove('bg-red-50', 'border-red-300');
    }

    function toggleVoiceOutput() {
      isVoiceOutputEnabled = !isVoiceOutputEnabled;
      const btn = document.getElementById('voiceOutputBtn');
      
      if (isVoiceOutputEnabled) {
        btn.classList.add('bg-blue-50', 'border-blue-300');
        showNotification('Voice output enabled', 'success');
      } else {
        btn.classList.remove('bg-blue-50', 'border-blue-300');
        showNotification('Voice output disabled', 'info');
      }
    }

    function speakText(text) {
      if ('speechSynthesis' in window && isVoiceOutputEnabled) {
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        const voices = window.speechSynthesis.getVoices();
        const femaleVoice = voices.find(voice => 
          voice.name.includes('Female') || 
          voice.name.includes('Zira') || 
          voice.name.includes('Emma')
        );
        if (femaleVoice) {
          utterance.voice = femaleVoice;
        }
        
        window.speechSynthesis.speak(utterance);
      }
    }

    function stopRecording() {
      if (isRecording && mediaRecorder) {
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById('voiceRecordingIndicator').classList.add('hidden');
      }
    }

    async function logout() {
      try {
        const response = await fetch('/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.redirect_url) {
            window.location.href = data.redirect_url;
          } else {
            window.location.href = '/login';
          }
        } else {
          window.location.href = '/logout';
        }
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/logout';
      }
    }

    // Utility Functions
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transform transition-all duration-300 translate-x-full`;
      
      switch(type) {
        case 'success':
          notification.classList.add('bg-green-500');
          break;
        case 'error':
          notification.classList.add('bg-red-500');
          break;
        case 'warning':
          notification.classList.add('bg-yellow-500');
          break;
        default:
          notification.classList.add('bg-blue-500');
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    function showTypingIndicator() {
      const chatMessages = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typingIndicator';
      typingDiv.className = 'flex items-start gap-4 mb-4';
      typingDiv.innerHTML = `
        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
          AI
        </div>
        <div class="bg-gray-100 rounded-2xl px-5 py-4 max-w-lg">
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
          </div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function addMessageToChat(sender, message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start gap-4 mb-4';

      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="flex items-start gap-4 flex-row-reverse w-full">
            <div class="w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
              U
            </div>
            <div class="bg-blue-500 text-white rounded-2xl px-5 py-4 max-w-lg">
              <p class="leading-relaxed">${message}</p>
            </div>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
            AI
          </div>
          <div class="bg-gray-100 rounded-2xl px-5 py-4 max-w-lg">
            <p class="text-gray-700 leading-relaxed">${message}</p>
          </div>
        `;
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function handleSearchKeyPress(event) {
      if (event.key === 'Enter') {
        const searchTerm = event.target.value.trim();
        if (searchTerm) {
          addMessageToChat('user', `Search: ${searchTerm}`);
          setTimeout(() => {
            addMessageToChat('ai', `I found several results related to "${searchTerm}". Here are the most relevant items from our knowledge base and conversation history.`);
            saveChatToHistory();
          }, 1000);
        }
      }
    }

    function saveChatToHistory() {
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    function updateChatHistoryDisplay() {
      const dropdown = document.getElementById('dropdownContent');
      if (!dropdown) return;
      
      dropdown.innerHTML = '';
      
      chatHistory.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'flex items-center justify-between px-3 py-2 hover:bg-gray-100 rounded cursor-pointer';
        chatItem.innerHTML = `
          <div class="text-sm text-gray-700 flex-1" onclick="loadChat(${chat.id})">
            <span class="block font-medium">${chat.title}</span>
            <span class="text-xs text-gray-500">${formatTimestamp(chat.timestamp)}</span>
          </div>
          <div class="flex items-center space-x-3 text-gray-500">
            <i onclick="downloadChat(${chat.id})" class="fas fa-download hover:text-black cursor-pointer"></i>
            <i onclick="deleteChat(${chat.id})" class="fas fa-trash hover:text-red-600 cursor-pointer"></i>
          </div>
        `;
        dropdown.appendChild(chatItem);
      });
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      return `${diffDays} days ago`;
    }

    async function downloadChat(chatId) {
      try {
        const response = await fetch(`/download_chat/${chatId}`);
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `chat_${chatId}.docx`;
          a.click();
          URL.revokeObjectURL(url);
          showNotification('Chat downloaded successfully', 'success');
        } else {
          showNotification('Failed to download chat', 'error');
        }
      } catch (error) {
        console.error('Error downloading chat:', error);
        showNotification('Error downloading chat', 'error');
      }
    }

    async function deleteChat(chatId) {
      if (confirm('Are you sure you want to delete this chat?')) {
        chatHistory = chatHistory.filter(chat => chat.id !== chatId);
        updateChatHistoryDisplay();
        saveChatToHistory();
        showNotification('Chat deleted successfully', 'success');
      }
    }

    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownContent');
      const arrow = document.getElementById('historyArrow');
      
      if (dropdown && arrow) {
        if (dropdown.classList.contains('hidden')) {
          dropdown.classList.remove('hidden');
          arrow.classList.add('fa-chevron-up');
          arrow.classList.remove('fa-chevron-down');
        } else {
          dropdown.classList.add('hidden');
          arrow.classList.remove('fa-chevron-up');
          arrow.classList.add('fa-chevron-down');
        }
      }
    }

    // Modal Functions
    function openLessonGenerator() {
      document.getElementById('fileUploadModal').classList.remove('hidden');
    }

    function closeFileUploadModal() {
      document.getElementById('fileUploadModal').classList.add('hidden');
      document.getElementById('selectedFileName').classList.add('hidden');
      document.getElementById('lessonFileInput').value = '';
      document.getElementById('generateLessonBtn').disabled = true;
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const fileNameDisplay = document.getElementById('selectedFileName');
        fileNameDisplay.querySelector('span').textContent = file.name;
        fileNameDisplay.classList.remove('hidden');
        document.getElementById('generateLessonBtn').disabled = false;
      }
    }

    function removeSelectedFile() {
      document.getElementById('selectedFileName').classList.add('hidden');
      document.getElementById('lessonFileInput').value = '';
      document.getElementById('generateLessonBtn').disabled = true;
    }

    function updateApiKey() {
      document.getElementById('apiKeyModal').classList.remove('hidden');
    }

    function closeApiKeyModal() {
      document.getElementById('apiKeyModal').classList.add('hidden');
      document.getElementById('apiKeyInput').value = '';
    }

    function toggleApiKeyVisibility() {
      const input = document.getElementById('apiKeyInput');
      const icon = document.getElementById('toggleApiKeyIcon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    function changeTab(button) {
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.classList.remove('text-blue-500', 'bg-white', 'shadow-sm');
        btn.classList.add('text-gray-500');
      });
      
      button.classList.remove('text-gray-500');
      button.classList.add('text-blue-500', 'bg-white', 'shadow-sm');
      
      const tabName = button.textContent.trim();
      if (tabName === 'Knowledge Base') {
        document.getElementById('chatMessages').innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-book text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Knowledge Base</h3>
            <p class="text-gray-500">Search through your knowledge base or upload documents to get started.</p>
            <button onclick="openLessonGenerator()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
              Upload Document
            </button>
          </div>
        `;
      } else {
        if (currentChatId) {
          loadChat(currentChatId);
        } else {
          startNewChat();
        }
      }
    }

    // Initialize drag and drop
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('fileUploadModal');
      const dropZone = modal.querySelector('.border-dashed');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e) {
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
      }

      function unhighlight(e) {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      }

      dropZone.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          const fileInput = document.getElementById('lessonFileInput');
          fileInput.files = files;
          handleFileSelect({ target: fileInput });
        }
      }
    });

    // Auto-update token meter
    setInterval(() => {
      if (currentChatId) {
        updateTokenMeter();
      }
    }, 30000);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        startNewChat();
      }
      
      if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        resetChat();
      }
      
      if (e.key === 'Escape') {
        closeFileUploadModal();
        closeApiKeyModal();
        if (voiceChatConnection) {
          endVoiceChat();
        }
      }

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

  </script>

  <style>
    .animate-bounce {
      animation: bounce 1s infinite;
    }
    
    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% {
        transform: translate3d(0,0,0);
      }
      40%, 43% {
        transform: translate3d(0,-15px,0);
      }
      70% {
        transform: translate3d(0,-7px,0);
      }
      90% {
        transform: translate3d(0,-2px,0);
      }
    }
    
    @media (max-width: 768px) {
      .flex-1 {
        margin-left: 0 !important;
      }
    }
    
    /* Custom scrollbar */
    .overflow-y-auto::-webkit-scrollbar {
      width: 6px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* Focus styles for accessibility */
    button:focus,
    input:focus,
    textarea:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    
    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html>