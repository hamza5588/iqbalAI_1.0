<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        myblue: '#05B0FC',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-button@4.6.4/dist/emoji-button.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts & Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>AI Chat Interface</title>
</head>

<body class="h-screen bg-gray-100 font-inter">
    <div class="flex h-full">

        <!-- Sidebar -->
        <div id="sidebar"
            class="w-52 sm:w-60 lg:w-68 xl:w-[220px] bg-white shadow-md p-2 sm:p-3 fixed md:static top-0 left-0 h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40 flex flex-col">
            <!-- Header Section -->
            <div class="flex justify-between items-center">
                <img src="{{ url_for('static', filename='images/logo.png') }}"
                    class="w-20 sm:w-24 lg:w-28 xl:w-32 h-6 sm:h-8 lg:h-10" alt="">
                <button onclick="hideSidebar()" class="mt-2 sm:mt-4 hover:bg-gray-100 p-1 rounded">
                    <img src="{{ url_for('static', filename='images/slider.png') }}" alt="">
                </button>
            </div>

            <!-- Border Line -->
            <div class="mt-3 sm:mt-4 border-t-2 border-gray-300 -mx-3 sm:-mx-4"></div>

            <!-- Main Content Section -->
            <div class="flex-1 flex flex-col">
                <div
                    class="flex flex-col space-y-2 sm:space-y-3 lg:space-y-4 justify-center items-center mt-4 sm:mt-6 mb-2">

                    <!-- New Chat -->
                    <button onclick="startNewChat()"
                        class="w-full max-w-[180px] sm:max-w-[200px] lg:max-w-[230px] h-10 sm:h-12 lg:h-[50px] mt-2 sm:mt-3 mb-1 sm:mb-2 px-3 sm:px-4 flex items-center justify-center gap-2 bg-[#05B0FC] text-white text-sm sm:text-base font-bold rounded transition duration-200 ease-in-out hover:bg-blue-600">
                        <img src="{{ url_for('static', filename='images/msg.png') }}" alt="">
                        <span>New Chat</span>
                    </button>

                    <!-- Action Buttons -->
                    <button onclick="openLessonGenerator()"
                        class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors"
                        id="generateLessonBtn">
                        <img src="{{ url_for('static', filename='images/lesson.png') }}" alt="" class="w-3.5 h-3.5">
                        <span>Generate Lessons</span>
                    </button>

                    <!-- View Lessons Button in Sidebar -->
                    <button onclick="openViewLessons()"
                        class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors"
                        id="viewLessonsBtn">
                        <img src="{{ url_for('static', filename='images/lesson.png') }}" alt="" class="w-3.5 h-3.5">
                        <span id="viewLessonsLabel">View Lessons</span>
                    </button>


                    <button onclick="toggleVoiceRecording()"
                        class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors">
                        <i class="fas fa-microphone w-3.5 h-3.5"></i>
                        <span>Real Time Chat</span>
                    </button>

                    <button onclick="resetChat()"
                        class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors">
                        <i class="fas fa-refresh text-[#B7B7B7] w-3.5 h-3.5"></i>
                        <span>Reset Chat</span>
                    </button>

                    <!-- Chat History Button -->
                    <button onclick="toggleDropdown()"
                        class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center justify-between font-semibold text-xs text-gray-700 mt-1.5 hover:bg-gray-50 rounded transition-colors">
                        <i class="fas fa-history text-[#B7B7B7] w-3 h-3"></i>
                        <span>Chat History</span>
                        <i class="fas fa-chevron-down text-[#666] w-2 h-2" id="historyArrow"></i>
                    </button>

                    <!-- Dropdown Chat History -->
                    <div id="dropdownContent"
                        class="mt-1.5 hidden flex-col gap-1 w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] max-h-20 sm:max-h-28 lg:max-h-36 overflow-y-auto sidebar-scroll">
                        <!-- Chat history items will be populated here -->
                    </div>

                    <!-- Voice Recording Indicator -->
                    <div id="voiceRecordingIndicator"
                        class="hidden px-4 sm:px-6 py-2 bg-red-50 border-l-4 border-red-500">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                            <span class="text-red-700 font-medium text-sm sm:text-base">Recording... Click to
                                stop</span>
                            <button onclick="stopRecording()" class="ml-auto text-red-700 hover:text-red-900">
                                <i class="fas fa-stop-circle text-lg sm:text-xl"></i>
                            </button>
                        </div>
                    </div>



                </div>

                <!-- Logout Button -->
                <div class="mt-auto p-2">
                    <button onclick="logout()"
                        class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center justify-center gap-1.5 font-semibold text-xs text-gray-700 bg-white shadow rounded hover:bg-gray-50 transition-colors">
                        <i class="fas fa-sign-out-alt text-[#F50D0D] w-3 h-3"></i>
                        <span class="text-[#F50D0D]">Log out</span>
                    </button>
                </div>
            </div>
        </div>
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <!-- Main Content -->
        <div class="flex-1 bg-white h-full flex flex-col md:ml-0 overflow-hidden">

            <!-- Mobile Menu Button Section -->
            <div class="px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex justify-start">
                    <button id="mobileMenuBtn"
                        class="md:hidden w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                        <i class="fas fa-bars w-5 h-5 sm:w-6 sm:h-6"></i>
                    </button>
                </div>
            </div>





         <div class="h-full">


               <!-- Chat Header Section -->
               <div class="flex items-center justify-between px-3 sm:px-4 lg:px-6 py-3 sm:py-4 border-t border-gray-100">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div
                        class="w-9 h-9 sm:w-11 sm:h-11 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xs sm:text-sm">
                        AI
                    </div>
                    <div>
                        <h3 class="text-gray-900 font-semibold text-base sm:text-lg" id="chatTitle">New Chat</h3>
                        <p class="text-gray-500 text-xs sm:text-sm" id="chatStatus">Online</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <!-- Token Usage + API Key (joined) -->
                    <div class="flex items-stretch">
                        <div id="tokenMeter"
                            class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-l-lg border border-blue-200 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer"
                            title="Token Usage">
                            <i class="fas fa-chart-line text-blue-600 text-sm flex-shrink-0"></i>
                            <div class="flex flex-col leading-tight min-w-0 flex-1">
                                <span id="tokenUsageText"
                                    class="text-xs text-gray-700 font-medium truncate">Loadingâ€¦</span>
                                <span id="tokenResetText" class="text-xs text-gray-500 truncate"></span>
                            </div>
                        </div>

                        <!-- Update API Key Button (joined, no space) -->
                        <button onclick="openApiKeyModal()"
                            class="flex flex-col items-center justify-center px-2 py-1 bg-white border border-gray-200 border-l-0 rounded-r-lg -ml-px hover:bg-gray-50 transition-colors"
                            title="Update API Key">
                            <img src="{{ url_for('static', filename='images/key.png') }}" alt="" class="w-4 h-4">
                            <span class="text-[10px] text-gray-500 leading-none mt-0.5">apikey</span>
                        </button>
                    </div>

                    <button id="chatDownloadBtn" onclick="downloadCurrentChat()"
                        class="w-8 h-8 sm:w-10 sm:h-10 border border-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors">
                        <i class="fas fa-download text-gray-500 text-xs sm:text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="flex-1 px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 overflow-y-auto zoomable-content min-h-0"
                id="chatMessages">
                <div class="flex items-start gap-3">
                    <div
                        class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xs sm:text-sm flex-shrink-0">
                        AI
                    </div>
                    <div class="bg-gray-100 rounded-2xl px-3 sm:px-4 lg:px-5 py-3 sm:py-4 w-full">
                        <p class="text-gray-700 leading-relaxed text-sm sm:text-base">
                            Hello! I'm your AI assistant. How can I help you today?
                        </p>
                    </div>
                </div>
            </div>

         </div>

      <!-- chat input filed -->
      <div id="chatInputArea" class="px-3 sm:px-4 lg:px-6 py-3 sm:py-4 border-t border-gray-100 bg-white flex-shrink-0">
        <div class="flex items-center gap-2 sm:gap-3">
            <button onclick="toggleVoiceRecording()" id="micButton"
                class="w-10 h-10 sm:w-12 sm:h-12 border border-gray-200 rounded-xl flex items-center justify-center hover:bg-gray-50 transition-colors">
                <img src="{{ url_for('static', filename='images/recorder.png') }}" alt="" class="w-5 h-5 sm:w-6 sm:h-6">
            </button>
            <button onclick="toggleVoiceOutput()" id="voiceOutputBtn"
                class="w-10 h-10 sm:w-12 sm:h-12 border border-gray-200 rounded-xl flex items-center justify-center hover:bg-gray-50 transition-colors">
                <img src="{{ url_for('static', filename='images/voice.png') }}" alt="" class="w-5 h-5 sm:w-6 sm:h-6">
            </button>
    
            <div class="flex-1 relative">
                <textarea id="messageInput" placeholder="Type your message"
                    class="w-full px-4 sm:px-5 lg:px-6 py-3 sm:py-4 bg-gray-100 rounded-2xl border-0 focus:outline-none text-gray-700 placeholder-gray-500 text-sm sm:text-base resize-none overflow-hidden min-h-[48px] max-h-[200px]"
                    rows="1" onkeydown="handleKeyDown(event)" oninput="autoResizeTextarea(this)"></textarea>
            </div>
    
            <button onclick="sendMessage()"
                class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500 rounded-xl flex items-center justify-center hover:bg-blue-600 transition-colors">
                <img src="{{ url_for('static', filename='images/sender.png') }}" alt="" class="w-5 h-5 sm:w-6 sm:h-6">
            </button>
        </div>
    
    </div>







            <!-- View Lessons Content -->
            <div id="viewLessonsContent"
                class="hidden flex-1 px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 overflow-y-auto w-full">
                <div class="w-full mx-auto">
                    <!-- Search and Filter Section -->
                    <div class="bg-white p-3 mb-2 w-full rounded-lg shadow-sm">
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                            <div class="flex-1">
                                <input type="text" id="searchLessons" placeholder="Search lessons..."
                                    class="w-full px-2 py-1.5 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                                    onkeypress="handleLessonSearchKeyPress(event)" />
                            </div>
                            <button onclick="searchLessons()"
                                class="px-3 py-1.5 bg-[#05B0FC] text-white rounded-lg transition-colors font-medium text-sm">
                                <i class="fas fa-search mr-1"></i>Search
                            </button>
                            <button onclick="generateLessonButton()"
                                class="px-3 py-1.5 bg-[#05B0FC] text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm"
                                id="generateLessonTopBtn" style="display: none;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Lessons Display -->
                    <div id="lessonsDisplayContainer" class="max-h-80 sm:max-h-96 lg:max-h-[500px] overflow-y-auto">
                        <!-- Content will be injected here by JS -->
                    </div>
                </div>
            </div>

            <!-- Most Frequent Questions View -->
            <div id="mostFrequentQuestionsView"
                class="hidden flex-1 px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 overflow-y-auto">
                <div class="max-w-xs sm:max-w-4xl lg:max-w-6xl mx-auto">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center mb-6 sm:mb-8 gap-4">
                        <button onclick="backToLessons()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-arrow-left text-[#05B0FC] text-lg sm:text-xl"></i>
                        </button>
                        <div class="text-center flex-1">
                            <h2 class="text-2xl sm:text-3xl font-bold text-[#05B0FC] mb-2" id="faqViewTitle">Most
                                Frequent Questions
                            </h2>
                            <p class="text-gray-600 text-center px-4 sm:px-8 lg:px-[200px] text-sm sm:text-base"
                                id="faqViewDescription">View the most
                                commonly asked questions by students in your lessons. This helps you identify knowledge
                                gaps and improve engagement.</p>
                        </div>
                    </div>

                    <!-- FAQ Table -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden overflow-x-auto">
                        <!-- Table Rows -->
                        <div id="mostFrequentQuestionsTable" class="divide-y divide-gray-200 min-w-full">
                            <!-- Content will be populated here -->
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center mt-6 sm:mt-8 flex flex-col sm:flex-row justify-center gap-3 sm:gap-4">
                        <button onclick="backToLessons()"
                            class="px-6 sm:px-8 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm sm:text-base">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Lessons
                        </button>
                        <button onclick="exportAllFAQReport()"
                            class="px-6 sm:px-8 py-2 sm:py-3 border border-[#05B0FC] text-[#05B0FC] rounded-lg hover:bg-blue-50 transition-colors font-medium text-sm sm:text-base">
                            <i class="fas fa-download mr-2"></i>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Frequently Asked Questions Dashboard for Teachers -->
            <div id="faqDashboard" class="hidden flex-1 px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 overflow-y-auto">
                <div class="max-w-xs sm:max-w-2xl lg:max-w-4xl mx-auto">
                    <div class="text-center mb-6 sm:mb-8">
                        <h2 class="text-2xl sm:text-3xl font-bold text-[#05B0FC] mb-2">
                            <i class="fas fa-chart-line mr-3"></i>
                            Frequently Asked Questions Dashboard
                        </h2>
                        <p class="text-gray-600 text-sm sm:text-base">Monitor the most common questions from your
                            students</p>
                    </div>

                    <!-- FAQ Content will be populated here -->
                    <div id="faqDashboardContent">
                        <div class="text-center py-12 sm:py-16">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-500 text-base sm:text-lg">Loading FAQ data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Lesson Generator Content -->
            <div id="lessonGeneratorContent"
                class="hidden flex-1 px-3 sm:px-4 lg:px-6 pt-4 sm:pt-6 lg:pt-8 overflow-y-auto">
                <!-- Combined Lesson Generator Form -->
                <div id="lessonFormStep" class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-[#05B0FC] mb-2">Create Your Lesson</h2>
                        <p class="text-gray-600 text-base">Upload materials and fill in lesson details</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-[#05B0FC] to-blue-600 px-6 py-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-graduation-cap mr-3"></i>
                                Lesson Generator
                            </h3>
                        </div>

                        <div class="p-4">
                            <form id="lessonConfigForm" onsubmit="generateLesson(event)">
                                <!-- File Upload Section -->
                                <div class="mb-6">
                                    <div class="flex items-center mb-3">
                                        <div
                                            class="w-6 h-6 bg-[#05B0FC] rounded-full flex items-center justify-center mr-2">
                                            <i class="fas fa-upload text-white text-xs"></i>
                                        </div>
                                        <h4 class="text-base font-semibold text-gray-800">Upload Document (Optional)
                                        </h4>
                                    </div>

                                    <div id="lessonDropZone"
                                        class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-gray-50 cursor-pointer hover:bg-gray-100 hover:border-[#05B0FC] transition-all duration-200 min-h-24 flex flex-col items-center justify-center"
                                        onclick="document.getElementById('lessonFileInput').click()">
                                        <div class="flex gap-2 mb-2">
                                            <img src="{{ url_for('static', filename='images/excel.png') }}" alt=""
                                                class="w-5 h-5">
                                            <img src="{{ url_for('static', filename='images/ppt.png') }}" alt=""
                                                class="w-5 h-5">
                                            <img src="{{ url_for('static', filename='images/word.png') }}" alt=""
                                                class="w-5 h-5">
                                        </div>
                                        <p class="text-gray-700 text-sm mb-1 font-medium">Drop your file here or click
                                            to browse</p>
                                        <p class="text-gray-500 text-xs">Support PDF, DOCX, PPT files up to 10MB</p>

                                        <input type="file" id="lessonFileInput" class="hidden"
                                            accept=".pdf,.doc,.docx,.txt,.ppt,.pptx" onchange="handleFileSelect(event)">
                                    </div>

                                    <div id="selectedFileName"
                                        class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-file text-blue-500 mr-3"></i>
                                                <span class="text-blue-700 font-medium"></span>
                                            </div>
                                            <button type="button" onclick="removeSelectedFile()"
                                                class="text-blue-500 hover:text-red-600 p-1">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Lesson Details Section -->
                                <div class="mb-6">
                                    <div class="flex items-center mb-4">
                                        <div
                                            class="w-6 h-6 bg-[#05B0FC] rounded-full flex items-center justify-center mr-2">
                                            <i class="fas fa-edit text-white text-xs"></i>
                                        </div>
                                        <h4 class="text-base font-semibold text-gray-800">Lesson Details</h4>
                                    </div>

                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        <!-- Left Column -->
                                        <div class="space-y-4">
                                            <!-- Lesson Title -->
                                            <div>
                                                <label class="block text-gray-700 text-sm font-semibold mb-1"
                                                    for="lessonTitle">
                                                    Lesson Title *
                                                </label>
                                                <input type="text" id="lessonTitle" name="lessonTitle"
                                                    placeholder="Enter your lesson title..."
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#05B0FC] focus:border-transparent text-sm transition-all duration-200"
                                                    oninput="validateLessonTitleInput()" required />
                                                <div id="titleValidationMessage" class="mt-1 text-xs hidden">
                                                    <span id="titleValidationText"></span>
                                                </div>
                                            </div>

                                            <!-- Lesson Prompt -->
                                            <div>
                                                <label class="block text-gray-700 text-sm font-semibold mb-1"
                                                    for="lessonPrompt">
                                                    Lesson Prompt *
                                                </label>
                                                <textarea id="lessonPrompt" name="lessonPrompt"
                                                    placeholder="Describe what lesson you want to generate. For example: 'Generate a lesson on Force and Motion covering sections 1.1 to 1.4' or 'Create a lesson on Photosynthesis focusing on the light-dependent reactions'"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#05B0FC] focus:border-transparent h-20 resize-none text-sm transition-all duration-200"
                                                    required></textarea>
                                            </div>

                                            <!-- Additional Notes -->
                                            <div>
                                                <label class="block text-gray-700 text-sm font-semibold mb-1"
                                                    for="additionalNotes">
                                                    Additional Notes (Optional)
                                                </label>
                                                <textarea id="additionalNotes" name="additionalNotes"
                                                    placeholder="Any specific requirements, teaching methods, or notes..."
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#05B0FC] focus:border-transparent h-16 resize-none text-sm transition-all duration-200"></textarea>
                                            </div>
                                        </div>

                                        <!-- Right Column -->
                                        <div class="space-y-4">
                                            <!-- Focus Area -->
                                            <div>
                                                <label class="block text-gray-700 text-sm font-semibold mb-1"
                                                    for="focusArea">
                                                    Focus Area *
                                                </label>
                                                <select id="focusArea" name="focusArea"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#05B0FC] focus:border-transparent text-sm transition-all duration-200"
                                                    required>
                                                    <option value="">Select focus area...</option>
                                                    <option value="Reading Comprehension">Reading Comprehension</option>
                                                    <option value="Mathematics">Mathematics</option>
                                                    <option value="Science">Science</option>
                                                    <option value="Social Studies">Social Studies</option>
                                                    <option value="Language Arts">Language Arts</option>
                                                    <option value="History">History</option>
                                                    <option value="Geography">Geography</option>
                                                    <option value="Literature">Literature</option>
                                                    <option value="Writing">Writing</option>
                                                    <option value="Critical Thinking">Critical Thinking</option>
                                                    <option value="Problem Solving">Problem Solving</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>

                                            <!-- Grade Level -->
                                            <div>
                                                <label class="block text-gray-700 text-sm font-semibold mb-1"
                                                    for="gradeLevel">
                                                    Grade Level *
                                                </label>
                                                <select id="gradeLevel" name="gradeLevel"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#05B0FC] focus:border-transparent text-sm transition-all duration-200"
                                                    required>
                                                    <option value="">Select grade level...</option>
                                                    <option value="K-1">Kindergarten - 1st Grade</option>
                                                    <option value="2-3">2nd - 3rd Grade</option>
                                                    <option value="4-5">4th - 5th Grade</option>
                                                    <option value="6-8">6th - 8th Grade (Middle School)</option>
                                                    <option value="9-12">9th - 12th Grade (High School)</option>
                                                    <option value="College">College/University</option>
                                                    <option value="Adult">Adult Education</option>
                                                </select>
                                            </div>

                                            <!-- Quick Actions -->
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <h5 class="text-xs font-semibold text-gray-700 mb-2">Quick Actions</h5>
                                                <div class="space-y-1">
                                                    <button type="button" onclick="startNewLesson()"
                                                        class="w-full text-left px-2 py-1 text-xs text-gray-600 hover:bg-white hover:text-[#05B0FC] rounded transition-colors">
                                                        <i class="fas fa-plus mr-1"></i>Start Fresh Lesson
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div
                                    class="flex flex-col sm:flex-row gap-3 justify-center pt-4 border-t border-gray-200">
                                    <button type="submit" id="generateLessonFormBtn"
                                        class="px-6 py-2 bg-gradient-to-r from-[#05B0FC] to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-[#05B0FC] transition-all duration-200 text-base font-semibold shadow-md hover:shadow-lg">
                                        <i class="fas fa-magic mr-2"></i>
                                        <span id="generateBtnText">Generate Lesson</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Generated Lesson Display -->
                <div id="lessonDisplay" class="hidden w-full mx-auto p-3 sm:p-4 lg:p-5">
                    <div class="bg-white">
                        <!-- Lesson Content -->
                        <div class="p-4 sm:p-6 rounded-lg border border-blue-500 shadow-lg">
                            <!-- Read-only lesson content display -->
                            <div id="lessonSummary"
                                class="text-gray-700 leading-relaxed text-sm sm:text-base zoomable-content">
                                <p>Your generated lesson content will appear here...</p>
                            </div>

                            <!-- Inline editing textarea (hidden by default) -->
                            <textarea id="inlineEditTextarea"
                                class="hidden w-full min-h-[200px] px-3 sm:px-4 py-2 sm:py-3 border border-[#05B0FC] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none text-xs sm:text-sm font-mono"
                                placeholder="Edit your lesson content here..."></textarea>

                            <!-- AI prompt input (hidden by default) -->
                            <div id="inlineAIPromptContainer" class="hidden mt-4">
                                <label class="block text-[#05B0FC] text-xs sm:text-sm font-bold mb-2"
                                    for="inlineAIPrompt">
                                    Enter your prompt to modify the lesson:
                                </label>
                                <textarea id="inlineAIPrompt" placeholder="Describe what changes you want AI to make..."
                                    class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 min-h-20 sm:min-h-24 max-h-32 sm:max-h-40 overflow-y-auto resize-none text-sm sm:text-base"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="additionalNotesDisplay" class="mb-4 sm:mb-6 hidden">
                        <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3">Additional
                            Notes</h4>
                        <div class="p-3 sm:p-4 rounded-lg">
                            <p class="text-yellow-800 text-sm sm:text-base" id="displayAdditionalNotes"></p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-2 sm:p-3">
                    <!-- Default review buttons -->
                    <div id="defaultReviewButtons"
                        class="flex flex-col sm:flex-row justify-center items-center gap-3 sm:gap-4">
                        <button onclick="reviewWithHuman()"
                            class="w-full sm:w-auto px-6 sm:px-8 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                            Review with Human
                        </button>
                        <button onclick="reviewWithAI()"
                            class="w-full sm:w-auto px-6 sm:px-8 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                            Review with AI
                        </button>
                    </div>

                    <!-- Inline editing buttons (hidden by default) -->
                    <div id="inlineEditButtons"
                        class="hidden flex flex-col sm:flex-row justify-center items-center gap-3 sm:gap-4">
                        <button onclick="saveInlineEdit()"
                            class="w-full sm:w-auto px-6 sm:px-8 py-2 sm:py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button onclick="cancelInlineEdit()"
                            class="w-full sm:w-auto px-6 sm:px-8 py-2 sm:py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>

                    <!-- Inline AI review buttons (hidden by default) -->
                    <div id="inlineAIButtons"
                        class="hidden flex flex-col sm:flex-row justify-center items-center gap-3 sm:gap-4">
                        <button onclick="applyInlineAI()" id="applyInlineAIBtn"
                            class="w-full sm:w-auto px-6 sm:px-8 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                            <span id="applyInlineAIText">Apply AI Changes</span>
                            <i id="applyInlineAILoader" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                        </button>
                        <button onclick="cancelInlineAI()"
                            class="w-full sm:w-auto px-6 sm:px-8 py-2 sm:py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                    <div id="finalizeNewLessonButtons"
                        class="flex flex-col sm:flex-row justify-center mt-3 sm:mt-4 gap-3 sm:gap-4">
                        <button onclick="proceedToCompletion()"
                            class="w-full sm:w-auto border border-[#05B0FC] px-6 sm:px-8 py-2 sm:py-3 bg-white text-[#05B0FC] hover:text-white hover:bg-[#05B0FC] rounded-lg transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                            <i class="fas fa-check"></i>
                            Finalize and Download
                        </button>
                        <button onclick="startNewLesson()"
                            class="w-full sm:w-auto px-4 sm:px-6 py-2 sm:py-3 border-2 border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors text-base sm:text-lg font-medium">
                            <i class="fas fa-plus mr-2"></i>New Lesson
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lesson Completion Page -->
        <div id="lessonCompletionPage"
            class="hidden max-w-sm sm:max-w-lg lg:max-w-2xl mx-auto text-center p-4 sm:p-6 lg:p-8">
            <div class="mb-6 sm:mb-8">
                <div class="flex items-center justify-center mb-3 sm:mb-4">
                    <i class="fas fa-check-circle text-[#05B0FC] text-3xl sm:text-4xl mr-3"></i>
                    <h2 class="text-2xl sm:text-3xl font-bold text-[#05B0FC]">Your lesson is ready!</h2>
                </div>
                <p class="text-gray-600 text-base sm:text-lg">Download and share your lesson</p>
            </div>

            <!-- Lesson File Display -->
            <div class="mb-6 sm:mb-8">
                <div
                    class="bg-[#05B0FC] text-white rounded-lg px-4 sm:px-6 py-3 sm:py-4 text-base sm:text-lg font-medium">
                    <i class="fas fa-file mr-2"></i>
                    <span id="completedLessonTitle">Sample Lesson from document.pdf</span>
                </div>
            </div>

            <!-- Download Buttons -->
            <div class="flex flex-col sm:flex-row justify-center gap-3 sm:gap-4 mb-6 sm:mb-8">
                <button onclick="downloadLesson('pdf')"
                    class="px-6 sm:px-8 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                    <i class="fas fa-download"></i>
                    Download PDF
                </button>
                <button onclick="downloadLesson('docx')"
                    class="px-6 sm:px-8 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                    <i class="fas fa-download"></i>
                    Download DOCX
                </button>
                <button onclick="downloadLesson('pptx')"
                    class="px-6 sm:px-8 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-2 text-sm sm:text-base">
                    <i class="fas fa-download"></i>
                    Download PPT
                </button>
            </div>

            <!-- Start New Lesson Button -->
            <div>
                <button onclick="startNewLesson()"
                    class="px-8 sm:px-10 lg:px-12 py-3 sm:py-4 text-[#05B0FC] hover:text-white bg-white hover:bg-[#05B0FC] border border-[#05B0FC] rounded-lg transition-colors font-medium text-base sm:text-lg">
                    Start New Lesson
                </button>
            </div>
        </div>

        <!-- Human Review Interface -->
        <div id="humanReviewInterface"
            class="hidden w-full mx-auto px-3 sm:px-4 lg:px-6 pt-4 sm:pt-6 lg:pt-8 border border-[#05B0FC] shadow-3xl rounded-xl">
            <div class="text-center mb-6 sm:mb-8">
                <div class="flex gap-2 justify-center items-center">
                    <img src="../static/images/manual.png" alt="Manual Edit Icon" class="h-6 w-6 sm:h-8 sm:w-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-[#05B0FC] mb-2">Manual Edit</h2>
                </div>
                <p class="text-gray-600 text-sm sm:text-base">Manually edit the content below</p>
            </div>

            <div class="p-3 sm:p-4">
                <!-- Single Editable Content Area -->
                <div class="mb-4 sm:mb-6">
                    <textarea id="humanReviewContent"
                        class="w-full min-h-[200px] px-3 sm:px-4 py-2 sm:py-3 border border-[#05B0FC] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none text-xs sm:text-sm font-mono"
                        placeholder="Edit your lesson content here..."></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
                    <button onclick="startNewLesson()"
                        class="px-4 sm:px-6 py-2 sm:py-3 border-2 border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors font-medium text-sm sm:text-base">
                        <i class="fas fa-plus mr-2"></i>New Lesson
                    </button>
                    <button onclick="cancelHumanReview()"
                        class="px-4 sm:px-6 py-2 sm:py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors text-sm sm:text-base">
                        Cancel
                    </button>
                    <button onclick="saveHumanReview()"
                        class="px-4 sm:px-6 py-2 sm:py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm sm:text-base">
                        Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Review Interface -->
    <div id="aiReviewInterface" class="hidden w-full mx-auto px-3 sm:px-4 lg:px-6 pt-4 sm:pt-6 lg:pt-8">
        <div class="text-center mb-6 sm:mb-8">
            <div class="flex justify-center items-center gap-2">
                <img src="../static/images/manual.png" alt="Manual Edit Icon" class="h-6 w-6 sm:h-8 sm:w-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-[#05B0FC] mb-2">Edit With AI</h2>
            </div>
            <p class="text-sm sm:text-base">Provide Instruction to AI to modify your lesson </p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8 border border-[#05B0FC]">
            <div class="mb-4 sm:mb-6">
                <label class="block text-[#05B0FC] text-xs sm:text-sm font-bold mb-2" for="aiReviewPrompt">
                    Add Your Prompt Here
                </label>
                <textarea id="aiReviewPrompt" placeholder="Describe what changes you want AI to make..."
                    class="w-full h-32 px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none text-sm sm:text-base"></textarea>
            </div>
            <div class="mb-4 sm:mb-6 border border-[#05B0FC] rounded-lg p-3 sm:p-4 bg-blue-50">
                <label class="block text-xs sm:text-sm text-[#05B0FC] font-bold mb-2">
                    Current Lesson Preview
                </label>
                <div id="currentLessonPreview" class="bg-blue-80 p-3 sm:p-4 rounded-lg h-32 text-xs sm:text-sm">
                    <!-- This area will scroll if content is long -->
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
                <button onclick="startNewLesson()"
                    class="px-4 sm:px-6 py-2 sm:py-3 border-2 border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors font-medium text-sm sm:text-base">
                    <i class="fas fa-plus mr-2"></i>New Lesson
                </button>
                <button onclick="cancelAIReview()"
                    class="px-4 sm:px-6 py-2 sm:py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 text-sm sm:text-base">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button onclick="applyAIReview()" id="applyAIReviewBtn"
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-[#05B0FC] text-white rounded-lg hover:bg-[#05B0FC]-600 transition-colors font-medium text-sm sm:text-base">
                    <span id="applyAIReviewText">Apply AI Changes</span>
                    <i id="applyAIReviewLoader" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Settings Content -->
    <div id="settingsContent" class="hidden flex-1 px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 overflow-y-auto">
        <div class="max-w-xs sm:max-w-lg lg:max-w-2xl mx-auto">
            <div class="bg-white rounded-xl p-4 sm:p-6 lg:p-8 shadow-lg">
                <h3 class="text-xl sm:text-2xl text-center font-bold text-sky-500 mb-4 sm:mb-6">Update API Key
                </h3>

                <div class="text-gray-600 space-y-2 sm:space-y-3 mb-4 sm:mb-6">
                    <p class="font-bold text-sky-500 text-base sm:text-lg">How to get your GROQ API Key:</p>
                    <p class="text-sm sm:text-base">1. Visit <span class="text-red-500 font-semibold">Groq
                            Console</span></p>
                    <p class="text-sm sm:text-base">2. Sign up or log in to your account</p>
                    <p class="text-sm sm:text-base">3. Go to the API Keys section</p>
                    <p class="text-sm sm:text-base">4. Click "Create API Key"</p>
                    <p class="text-sm sm:text-base">5. Copy your API key and paste it below</p>
                    <p class="text-xs sm:text-sm text-gray-500">Your API key should start with "gsk_"</p>
                </div>

                <div class="mb-4 sm:mb-6">
                    <label class="block text-gray-700 text-xs sm:text-sm font-bold mb-2" for="apiKeyInput">
                        API Key
                    </label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" placeholder="Enter your GROQ API key..."
                            class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 pr-10 sm:pr-12 text-sm sm:text-base" />
                        <button onclick="toggleApiKeyVisibility()"
                            class="absolute right-2 sm:right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye" id="toggleApiKeyIcon"></i>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                    <button onclick="clearApiKey()"
                        class="flex-1 px-4 sm:px-6 py-2 sm:py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors text-sm sm:text-base">
                        Clear
                    </button>
                    <button onclick="saveApiKey()"
                        class="flex-1 px-4 sm:px-6 py-2 sm:py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm sm:text-base">
                        Save API Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="voiceRecordingIndicator" class="hidden px-3 sm:px-4 lg:px-6 py-2 bg-red-50 border-l-4 border-red-500">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
            <span class="text-red-700 font-medium text-sm sm:text-base">Recording... Click to stop</span>
            <button onclick="stopRecording()" class="ml-auto text-red-700 hover:text-red-900">
                <i class="fas fa-stop-circle text-lg sm:text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Input Area -->
 

    </div>

    <!-- Ask Question Modal -->
    <div id="askQuestionModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-3 sm:p-4">
        <div class="bg-white rounded-lg p-4 sm:p-6 lg:p-8 w-full max-w-sm sm:max-w-lg lg:max-w-[600px] mx-4 transition-all duration-300 flex flex-col"
            style="max-height:80vh; overflow-y:auto;" id="askQuestionModalContent">
            <!-- Modal Header -->
            <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 sm:mb-4 gap-3 sm:gap-0">
                <div>
                    <h3 class="text-base sm:text-lg font-semibold text-[#05B0FC]">Ask Question</h3>
                    <p class="text-xs sm:text-sm text-gray-600" id="modalLessonTitle">Loading...</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleModalFullscreen('askQuestionModal')"
                        class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors"
                        title="Toggle Fullscreen">
                        <i class="fas fa-expand text-base sm:text-lg" id="askQuestionModalFullscreenIcon"></i>
                    </button>
                    <button onclick="closeAskQuestionModal()"
                        class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-times text-lg sm:text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Chat-like Q&A History Area -->
            <div class="mb-3 sm:mb-4 flex flex-col flex-1 min-h-0">
                <div class="flex justify-between items-center mb-2 flex-shrink-0">
                    <h4 class="text-xs sm:text-sm font-semibold text-gray-700">Previous Questions</h4>
                    <button onclick="clearLessonChatHistory()"
                        class="text-xs text-red-600 hover:text-red-800 px-2 py-1 rounded hover:bg-red-50 transition-colors">
                        <i class="fas fa-trash mr-1"></i>Clear History
                    </button>
                </div>
                <div id="lessonQnAHistory"
                    class="h-60 sm:h-72 lg:h-80 max-h-60 sm:max-h-72 lg:max-h-80 overflow-y-auto bg-gray-50 rounded p-2 sm:p-3 text-xs sm:text-sm border border-gray-200 flex-1">
                </div>
            </div>

            <!-- Modal Content & Question Input -->
            <div class="flex-shrink-0">
                <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4" id="modalLessonHelper">Tell me how to help you
                    understand this
                    lesson...</p>

                <!-- Question Input -->
                <div class="mb-3 sm:mb-4">
                    <div class="relative">
                        <input type="text" id="questionInput" placeholder="Type your Question about this Lesson"
                            class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 pr-10 sm:pr-12 transition-colors text-sm sm:text-base"
                            onkeypress="if(event.key==='Enter'){if(!isAITyping){submitQuestion();}else{showNotification('Please wait for AI to finish typing...', 'warning');}}" />
                        <button
                            onclick="if(!isAITyping){submitQuestion();}else{showNotification('Please wait for AI to finish typing...', 'warning');}"
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-[#05B0FC] text-white p-1.5 sm:p-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script>
        // Global variables
        let chatHistory = [];
        let currentChatId = null;
        let isRecording = false;
        let isVoiceOutputEnabled = false;
        let mediaRecorder = null;

        let currentView = 'chat';
        let currentLessonFile = null;
        let currentLessonData = null;
        let isCollapsed = false;
        let recognition = null;
        let synthesis = null;
        let voiceChatConnection = null;
        let voiceChatTimer = null;
        let voiceChatSeconds = 0;
        let isVoiceChatActive = false;
        let userRole = 'student'; // Will be set from API
        let userInfo = null;
        let currentQuestionLessonId = null;
        let generatedLessonContent = '';
        let currentLessonForFAQ = null;
        let availableLessons = [];
        let lessonFAQs = {};

        // Initialize FAQ count badges on FAQ buttons
        async function initializeFAQBadges() {
            const buttons = document.querySelectorAll('button[title="View FAQs"][data-lesson-id]');
            if (!buttons || buttons.length === 0) return;
            const fetches = Array.from(buttons).map(async (btn) => {
                const lessonId = btn.getAttribute('data-lesson-id');
                const badge = document.getElementById(`faq-count-${lessonId}`);
                if (!lessonId || !badge) return;
                try {
                    // Use lightweight counts endpoint accessible to all logged-in users
                    const resp = await fetch(`/api/lessons/faqs_count/${lessonId}`);
                    if (!resp.ok) throw new Error('Failed to fetch');
                    const data = await resp.json();
                    const total = Number(data.total_count) || 0;
                    if (total > 0) {
                        badge.textContent = total > 99 ? '99+' : String(total);
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                } catch (e) {
                    // Hide on error
                    badge.style.display = 'none';
                }
            });
            await Promise.all(fetches);
        }
        // Pagination state
        let currentLessonPage = 1;
        const lessonGroupsPerPage = 3; // Show max 3 lesson groups per page

        // Global fetch wrapper to handle authentication errors
        async function authenticatedFetch(url, options = {}) {
            try {
                const response = await fetch(url, {
                    credentials: 'include',
                    ...options
                });

                // Check for authentication errors
                if (response.status === 401 || response.status === 403) {
                    console.log('Authentication error detected, redirecting to login');
                    handleAuthenticationFailure();
                    return null;
                }

                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Initialize
        // Initialize
        window.onload = function () {
            initializeApp();
        };

        // Initialize the application
        async function initializeApp() {
            // Initialize message focus effects
            addMessageFocusEffect();
            // Show loading state
            showLoadingState();

            try {
                // Wait a moment for any authentication redirects to complete
                await new Promise(resolve => setTimeout(resolve, 100));

                // Load user info with retry logic
                await loadUserInfoWithRetry();

                // Initialize other components
                await Promise.all([
                    loadChatHistory(),
                    updateTokenMeter(),
                    checkApiKeyStatus()
                ]);

                // Setup UI
                setupSidebarListeners();
                startTokenMeterAutoRefresh();

                // Try to restore existing chat or start new one
                await restoreOrStartChat();

                // Initialize mobile state
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                } else {
                    // Ensure sidebar is expanded by default on desktop
                    setTimeout(() => {
                        initializeSidebar();
                        // Apply compact sizing for better 100% screen scaling
                        applyCompactSidebarSizing();
                    }, 200);
                }

                // Hide loading state
                hideLoadingState();

            } catch (error) {
                console.error('Failed to initialize app:', error);
                hideLoadingState();
                handleAuthenticationFailure();
            }
        }

        // Initialize sidebar to expanded state by default
        function initializeSidebar() {
            if (window.innerWidth >= 768) {
                // Force sidebar to expanded state
                isCollapsed = false;

                // Check if sidebar content looks collapsed
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    const hasCollapsedContent = sidebar.innerHTML.includes('w-16') ||
                        sidebar.innerHTML.includes('w-10 h-10') ||
                        sidebar.innerHTML.includes('w-10 h-10 bg-gray-100');

                    if (hasCollapsedContent) {
                        console.log('Sidebar appears collapsed, restoring full sidebar...');
                        restoreFullSidebar();
                    }

                    // Ensure sidebar uses compact sizing for 100% screen scaling
                    const hasLargeContent = sidebar.innerHTML.includes('w-24 sm:w-32 lg:w-36 xl:w-[150px]') ||
                        sidebar.innerHTML.includes('h-10 sm:h-12 lg:h-[50px]') ||
                        sidebar.innerHTML.includes('max-w-[180px] sm:max-w-[200px] lg:max-w-[230px]');

                    if (hasLargeContent) {
                        console.log('Sidebar has large content, applying compact sizing...');
                        applyCompactSidebarSizing();
                    }
                }

                // Double-check that sidebar is properly expanded
                setTimeout(() => {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && (sidebar.innerHTML.includes('w-16') || sidebar.innerHTML.includes('w-10 h-10'))) {
                        // Sidebar still appears collapsed, force restore
                        console.log('Sidebar still collapsed, forcing restore...');
                        restoreFullSidebar();
                    }
                }, 300);
            }
        }

        // Apply compact sizing to sidebar for better 100% screen scaling
        function applyCompactSidebarSizing() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;

            // Update logo size to be more compact
            const logo = sidebar.querySelector('img[src*="logo.png"]');
            if (logo) {
                logo.className = 'w-20 sm:w-24 lg:w-28 xl:w-32 h-6 sm:h-8 lg:h-10';
            }

            // Update New Chat button to be more compact
            const newChatBtn = sidebar.querySelector('button[onclick="startNewChat()"]');
            if (newChatBtn) {
                newChatBtn.className = 'w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-8 sm:h-9 lg:h-10 mt-1 mb-1 px-2 flex items-center justify-center gap-1.5 bg-[#05B0FC] text-white text-xs font-bold rounded transition duration-200 ease-in-out hover:bg-blue-600';
            }

            // Update New Chat button image size
            const newChatImg = newChatBtn?.querySelector('img[src*="msg.png"]');
            if (newChatImg) {
                newChatImg.className = 'w-3.5 h-3.5';
            }

            // Update spacing to be more compact
            const buttonContainer = sidebar.querySelector('.flex.flex-col.space-y-2');
            if (buttonContainer) {
                buttonContainer.className = 'flex flex-col space-y-1.5 sm:space-y-2 lg:space-y-3 justify-center items-center mt-2 sm:mt-3 mb-2';
            }

            // Update border line margin
            const borderLine = sidebar.querySelector('.border-t-2.border-gray-300');
            if (borderLine) {
                borderLine.className = 'mt-2 sm:mt-3 border-t-2 border-gray-300 -mx-3 sm:-mx-4';
            }

            // Update header spacing
            const headerContainer = sidebar.querySelector('.flex.justify-between.items-center');
            if (headerContainer) {
                const hideBtn = headerContainer.querySelector('button[onclick="hideSidebar()"]');
                if (hideBtn) {
                    hideBtn.className = 'mt-1 hover:bg-gray-100 p-1 rounded';
                }
            }
        }

        // Set up role-based UI elements
        function setupRoleBasedUI() {
            const viewLessonsLabel = document.getElementById('viewLessonsLabel');
            const lessonGeneratorContent = document.getElementById('lessonGeneratorContent');
            const generateLessonBtn = document.getElementById('generateLessonBtn');
            const generateLessonTopBtn = document.getElementById('generateLessonTopBtn');
            const viewLessonsTitle = document.getElementById('viewLessonsTitle');
            const viewLessonsSubtitle = document.getElementById('viewLessonsSubtitle');


            if (userRole === 'teacher') {
                if (viewLessonsLabel) viewLessonsLabel.textContent = 'My Lessons';
                if (lessonGeneratorContent) lessonGeneratorContent.style.display = '';
                if (generateLessonBtn) generateLessonBtn.style.display = '';
                if (generateLessonTopBtn) generateLessonTopBtn.style.display = '';

            } else if (userRole === 'student') {
                if (viewLessonsLabel) viewLessonsLabel.textContent = 'View Lessons';
                if (lessonGeneratorContent) lessonGeneratorContent.style.display = 'none';
                if (generateLessonBtn) generateLessonBtn.style.display = 'none';
                if (generateLessonTopBtn) generateLessonTopBtn.style.display = 'none';

            }

            // Update lessons display based on role
            if (currentView === 'viewLessons') {
                loadAvailableLessons();
            }
        }

        // Load available lessons based on user role
        async function loadAvailableLessons() {
            try {
                let endpoint = userRole === 'teacher' ? '/api/lessons/my_lessons' : '/api/lessons/browse_lessons';

                const response = await fetch(endpoint, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    availableLessons = data.lessons || [];
                    displayLessonsBasedOnRole();
                } else {
                    console.error('Failed to load lessons');
                    showNotification('Failed to load lessons', 'error');
                }
            } catch (error) {
                console.error('Error loading lessons:', error);
                showNotification('Error loading lessons', 'error');
            }
        }

        // Display lessons based on user role (with pagination and version grouping)
        function displayLessonsBasedOnRole() {
            const lessonsDisplayContainer = document.getElementById('lessonsDisplayContainer');

            // Group lessons by lesson_id first
            const groupedLessons = groupLessonsByLessonId(availableLessons);
            const totalGroups = groupedLessons.length;
            const totalPages = Math.ceil(totalGroups / lessonGroupsPerPage);
            const startIdx = (currentLessonPage - 1) * lessonGroupsPerPage;
            const endIdx = startIdx + lessonGroupsPerPage;
            const groupsToShow = groupedLessons.slice(startIdx, endIdx);

            if (totalGroups === 0) {
                lessonsDisplayContainer.innerHTML = `
                <div class="text-center py-16 text-gray-500">
                    <i class="fas fa-book text-6xl mb-4"></i>
                    <p class="text-xl">No lessons found</p>
                    <p class="text-gray-400">${userRole === 'teacher' ? 'Create your first lesson' : 'No lessons available yet'}</p>
                </div>
            `;
                return;
            }

            let lessonsHtml = '';
            if (userRole === 'teacher') {
                lessonsHtml += `
                <div class="grid grid-cols-7 bg-[#05B0FC] text-white font-semibold py-3 px-4 sticky top-0 z-10 shadow">
                    <div>No</div>
                    <div>Lesson Title</div>
                    <div>Subject</div>
                    <div>Grade</div>
                    <div>Created By</div>
                    <div>Actions</div>
                    <div>Versions</div>
                </div>
            `;

                let rowIndex = 0;
                groupsToShow.forEach((group, groupIndex) => {
                    const mainLesson = group.lessons[0]; // Show the original version (v1) as main
                    // Only show multiple versions if there are actually multiple lessons
                    const hasMultipleVersions = group.lessons.length > 1;
                    // Get subsequent versions (excluding the main/original version)
                    const subsequentVersions = group.lessons.slice(1);

                    // Debug logging for the specific group
                    if (group.title === 'agentic ai1' || group.title === 'reaseach') {
                        console.log(`ðŸ” Teacher section - ${group.title} group:`, {
                            mainLesson: { id: mainLesson.id, version_number: mainLesson.version_number, parent_version_id: mainLesson.parent_version_id },
                            hasMultipleVersions: hasMultipleVersions,
                            subsequentVersions: subsequentVersions.map(l => ({ id: l.id, version_number: l.version_number, parent_version_id: l.parent_version_id })),
                            allLessonsInGroup: group.lessons.map(l => ({ id: l.id, version_number: l.version_number, parent_version_id: l.parent_version_id, title: l.title }))
                        });
                    }

                    lessonsHtml += `
                    <div class="grid grid-cols-7 py-3 px-4 border-b hover:bg-gray-50">
                        <div class="flex items-center">${startIdx + rowIndex + 1}</div>
                        <div class="flex items-center font-medium text-gray-900">
                            ${mainLesson.title}
                        </div>
                        <div class="flex items-center">
                            <span class="px-2 py-1 text-white bg-blue-300 rounded-xl text-xs">${mainLesson.focus_area || ''}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="px-2 py-1 text-blue-800 text-xs">${mainLesson.grade_level || ''}</span>
                        </div>
                        <div class="flex items-center text-gray-700">${userInfo && userInfo.username ? userInfo.username : ''}</div>
                        <div class="flex flex-row gap-1">
                            <button onclick="viewLesson(${mainLesson.id}, '${mainLesson.title}')" class="px-2 py-2 text-green-600 hover:bg-green-50 rounded transition-colors" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${mainLesson.parent_lesson_id && !mainLesson.has_child_version ? `<button onclick="deleteLesson(${mainLesson.id})" class="px-2 py-2 text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                            <button onclick="downloadLessonFile(${mainLesson.id})" class="px-2 py-2 text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Download DOCX">
                                <img src="../static/images/Group69.png" alt="">
                            </button>
                            <button onclick="downloadLessonPPT(${mainLesson.id})" class="px-2 py-2 text-orange-600 hover:bg-orange-50 rounded transition-colors" title="Download PPT">
                                <i class="fas fa-file-powerpoint"></i>
                            </button>
                            <button onclick="viewLessonFAQs(${mainLesson.id}, '${mainLesson.title}')" class="px-2 py-2 text-purple-600 hover:bg-purple-50 rounded transition-colors" title="View FAQs" data-lesson-id="${mainLesson.id}" style="position: relative;">
                                <img src="../static/images/faqs.png" alt="">
                                <span id="faq-count-${mainLesson.id}" style="position: absolute; top: -4px; right: -4px; background: #ef4444; color: #fff; font-size: 10px; line-height: 1; padding: 2px 5px; border-radius: 9999px; min-width: 16px; text-align: center; display: none;"></span>
                            </button>
                        </div>
                        <div class="flex items-center">
                            ${hasMultipleVersions ?
                            `<button onclick="toggleLessonVersions('${group.lesson_id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm" data-version-count="${group.lessons.length}">
                                    <i class="fas fa-chevron-down mr-1"></i>${group.lessons.length}
                                </button>` :
                            `<span class="text-gray-400 text-sm">1</span>`
                        }
                            ${!mainLesson.parent_lesson_id && group.lessons.some(l => l.parent_lesson_id === mainLesson.id) ?
                            `` : ''
                        }
                        </div>
                    </div>
                `;

                    // Add expandable versions section with tree structure
                    if (hasMultipleVersions) {
                        lessonsHtml += `
                        <div id="versions-${group.lesson_id.replace(/[^a-zA-Z0-9]/g, '')}" class="hidden bg-gray-50 border-b">
                            <div class="px-4 py-3">
                                <h4 class="font-semibold text-gray-700 mb-3">Versions</h4>
                                <div class="space-y-2">
                                    ${buildVersionTree(subsequentVersions, 0)}
                                </div>
                            </div>
                        </div>
                    `;
                    }

                    rowIndex++;
                });
            } else {
                lessonsHtml += `
                <div class="grid grid-cols-7 bg-[#05B0FC] text-white font-semibold py-3 px-4 sticky top-0 z-10 shadow">
                    <div>No</div>
                    <div>Lesson Title</div>
                    <div>Subject</div>
                    <div>Grade</div>
                    <div>Created By</div>
                    <div>Actions</div>
                    <div>Versions</div>
                </div>
            `;

                let rowIndex = 0;
                groupsToShow.forEach((group, groupIndex) => {
                    const mainLesson = group.lessons[0]; // Show the original version (v1) as main
                    // Only show multiple versions if there are actually multiple lessons
                    const hasMultipleVersions = group.lessons.length > 1;
                    // Get subsequent versions (excluding the main/original version)
                    const subsequentVersions = group.lessons.slice(1);

                    // Debug logging for the specific group
                    if (group.title === 'agentic ai1' || group.title === 'reaseach') {
                        console.log(`ðŸ” Student section - ${group.title} group:`, {
                            mainLesson: { id: mainLesson.id, version: mainLesson.version, parent_lesson_id: mainLesson.parent_lesson_id },
                            hasMultipleVersions: hasMultipleVersions,
                            subsequentVersions: subsequentVersions.map(l => ({ id: l.id, version: l.version, parent_lesson_id: l.parent_lesson_id })),
                            allLessonsInGroup: group.lessons.map(l => ({ id: l.id, version: l.version, parent_lesson_id: l.parent_lesson_id, title: l.title }))
                        });
                    }

                    lessonsHtml += `
                    <div class="grid grid-cols-7 py-3 px-4 border-b hover:bg-gray-50">
                        <div class="flex items-center">${startIdx + rowIndex + 1}</div>
                        <div class="flex items-center font-medium text-gray-900">
                            ${mainLesson.title}
                        </div>
                        <div class="flex items-center">
                            <span class="px-2 py-1 text-white bg-blue-300 rounded-xl text-xs">${mainLesson.focus_area || ''}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="px-2 py-1 text-blue-800 text-xs">${mainLesson.grade_level || ''}</span>
                        </div>
                        <div class="flex items-center text-gray-700">${mainLesson.teacher_name || ''}</div>
                        <div class="flex flex-row gap-1">
                            <button onclick="viewLesson(${mainLesson.id}, '${mainLesson.title}')" class="px-2 py-2 text-purple-600 hover:bg-purple-50 rounded transition-colors" title="View Lesson">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="flex items-center">
                            ${hasMultipleVersions ?
                            `<button onclick="toggleLessonVersions('${group.lesson_id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm" data-version-count="${group.lessons.length}">
                                    <i class="fas fa-chevron-down mr-1"></i>${group.lessons.length}
                                </button>` :
                            `<span class="text-gray-400 text-sm">1</span>`
                        }
                            ${!mainLesson.parent_lesson_id && group.lessons.some(l => l.parent_lesson_id === mainLesson.id) ?
                            `` : ''
                        }
                        </div>
                    </div>
                `;

                    // Add expandable versions section for students
                    if (hasMultipleVersions) {
                        lessonsHtml += `
                        <div id="versions-${group.lesson_id.replace(/[^a-zA-Z0-9]/g, '')}" class="hidden bg-gray-50 border-b">
                            <div class="px-4 py-3">
                                <h4 class="font-semibold text-gray-700 mb-3">Versions</h4>
                                <div class="space-y-2">
                                    ${subsequentVersions.map((lesson, versionIndex) => `
                                        <div class="grid grid-cols-7 py-2 px-3 bg-white rounded border">
                                            <div class="flex items-center text-sm text-gray-500">v${lesson.version_number || 1}</div>
                                            <div class="flex items-center font-medium text-gray-900 text-sm">
                                                ${lesson.title}
                                            </div>
                                            <div class="flex items-center">
                                                <span class="px-2 py-1 text-white bg-blue-300 rounded-xl text-xs">${lesson.focus_area || ''}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="px-2 py-1 text-blue-800 text-xs">${lesson.grade_level || ''}</span>
                                            </div>
                                            <div class="flex items-center text-gray-700 text-sm">${lesson.teacher_name || ''}</div>
                                            <div class="flex flex-row gap-1">
                                                <button onclick="viewLesson(${lesson.id}, '${lesson.title}')" class="px-2 py-1 text-purple-600 hover:bg-purple-50 rounded transition-colors text-xs" title="View Lesson">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="flex items-center text-xs text-gray-500">
                                                ${new Date(lesson.created_at || lesson.createdAt || Date.now()).toLocaleDateString()}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    }

                    rowIndex++;
                });
            }

            // Pagination controls
            lessonsHtml += `
            <div class="flex justify-center items-center gap-4 mt-6">
                <button onclick="changeLessonPage(-1)" class="px-4 py-2 rounded bg-gray-200 text-gray-700 font-semibold" ${currentLessonPage === 1 ? 'disabled' : ''}>Previous</button>
                <span class="font-medium">Page ${currentLessonPage} of ${totalPages}</span>
                <button onclick="changeLessonPage(1)" class="px-4 py-2 rounded bg-gray-200 text-gray-700 font-semibold" ${currentLessonPage === totalPages ? 'disabled' : ''}>Next</button>
            </div>
        `;

            lessonsDisplayContainer.innerHTML = lessonsHtml;
            // After rendering lessons, populate FAQ badges
            try { initializeFAQBadges(); } catch (e) { console.warn('FAQ badge init failed', e); }
        }

        // Group lessons by title to handle multiple versions
        function groupLessonsByLessonId(lessons) {
            const groups = {};

            lessons.forEach(lesson => {
                // Group lessons by lesson_id - all versions of the same lesson should be grouped together
                let lessonId = lesson.lesson_id || `L${lesson.id.toString().padStart(6, '0')}`; // Fallback for old lessons

                if (!groups[lessonId]) {
                    groups[lessonId] = {
                        lesson_id: lessonId,
                        title: lesson.title,
                        lessons: []
                    };
                }
                groups[lessonId].lessons.push(lesson);
            });

            // Sort lessons within each group: by version_number
            Object.values(groups).forEach(group => {
                // Remove duplicates based on version_number and keep the one with the latest created_at
                const uniqueLessons = {};
                group.lessons.forEach(lesson => {
                    const versionKey = lesson.version_number || 1;
                    if (!uniqueLessons[versionKey] ||
                        new Date(lesson.created_at || lesson.createdAt || 0) >
                        new Date(uniqueLessons[versionKey].created_at || uniqueLessons[versionKey].createdAt || 0)) {
                        uniqueLessons[versionKey] = lesson;
                    }
                });

                // Convert back to array and sort
                group.lessons = Object.values(uniqueLessons).sort((a, b) => {
                    return (a.version_number || 1) - (b.version_number || 1);
                });

                // Debug logging for groups with multiple versions
                if (group.lessons.length > 1) {
                    console.log(`ðŸ” Group "${group.title}" (${group.lesson_id}) after deduplication and sorting:`, group.lessons.map(l => ({
                        id: l.id,
                        title: l.title,
                        version_number: l.version_number,
                        parent_version_id: l.parent_version_id
                    })));
                }
            });

            // Only group lessons that actually have multiple versions
            return Object.values(groups).map(group => {
                // If there's only one lesson, don't group
                if (group.lessons.length === 1) {
                    return group.lessons.map(lesson => ({
                        lesson_id: lesson.lesson_id || `L${lesson.id.toString().padStart(6, '0')}`,
                        title: lesson.title,
                        lessons: [lesson]
                    }));
                }
                return group;
            }).flat();
        }

        // Build version tree structure
        function buildVersionTree(versions, depth = 0, processedIds = new Set()) {
            if (!versions || versions.length === 0) return '';

            return versions.map(lesson => {
                // Skip if we've already processed this lesson ID
                if (processedIds.has(lesson.id)) {
                    return '';
                }
                processedIds.add(lesson.id);

                const indent = '  '.repeat(depth); // Visual indentation (no CSS margin from ml- classes)
                const isChild = lesson.parent_version_id !== null;
                const childVersions = versions.filter(v => v.parent_version_id === lesson.id && !processedIds.has(v.id));
                const locked = lesson.has_child_version === true;

                let html = `
                <div class="grid grid-cols-7 py-2 px-3 bg-white rounded border" style="margin-left: 0px;">
                    <div class="flex items-center text-sm text-gray-500">
                        v${lesson.version_number || 1}
                    </div>
                    <div class="flex items-center font-medium text-gray-900 text-sm">
                        ${lesson.title}
                    </div>
                    <div class="flex items-center">
                        <span class="px-2 py-1 text-white bg-blue-300 rounded-xl text-xs">${lesson.focus_area || ''}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="px-2 py-1 text-blue-800 text-xs">${lesson.grade_level || ''}</span>
                    </div>
                    <div class="flex items-center text-gray-700 text-sm">${userInfo && userInfo.username ? userInfo.username : ''}</div>
                    <div class="flex flex-row gap-1">
                        <button onclick="viewLesson(${lesson.id}, '${lesson.title}')" class="px-2 py-1 text-green-600 hover:bg-green-50 rounded transition-colors text-xs" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${!lesson.has_child_version ? `<button onclick="deleteLesson(${lesson.id})" class="px-2 py-1 text-red-600 hover:bg-red-50 rounded transition-colors text-xs" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                        <button onclick="downloadLessonFile(${lesson.id})" class="px-2 py-1 text-blue-600 hover:bg-blue-50 rounded transition-colors text-xs" title="Download DOCX">
                            <img src="../static/images/Group69.png" alt="" class="w-4 h-4">
                        </button>
                        <button onclick="downloadLessonPPT(${lesson.id})" class="px-2 py-1 text-orange-600 hover:bg-orange-50 rounded transition-colors text-xs" title="Download PPT">
                            <i class="fas fa-file-powerpoint"></i>
                        </button>
                        <button onclick="viewLessonFAQs(${lesson.id}, '${lesson.title}')" class="px-2 py-1 text-purple-600 hover:bg-purple-50 rounded transition-colors text-xs" title="View FAQs" data-lesson-id="${lesson.id}" style="position: relative;">
                            <img src="../static/images/faqs.png" alt="" class="w-4 h-4">
                            <span id="faq-count-${lesson.id}" style="position: absolute; top: -4px; right: -4px; background: #ef4444; color: #fff; font-size: 9px; line-height: 1; padding: 2px 4px; border-radius: 9999px; min-width: 14px; text-align: center; display: none;"></span>
                        </button>
                    </div>
                    <div class="flex items-center text-xs text-gray-500">
                        ${new Date(lesson.created_at || lesson.createdAt || Date.now()).toLocaleDateString()}
                    </div>
                </div>
            `;

                // Recursively add child versions
                if (childVersions.length > 0) {
                    html += buildVersionTree(childVersions, depth + 1, processedIds);
                }

                return html;
            }).join('');
        }

        // Toggle lesson versions expand/collapse
        function toggleLessonVersions(lessonId) {
            const sanitizedId = lessonId.replace(/[^a-zA-Z0-9]/g, '');
            const versionsDiv = document.getElementById(`versions-${sanitizedId}`);
            const button = event.target.closest('button');

            if (versionsDiv) {
                const isHidden = versionsDiv.classList.contains('hidden');

                // Extract the version count from the button's data attribute or text content
                let versionCount = button.getAttribute('data-version-count');
                if (!versionCount) {
                    // Fallback: extract from text content using regex
                    const match = button.textContent.match(/(\d+)\s+versions?/);
                    versionCount = match ? match[1] : '1';
                    button.setAttribute('data-version-count', versionCount);
                }

                if (isHidden) {
                    versionsDiv.classList.remove('hidden');
                    button.innerHTML = `<i class="fas fa-chevron-up mr-1"></i>${versionCount}`;
                    button.classList.add('bg-blue-200');
                } else {
                    versionsDiv.classList.add('hidden');
                    button.innerHTML = `<i class="fas fa-chevron-down mr-1"></i>${versionCount}`;
                    button.classList.remove('bg-blue-200');
                }
            }
        }

        function changeLessonPage(delta) {
            const groupedLessons = groupLessonsByLessonId(availableLessons);
            const totalPages = Math.ceil(groupedLessons.length / lessonGroupsPerPage);
            currentLessonPage += delta;
            if (currentLessonPage < 1) currentLessonPage = 1;
            if (currentLessonPage > totalPages) currentLessonPage = totalPages;
            displayLessonsBasedOnRole();
        }

        // Reset to page 1 on new search or browse
        async function loadAvailableLessons() {
            currentLessonPage = 1;
            try {
                let endpoint = userRole === 'teacher' ? '/api/lessons/my_lessons' : '/api/lessons/browse_lessons';

                const response = await fetch(endpoint, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    availableLessons = data.lessons || [];

                    // Debug logging
                    console.log('ðŸ” Raw lessons from backend:', availableLessons);
                    console.log('ðŸ” Lessons with same title "agentic ai1":',
                        availableLessons.filter(l => l.title === 'agentic ai1'));
                    console.log('ðŸ” Lessons with same title "reaseach":',
                        availableLessons.filter(l => l.title === 'reaseach'));

                    displayLessonsBasedOnRole();
                } else {
                    console.error('Failed to load lessons');
                    showNotification('Failed to load lessons', 'error');
                }
            } catch (error) {
                console.error('Error loading lessons:', error);
                showNotification('Error loading lessons', 'error');
            }
        }

        // Teacher-specific lesson management functions
        function editLesson(lessonId) {
            const lesson = availableLessons.find(l => l.id === lessonId);
            if (lesson) {
                openEditLessonModal(lesson);
            }
        }

        function openEditLessonModal(lesson) {
            document.getElementById('editLessonTitle').value = lesson.title || '';
            document.getElementById('editLessonSummary').value = lesson.summary || '';
            document.getElementById('editLessonContent').value = lesson.content || '';
            document.getElementById('editLessonFocusArea').value = lesson.focus_area || lesson.focusArea || '';
            document.getElementById('editLessonGradeLevel').value = lesson.grade_level || lesson.gradeLevel || '';
            document.getElementById('editLessonModal').classList.remove('hidden');
            window.currentEditLessonId = lesson.id;
        }

        function closeEditLessonModal() {
            document.getElementById('editLessonModal').classList.add('hidden');
            window.currentEditLessonId = null;
        }

        async function saveLessonEdits() {
            const lessonId = window.currentEditLessonId;
            const updatedLesson = {
                title: document.getElementById('editLessonTitle').value,
                summary: document.getElementById('editLessonSummary').value,
                content: document.getElementById('editLessonContent').value,
                focus_area: document.getElementById('editLessonFocusArea').value,
                grade_level: document.getElementById('editLessonGradeLevel').value
                // Add other fields as needed
            };
            try {
                const response = await fetch(`/api/lessons/lesson/${lessonId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updatedLesson)
                });
                if (response.ok) {
                    showNotification('Lesson updated!', 'success');
                    loadAvailableLessons();
                    closeEditLessonModal();
                } else {
                    showNotification('Failed to update lesson.', 'error');
                }
            } catch (error) {
                showNotification('Error updating lesson.', 'error');
            }
        }

        // Update deleteLesson to always refresh the list
        async function deleteLesson(lessonId) {
            const lesson = availableLessons.find(l => l.id === lessonId);
            if (lesson && confirm(`Are you sure you want to delete "${lesson.title}"?`)) {
                try {
                    const response = await fetch(`/api/lessons/lesson/${lessonId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (response.ok) {
                        showNotification(`"${lesson.title}" deleted successfully`, 'success');

                        // If this was a version (has parent_lesson_id), we need to reset the version creation status
                        if (lesson.parent_lesson_id) {
                            try {
                                // Call API to reset version creation status for the parent lesson
                                await fetch(`/api/lessons/lesson/${lesson.parent_lesson_id}/reset_version_status`, {
                                    method: 'POST',
                                    credentials: 'include'
                                });
                            } catch (error) {
                                console.log('Note: Version status reset API not available yet');
                            }
                        }

                        loadAvailableLessons(); // Refresh the lessons list
                    } else {
                        showNotification('Failed to delete lesson', 'error');
                    }
                } catch (error) {
                    showNotification('Error deleting lesson', 'error');
                }
            }
        }

        // Add a reusable function to render FAQ tables
        function renderFAQTable(faqs) {
            const tableContainer = document.getElementById('mostFrequentQuestionsTable');
            if (!faqs || faqs.length === 0) {
                tableContainer.innerHTML = `
                <div class="text-center py-16 text-gray-500">
                    <i class="fas fa-question-circle text-6xl mb-4"></i>
                    <p class="text-xl">No student questions found</p>
                    <p class="text-gray-400">No FAQs available for this lesson version</p>
                </div>
            `;
                return;
            }
            // Table header (5 columns to include version info)
            let header = `
            <div class="grid grid-cols-5 bg-[#05B0FC] text-white font-semibold py-4 px-6 rounded-t-lg">
                <div>Lesson Title & Version</div>
                <div>Student Question</div>
                <div>Times Asked</div>
                <div>Subject & Grade</div>
                <div>Question Type</div>
            </div>
        `;
            // Table rows (5 columns)
            let rows = faqs.map(faq => {
                // Determine version badge styling
                let versionBadge = '';
                if (faq.is_version) {
                    versionBadge = `<span class="ml-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">v${faq.version}</span>`;
                } else {
                    versionBadge = `<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Original</span>`;
                }

                return `
                <div class="grid grid-cols-5 py-4 px-6 hover:bg-gray-50 transition-colors">
                <div class="flex items-center">
                    <span class="font-medium text-gray-900">${faq.lessonTitle || ''}</span>
                        ${versionBadge}
                </div>
                <div class="flex items-center">
                    <span class="text-gray-700">${faq.question}</span>
                </div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-[#05B0FC] text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                        ${faq.times_asked || faq.count || 1}
                    </div>
                    <span class="text-gray-600 ml-2">${faq.time_ago || 'Recently'}</span>
                </div>
                <div class="flex items-center">
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm mr-2">${faq.subject || ''}</span>
                    <span class="text-gray-600">${faq.grade || ''}</span>
                </div>
                    <div class="flex items-center">
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                            <i class="fas fa-user-graduate mr-1"></i>Student Question
                        </span>
            </div>
                </div>
            `;
            }).join('');
            tableContainer.innerHTML = header + rows;
        }

        // Add a function to render FAQ table HTML for the dashboard
        function renderFAQTableHTML(faqs) {
            if (!faqs || faqs.length === 0) {
                return `
                <div class="text-center py-16 text-gray-500">
                    <i class="fas fa-question-circle text-6xl mb-4"></i>
                    <p class="text-xl">No student questions found</p>
                    <p class="text-gray-400">No FAQs available</p>
                </div>
            `;
            }
            // Table header (5 columns to include version info)
            let header = `
            <div class="grid grid-cols-5 bg-[#05B0FC] text-white font-semibold py-4 px-6 rounded-t-lg">
                <div>Lesson Title & Version</div>
                <div>Student Question</div>
                <div>Times Asked</div>
                <div>Subject & Grade</div>
                <div>Question Type</div>
            </div>
        `;
            // Table rows (5 columns)
            let rows = faqs.map(faq => {
                // Determine version badge styling
                let versionBadge = '';
                if (faq.is_version) {
                    versionBadge = `<span class="ml-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">v${faq.version}</span>`;
                } else {
                    versionBadge = `<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Original</span>`;
                }

                return `
                <div class="grid grid-cols-5 py-4 px-6 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center">
                        <span class="font-medium text-gray-900">${faq.lessonTitle || ''}</span>
                        ${versionBadge}
                    </div>
                    <div class="flex items-center">
                        <span class="text-gray-700">${faq.question}</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-[#05B0FC] text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                            ${faq.times_asked || faq.count || 1}
                        </div>
                        <span class="text-gray-700 ml-2">${faq.time_ago || 'Recently'}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm mr-2">${faq.subject || ''}</span>
                        <span class="text-gray-600">${faq.grade || ''}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                            <i class="fas fa-user-graduate mr-1"></i>Student Question
                        </span>
                    </div>
                </div>
            `;
            }).join('');
            return header + rows;
        }



        // View FAQs for a specific lesson version
        async function viewLessonFAQs(lessonId, lessonTitle) {
            try {
                console.log(`ðŸ” viewLessonFAQs called with lessonId: ${lessonId}, lessonTitle: ${lessonTitle}`);

                // Show loading notification (non-blocking)
                showNotification(`Loading FAQs for "${lessonTitle}"...`, 'info');

                // Update modal title and prefill content with a loading skeleton (prevents flicker)
                document.getElementById('faqModalTitle').textContent = `FAQs - ${lessonTitle}`;
                const faqContentEl = document.getElementById('faqModalContent');
                if (faqContentEl) {
                    faqContentEl.innerHTML = `
                    <div class="py-10 text-center">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-50">
                            <i class="fas fa-spinner fa-spin text-[#05B0FC]"></i>
                        </div>
                        <p class="mt-4 text-gray-600">Loading FAQs...</p>
                    </div>
                `;
                }

                // Show modal after content placeholder is set
                document.getElementById('faqModal').classList.remove('hidden');

                const response = await fetch(`/api/lessons/faqs/${lessonId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`ðŸ” API response data:`, data);
                    let faqs = data.faqs || [];
                    console.log(`ðŸ” FAQs found: ${faqs.length}`);

                    // If no FAQs found for this specific lesson
                    if (faqs.length === 0) {
                        showNotification(`No student questions found for "${lessonTitle}"`, 'info');
                        document.getElementById('faqModalContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-question-circle text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Questions Yet</h3>
                            <p class="text-gray-600 mb-4">No student questions have been asked for this lesson version yet.</p>
                            <p class="text-sm text-blue-600 bg-blue-50 px-4 py-2 rounded-lg inline-block">
                                <i class="fas fa-info-circle mr-2"></i>
                                This could indicate that the lesson is new or students haven't encountered any difficulties yet.
                            </p>
                        </div>
                    `;
                        return;
                    }

                    // If subject/grade missing, fetch lesson info
                    let subject = '';
                    let grade = '';
                    if (faqs.length > 0) {
                        subject = faqs[0].subject || '';
                        grade = faqs[0].grade || '';
                    }
                    // If still missing, fetch lesson details
                    if (!subject || !grade) {
                        const lessonResp = await fetch(`/api/lessons/lesson/${lessonId}`, {
                            method: 'GET',
                            credentials: 'include'
                        });
                        if (lessonResp.ok) {
                            const lessonData = await lessonResp.json();
                            subject = lessonData.lesson?.focus_area || '';
                            grade = lessonData.lesson?.grade_level || '';
                        }
                    }
                    // Fill every FAQ row with lessonTitle, subject, and grade
                    faqs = faqs.map(faq => ({
                        ...faq,
                        lessonTitle: faq.lessonTitle || lessonTitle || '',
                        subject: faq.subject || subject,
                        grade: faq.grade || grade
                    }));

                    // Render FAQ content in modal
                    renderFAQModalContent(faqs, lessonTitle);

                    // Show success notification
                    showNotification(`Loaded ${faqs.length} student questions for "${lessonTitle}"`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.error || 'Unknown error';
                    console.error(`âŒ API error: ${errorMsg}`);
                    showNotification(`Failed to load FAQs: ${errorMsg}`, 'error');

                    document.getElementById('faqModalContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Error Loading FAQs</h3>
                        <p class="text-gray-600 mb-4">Unable to load questions due to an error. Please try again later.</p>
                        <p class="text-sm text-red-600 bg-red-50 px-4 py-2 rounded-lg inline-block">
                            <i class="fas fa-info-circle mr-2"></i>
                            ${errorMsg}
                        </p>
                    </div>
                `;
                }
            } catch (error) {
                console.error('âŒ JavaScript error in viewLessonFAQs:', error);
                showNotification('Error loading lesson FAQs. Please try again.', 'error');

                document.getElementById('faqModalContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Unexpected Error</h3>
                    <p class="text-gray-600 mb-4">An unexpected error occurred. Please try again later.</p>
                    <p class="text-sm text-red-600 bg-red-50 px-4 py-2 rounded-lg inline-block">
                        <i class="fas fa-info-circle mr-2"></i>
                        Please refresh the page and try again.
                    </p>
                </div>
            `;
            }
        }

        // Render FAQ content in modal
        function renderFAQModalContent(faqs, lessonTitle) {
            const modalContent = document.getElementById('faqModalContent');

            if (faqs.length === 0) {
                modalContent.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-question-circle text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No Questions Yet</h3>
                    <p class="text-gray-600 mb-4">No student questions have been asked for this lesson version yet.</p>
                </div>
            `;
                return;
            }

            // Create FAQ table
            const tableHTML = `
            <div class="mb-4">
                <div class="text-center mb-4">
                    <p class="text-gray-600 mb-2">Viewing <strong>${faqs.length} real student questions</strong> asked for this specific lesson version.</p>
                    <p class="text-sm text-blue-600 bg-blue-50 px-3 py-2 rounded-lg inline-block">
                        <i class="fas fa-users mr-2"></i>
                        These are actual questions asked by students, not AI-generated content
                    </p>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden overflow-x-auto">
                <div class="divide-y divide-gray-200 min-w-full">
                    ${faqs.map((faq, index) => `
                        <div class="py-3 px-4 hover:bg-gray-50 transition-colors">
                            <div class="grid grid-cols-12 gap-2">
                                <div class="col-span-1 flex items-center text-sm text-gray-500">${index + 1}</div>
                                <div class="col-span-6 flex items-center font-medium text-gray-900 text-sm">
                                    ${faq.question}
                                    ${faq.is_version ? `<span class="ml-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">v${faq.version}</span>` : `<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Original</span>`}
                                </div>
                                <div class="col-span-2 flex items-center">
                                    <span class="px-2 py-1 text-white bg-blue-300 rounded-xl text-xs">${faq.subject || ''}</span>
                                </div>
                                <div class="col-span-2 flex items-center">
                                    <span class="px-2 py-1 text-blue-800 text-xs">${faq.grade || ''}</span>
                                </div>
                                <div class="col-span-1 flex items-center justify-center">
                                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-semibold">${faq.count}</span>
                                </div>
                            </div>
                            ${faq.answer ? `
                                <div class="mt-2 ml-8 mr-2 p-3 bg-gray-50 rounded border border-gray-200">
                                    <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Latest Answer</div>
                                    <div class="text-sm text-gray-800 whitespace-pre-wrap">${faq.answer}</div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

            modalContent.innerHTML = tableHTML;
        }

        // Close FAQ modal
        function closeFaqModal() {
            document.getElementById('faqModal').classList.add('hidden');
            document.getElementById('faqModalContent').innerHTML = '';
        }

        // Close modal when clicking outside of it
        document.addEventListener('click', function (event) {
            const faqModal = document.getElementById('faqModal');
            const apiKeyModal = document.getElementById('apiKeyModal');
            if (event.target === faqModal) {
                closeFaqModal();
            }
            if (event.target === apiKeyModal) {
                closeApiKeyModal();
            }
        });

        // API Key Modal Functions
        function openApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            document.getElementById('apiKeyModalInput').value = '';
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('hidden');
            document.getElementById('apiKeyModalInput').value = '';
        }

        function toggleApiKeyModalVisibility() {
            const input = document.getElementById('apiKeyModalInput');
            const icon = document.getElementById('apiKeyModalToggleIcon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function clearApiKeyModal() {
            document.getElementById('apiKeyModalInput').value = '';
            showNotification('API key field cleared', 'info');
        }

        async function saveApiKeyModal() {
            const apiKeyInput = document.getElementById('apiKeyModalInput');
            const saveBtn = document.getElementById('saveApiKeyModalBtn');
            const newApiKey = apiKeyInput.value.trim();

            if (!newApiKey) {
                showNotification('Please enter an API key', 'error');
                return;
            }

            // Show loading state
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            try {
                const response = await fetch('/update_api_key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: newApiKey }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('API key updated successfully', 'success');
                        closeApiKeyModal();
                    } else {
                        showNotification(data.error || 'Failed to update API key', 'error');
                    }
                } else {
                    const errorData = await response.json();
                    showNotification(errorData.error || 'Failed to update API key', 'error');
                }
            } catch (error) {
                console.error('Error updating API key:', error);
                showNotification('Error updating API key', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function backToLessons() {
            // Reset FAQ view to default state
            const faqViewTitle = document.getElementById('faqViewTitle');
            const faqViewDescription = document.getElementById('faqViewDescription');
            if (faqViewTitle) {
                faqViewTitle.textContent = 'Most Frequent Questions';
            }
            if (faqViewDescription) {
                faqViewDescription.textContent = 'View the most commonly asked questions by students in your lessons. This helps you identify knowledge gaps and improve engagement.';
            }

            openViewLessons();
        }

        function exportAllFAQReport() {
            // Download the FAQ dashboard as a Word document
            fetch('/api/lessons/export_faq_dashboard', {
                method: 'GET',
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to export FAQ dashboard');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'faq_dashboard_export.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    showNotification('FAQ dashboard exported successfully!', 'success');
                })
                .catch(error => {
                    showNotification('Error exporting FAQ dashboard', 'error');
                });
        }

        // Show frequently asked questions dashboard to teachers




        // Open lesson generator from sidebar
        function openLessonGenerator() {
            if (userRole !== 'teacher') {
                showNotification('Only teachers can create lessons', 'error');
                return;
            }
            // Stop any ongoing speech when switching to Lesson Generator
            if (typeof stopSpeech === 'function') {
                stopSpeech();
            }

            // Debug logging
            console.log('DEBUG: openLessonGenerator - currentLessonData:', currentLessonData);
            console.log('DEBUG: openLessonGenerator - generatedLessonContent:', generatedLessonContent);
            console.log('DEBUG: openLessonGenerator - currentLessonData?.content:', currentLessonData?.content);
            console.log('DEBUG: openLessonGenerator - currentLessonData?.isFinalized:', currentLessonData?.isFinalized);

            // Check if there's generated lesson content to show
            if ((generatedLessonContent && generatedLessonContent.trim()) ||
                (currentLessonData && currentLessonData.content && currentLessonData.content.trim())) {
                // Show the generated lesson content if it exists
                console.log('DEBUG: Showing generated lesson');
                showGeneratedLesson();
            } else if (currentLessonData && !currentLessonData.isFinalized) {
                // Restore unfinished lesson state (for lessons in progress without content)
                console.log('DEBUG: Restoring unfinished lesson');
                restoreUnfinishedLesson();
            } else {
                // Start fresh lesson generation
                console.log('DEBUG: Starting fresh lesson generation');
                resetLessonGenerator();
            }

            // Hide all content areas
            hideAllContentAreas();

            // Hide download button for non-chat views
            const downloadBtn = document.getElementById('chatDownloadBtn');
            if (downloadBtn) {
                downloadBtn.classList.add('hidden');
            }

            // Show lesson generator content
            document.getElementById('lessonGeneratorContent').classList.remove('hidden');
            currentView = 'lesson';

            // Show the new single form step
            document.getElementById('lessonFormStep').classList.remove('hidden');

            // Hide chat input area
            const chatInputArea = document.getElementById('chatInputArea');
            if (chatInputArea) {
                chatInputArea.classList.add('hidden');
            }

            // Initialize drag and drop functionality
            setupLessonDropZone();

            // Update chat header
            document.getElementById('chatTitle').textContent = 'Lesson Generator';
            document.getElementById('chatStatus').textContent = currentLessonData && !currentLessonData.isFinalized ? 'Continue Lesson Creation' : 'Create New Lesson';
        }

        // Restore unfinished lesson state
        function restoreUnfinishedLesson() {
            if (!currentLessonData) return;

            // Show the lesson display step with existing content
            showLessonStep('display');

            // Restore lesson content
            const lessonSummary = document.getElementById('lessonSummary');
            if (lessonSummary && currentLessonData.content) {
                const formattedContent = formatLessonContentWithoutNumbers(currentLessonData.content);
                lessonSummary.innerHTML = formattedContent;
            }

            // Restore additional notes if they exist
            if (currentLessonData.additionalNotes) {
                const additionalNotesDisplay = document.getElementById('additionalNotesDisplay');
                const displayAdditionalNotes = document.getElementById('displayAdditionalNotes');
                if (additionalNotesDisplay && displayAdditionalNotes) {
                    displayAdditionalNotes.textContent = currentLessonData.additionalNotes;
                    additionalNotesDisplay.classList.remove('hidden');
                }
            }

            // Show notification about restored lesson
            showNotification('Unfinished lesson restored. You can continue editing or finalize it.', 'info');
        }

        // Show generated lesson content without the form
        function showGeneratedLesson() {
            // Hide all content areas
            hideAllContentAreas();

            // Hide download button for non-chat views
            const downloadBtn = document.getElementById('chatDownloadBtn');
            if (downloadBtn) {
                downloadBtn.classList.add('hidden');
            }

            // Show lesson generator content
            document.getElementById('lessonGeneratorContent').classList.remove('hidden');
            currentView = 'lessonGenerator';

            // Hide chat input area
            const chatInputArea = document.getElementById('chatInputArea');
            if (chatInputArea) {
                chatInputArea.classList.add('hidden');
            }

            // Update chat header
            document.getElementById('chatTitle').textContent = 'Lesson Generator';
            document.getElementById('chatStatus').textContent = 'Generated Lesson';

            // Hide the form and show the lesson display
            document.getElementById('lessonFormStep').classList.add('hidden');
            document.getElementById('lessonDisplayArea').classList.remove('hidden');

            // Display the generated lesson content
            const lessonSummary = document.getElementById('lessonSummary');
            const contentToShow = generatedLessonContent || (currentLessonData && currentLessonData.content) || '';

            // Update generatedLessonContent if we got content from currentLessonData
            if (!generatedLessonContent && currentLessonData && currentLessonData.content) {
                generatedLessonContent = currentLessonData.content;
            }

            if (lessonSummary && contentToShow) {
                const formattedContent = formatLessonContentWithoutNumbers(contentToShow);
                lessonSummary.innerHTML = formattedContent;
            }

            // Show the review buttons
            const defaultButtons = document.getElementById('defaultReviewButtons');
            if (defaultButtons) {
                defaultButtons.classList.remove('hidden');
            }

            // Show finalize and new lesson buttons
            const finalizeNewLessonButtons = document.getElementById('finalizeNewLessonButtons');
            if (finalizeNewLessonButtons) {
                finalizeNewLessonButtons.classList.remove('hidden');
            }
        }

        // Reset lesson generator to fresh state
        function resetLessonGenerator() {
            // Clear lesson completion page and reset state
            document.getElementById('lessonCompletionPage').classList.add('hidden');
            document.getElementById('completedLessonTitle').textContent = 'Sample Lesson from document.pdf';

            // Reset lesson state (but preserve file if it exists)
            // currentLessonFile = null; // Don't clear the file - preserve it for tab switching
            currentLessonData = null;
            generatedLessonContent = '';
            window.editingLessonId = null;

            // Clear lesson display content
            const lessonSummary = document.getElementById('lessonSummary');
            if (lessonSummary) {
                lessonSummary.innerHTML = '';
            }

            // Reset inline editing elements
            const inlineEditTextarea = document.getElementById('inlineEditTextarea');
            const inlineAIPromptContainer = document.getElementById('inlineAIPromptContainer');
            const inlineEditButtons = document.getElementById('inlineEditButtons');
            const inlineAIButtons = document.getElementById('inlineAIButtons');
            const defaultButtons = document.getElementById('defaultReviewButtons');

            if (inlineEditTextarea) {
                inlineEditTextarea.classList.add('hidden');
                inlineEditTextarea.value = '';
            }
            if (inlineAIPromptContainer) {
                inlineAIPromptContainer.classList.add('hidden');
            }
            if (inlineEditButtons) {
                inlineEditButtons.classList.add('hidden');
            }
            if (inlineAIButtons) {
                inlineAIButtons.classList.add('hidden');
            }
            if (defaultButtons) {
                defaultButtons.classList.add('hidden');
            }

            // Hide finalize and new lesson buttons
            const finalizeNewLessonButtons = document.getElementById('finalizeNewLessonButtons');
            if (finalizeNewLessonButtons) {
                finalizeNewLessonButtons.classList.add('hidden');
            }

            const inlineAIPrompt = document.getElementById('inlineAIPrompt');
            if (inlineAIPrompt) {
                inlineAIPrompt.value = '';
            }

            // Clear review interfaces
            document.getElementById('humanReviewInterface').classList.add('hidden');
            document.getElementById('aiReviewInterface').classList.add('hidden');

            // Clear review content
            const humanReviewContent = document.getElementById('humanReviewContent');
            if (humanReviewContent) {
                humanReviewContent.value = '';
            }

            const aiReviewPrompt = document.getElementById('aiReviewPrompt');
            if (aiReviewPrompt) {
                aiReviewPrompt.value = '';
            }

            const currentLessonPreview = document.getElementById('currentLessonPreview');
            if (currentLessonPreview) {
                currentLessonPreview.textContent = '';
            }

            // Reset button states
            const generateBtn = document.getElementById('generateLessonFormBtn');
            const generateBtnText = document.getElementById('generateBtnText');

            if (generateBtn) generateBtn.disabled = false;
            if (generateBtnText) generateBtnText.textContent = 'Generate Lesson';

            // Reset loading icon
            const loadingIcon = generateBtn?.querySelector('i');
            if (loadingIcon) {
                loadingIcon.className = 'fas fa-magic mr-2';
            }

            // Show the single form step
            document.getElementById('lessonFormStep').classList.remove('hidden');

            // Hide the lesson display area to show only the form
            const lessonDisplayArea = document.getElementById('lessonDisplayArea');
            if (lessonDisplayArea) {
                lessonDisplayArea.classList.add('hidden');
            }

            // Clear the form
            clearForm();

            // Restore file display if a file was previously selected
            restoreFileDisplay();
        }

        // Restore file display when returning to lesson generator
        function restoreFileDisplay() {
            if (currentLessonFile) {
                const fileNameDisplay = document.getElementById('selectedFileName');
                const proceedBtn = document.getElementById('proceedBtn');

                if (fileNameDisplay && proceedBtn) {
                    fileNameDisplay.querySelector('span').textContent = currentLessonFile.name;
                    fileNameDisplay.classList.remove('hidden');
                    proceedBtn.disabled = false;

                    // Show notification that file is still available
                    showNotification('Your uploaded file is still available. You can proceed to lesson configuration.', 'info');
                }
            }
        }

        // Open view lessons from sidebar
        function openViewLessons() {
            // Stop any ongoing speech when switching to View Lessons
            if (typeof stopSpeech === 'function') {
                stopSpeech();
            }
            // Hide all content areas
            hideAllContentAreas();

            // Hide download button for non-chat views
            const downloadBtn = document.getElementById('chatDownloadBtn');
            if (downloadBtn) {
                downloadBtn.classList.add('hidden');
            }

            // Show view lessons content
            document.getElementById('viewLessonsContent').classList.remove('hidden');
            currentView = 'viewLessons';

            // Hide chat input area
            const chatInputArea = document.getElementById('chatInputArea');
            if (chatInputArea) {
                chatInputArea.classList.add('hidden');
            }

            // Update chat header
            document.getElementById('chatTitle').textContent = userRole === 'teacher' ? 'My Lessons' : 'Browse Lessons';
            document.getElementById('chatStatus').textContent = 'View Available Lessons';

            // Load lessons
            loadAvailableLessons();
        }

        // Hide all content areas
        function hideAllContentAreas() {
            // Ensure any speech playback is cancelled when switching sections
            if (typeof stopSpeech === 'function') {
                stopSpeech();
            }
            document.getElementById('chatMessages').classList.add('hidden');
            document.getElementById('lessonGeneratorContent').classList.add('hidden');
            document.getElementById('viewLessonsContent').classList.add('hidden');
            document.getElementById('settingsContent').classList.add('hidden');
            document.getElementById('faqDashboard').classList.add('hidden');
            document.getElementById('mostFrequentQuestionsView').classList.add('hidden');
        }

        // Show specific lesson generation step
        function showLessonStep(step) {
            // Hide all content areas first
            const elementsToHide = [
                'lessonFormStep',
                'lessonDisplay',
                'humanReviewInterface',
                'aiReviewInterface'
            ];

            elementsToHide.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });

            // Show the requested step
            if (step === 'upload' || step === 'config') {
                // For upload or config, show the single form step
                const formStep = document.getElementById('lessonFormStep');
                if (formStep) {
                    formStep.classList.remove('hidden');
                }
            } else if (step === 'display') {
                const displayStep = document.getElementById('lessonDisplay');
                if (displayStep) {
                    displayStep.classList.remove('hidden');
                }
            } else if (step === 'humanReview') {
                const humanReview = document.getElementById('humanReviewInterface');
                if (humanReview) {
                    humanReview.classList.remove('hidden');

                    // Populate and auto-resize the human review textarea
                    const humanReviewContent = document.getElementById('humanReviewContent');
                    if (humanReviewContent) {
                        const content = generatedLessonContent || (currentLessonData && currentLessonData.content) || '';
                        humanReviewContent.value = content;
                        autoResizeTextarea(humanReviewContent);

                        // Add input event listener for dynamic resizing
                        humanReviewContent.addEventListener('input', function () {
                            autoResizeTextarea(this);
                        });
                    }
                }
            } else if (step === 'aiReview') {
                const aiReview = document.getElementById('aiReviewInterface');
                if (aiReview) {
                    aiReview.classList.remove('hidden');

                    // Populate and auto-resize the AI review textarea
                    const aiReviewPrompt = document.getElementById('aiReviewPrompt');
                    if (aiReviewPrompt) {
                        autoResizeTextarea(aiReviewPrompt);

                        // Add input event listener for dynamic resizing
                        aiReviewPrompt.addEventListener('input', function () {
                            autoResizeTextarea(this);
                        });
                    }
                }
            }
        }

        // Lesson Generator Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('File size should be less than 10 MB', 'error');
                    return;
                }

                currentLessonFile = file;
                const fileNameDisplay = document.getElementById('selectedFileName');
                fileNameDisplay.querySelector('span').textContent = file.name;
                fileNameDisplay.classList.remove('hidden');
                showNotification('File uploaded successfully! You can now fill in the lesson details.', 'success');
            }
        }

        function removeSelectedFile() {
            document.getElementById('selectedFileName').classList.add('hidden');
            document.getElementById('lessonFileInput').value = '';
            currentLessonFile = null;
            showNotification('File removed successfully', 'info');
        }

        // Drag and Drop functionality for lesson upload
        function setupLessonDropZone() {
            const dropZone = document.getElementById('lessonDropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            }

            function unhighlight(e) {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            }

            dropZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    const fileInput = document.getElementById('lessonFileInput');
                    fileInput.files = files;
                    handleFileSelect({ target: fileInput });
                }
            }
        }


        // Function to start a completely new lesson (clears everything including file)
        function startNewLesson() {
            // Clear generated content
            generatedLessonContent = '';

            // Clear uploaded file using the dedicated function
            clearUploadedFile();

            // Reset lesson generator completely
            resetLessonGenerator();

            showNotification('Starting fresh lesson creation. Please upload a new file.', 'info');
        }

        // Function to clear the form
        function clearForm() {
            // Clear file input
            document.getElementById('lessonFileInput').value = '';
            document.getElementById('selectedFileName').classList.add('hidden');
            currentLessonFile = null;

            // Clear form fields
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonPrompt').value = '';
            document.getElementById('focusArea').value = '';
            document.getElementById('gradeLevel').value = '';
            document.getElementById('additionalNotes').value = '';

            // Clear validation messages
            const validationMessage = document.getElementById('titleValidationMessage');
            if (validationMessage) {
                validationMessage.classList.add('hidden');
            }
        }

        function proceedToLessonConfig() {
            if (!currentLessonFile) {
                showNotification('Please select a file first', 'error');
                return;
            }

            showLessonStep('config');
            showNotification('File uploaded successfully! Please fill in the lesson details.', 'success');
        }

        // Check if lesson title already exists for the current teacher
        async function checkDuplicateLessonTitle(title) {
            if (!title || title.trim() === '') {
                return false;
            }

            try {
                const response = await fetch(`/api/lessons/check_title_exists?title=${encodeURIComponent(title.trim())}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.exists || false;
                }
            } catch (error) {
                console.error('Error checking duplicate title:', error);
                // If there's an error checking, allow the submission to proceed
                // The backend will handle the validation as well
            }

            return false;
        }

        // Real-time validation for lesson title input
        let titleValidationTimeout;
        async function validateLessonTitleInput() {
            const titleInput = document.getElementById('lessonTitle');
            const validationMessage = document.getElementById('titleValidationMessage');
            const validationText = document.getElementById('titleValidationText');
            const title = titleInput.value.trim();

            // Clear previous timeout
            if (titleValidationTimeout) {
                clearTimeout(titleValidationTimeout);
            }

            // Hide validation message if title is empty
            if (!title) {
                validationMessage.classList.add('hidden');
                titleInput.classList.remove('border-red-500', 'border-green-500');
                titleInput.classList.add('border-gray-300');
                return;
            }

            // Show loading state
            validationMessage.classList.remove('hidden');
            validationMessage.className = 'mt-2 text-sm text-gray-500';
            validationText.textContent = 'Checking title availability...';

            // Add debouncing to avoid excessive API calls
            titleValidationTimeout = setTimeout(async () => {
                try {
                    const exists = await checkDuplicateLessonTitle(title);
                    if (exists) {
                        // Title already exists - show error
                        validationMessage.className = 'mt-2 text-sm text-red-600';
                        validationText.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>This title is already used. Please choose a different title.';
                        titleInput.classList.remove('border-gray-300', 'border-green-500');
                        titleInput.classList.add('border-red-500');
                    } else {
                        // Title is available - show success
                        validationMessage.className = 'mt-2 text-sm text-green-600';
                        validationText.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Title is available.';
                        titleInput.classList.remove('border-gray-300', 'border-red-500');
                        titleInput.classList.add('border-green-500');
                    }
                } catch (error) {
                    // Hide validation message on error
                    validationMessage.classList.add('hidden');
                    titleInput.classList.remove('border-red-500', 'border-green-500');
                    titleInput.classList.add('border-gray-300');
                }
            }, 500); // 500ms debounce
        }

        // Function to disable all sidebar tabs during actions
        function disableSidebarTabs() {
            const tabsToDisable = [
                'startNewChat',
                'resetChat',
                'openLessonGenerator',
                'openViewLessons',
                'toggleVoiceRecording',
                'logout'
            ];

            tabsToDisable.forEach(tabFunction => {
                const buttons = document.querySelectorAll(`button[onclick*="${tabFunction}"]`);
                buttons.forEach(button => {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                    button.style.pointerEvents = 'none';
                });
            });

            // Also disable chat history dropdown
            const historyBtn = document.querySelector('button[onclick="toggleDropdown()"]');
            if (historyBtn) {
                historyBtn.disabled = true;
                historyBtn.classList.add('opacity-50', 'cursor-not-allowed');
                historyBtn.style.pointerEvents = 'none';
            }
        }

        // Function to re-enable all sidebar tabs after actions
        function enableSidebarTabs() {
            const tabsToEnable = [
                'startNewChat',
                'resetChat',
                'openLessonGenerator',
                'openViewLessons',
                'toggleVoiceRecording',
                'logout'
            ];

            tabsToEnable.forEach(tabFunction => {
                const buttons = document.querySelectorAll(`button[onclick*="${tabFunction}"]`);
                buttons.forEach(button => {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                    button.style.pointerEvents = 'auto';
                });
            });

            // Also re-enable chat history dropdown
            const historyBtn = document.querySelector('button[onclick="toggleDropdown()"]');
            if (historyBtn) {
                historyBtn.disabled = false;
                historyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                historyBtn.style.pointerEvents = 'auto';
            }
        }

        async function generateLesson(event) {
            event.preventDefault();

            const formData = new FormData();
            const form = document.getElementById('lessonConfigForm');

            // Check for duplicate lesson title
            const lessonTitle = form.lessonTitle.value.trim();
            if (await checkDuplicateLessonTitle(lessonTitle)) {
                showNotification('This lesson title is already used. Please choose a different title.', 'error');
                return;
            }

            // Add form fields with correct backend keys
            formData.append('lessonTitle', lessonTitle);
            formData.append('lessonPrompt', form.lessonPrompt.value);
            formData.append('focusArea', form.focusArea.value);
            formData.append('gradeLevel', form.gradeLevel.value);
            formData.append('additionalNotes', form.additionalNotes.value);

            // Add file
            if (currentLessonFile) {
                formData.append('file', currentLessonFile);
            }

            const generateBtn = document.getElementById('generateLessonFormBtn');
            const generateBtnText = document.getElementById('generateBtnText');

            // Check if elements exist
            if (!generateBtn || !generateBtnText) {
                console.error('Required button elements not found');
                showNotification('Error: Form elements not found', 'error');
                return;
            }

            // Disable button and show loading
            generateBtn.disabled = true;
            generateBtnText.textContent = 'Generating...';

            // Add loading spinner to button
            const loadingIcon = generateBtn.querySelector('i');
            if (loadingIcon) {
                loadingIcon.className = 'fas fa-spinner fa-spin mr-2';
            }

            // Disable all sidebar tabs during lesson generation
            disableSidebarTabs();

            try {
                let endpoint = '/api/lessons/create_lesson';
                let method = 'POST';

                // If we're editing an existing lesson, use POST to create a new version
                if (window.editingLessonId) {
                    endpoint = `/api/lessons/lesson/${window.editingLessonId}/create_version`;
                    method = 'POST';

                    // Convert FormData to JSON for POST request
                    const jsonData = {
                        title: form.lessonTitle.value,
                        lesson_prompt: form.lessonPrompt.value,
                        focus_area: form.focusArea.value,
                        grade_level: form.gradeLevel.value,
                        summary: form.additionalNotes.value,
                        content: generatedLessonContent || currentLessonData?.content || '',
                        file_name: currentLessonFile ? currentLessonFile.name : null
                    };

                    // Debug logging
                    console.log('Creating new version with data:', jsonData);
                    console.log('generatedLessonContent:', generatedLessonContent);
                    console.log('currentLessonData?.content:', currentLessonData?.content);
                    console.log('Final content length:', jsonData.content.length);

                    const response = await fetch(endpoint, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(jsonData),
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        showNotification('New version of lesson created successfully!', 'success');

                        // Reset editing state
                        window.editingLessonId = null;

                        // Reset form and button
                        form.reset();
                        if (generateBtnText) {
                            generateBtnText.textContent = 'Generate Lesson';
                        }

                        // Reset loading icon
                        const loadingIcon = generateBtn?.querySelector('i');
                        if (loadingIcon) {
                            loadingIcon.className = 'fas fa-magic mr-2';
                        }

                        // Refresh lesson data and switch back to lessons view
                        await refreshLessonData();
                        openViewLessons();

                    } else {
                        const errorData = await response.json();
                        showNotification(`Error creating new version: ${errorData.error || 'Creation failed'}`, 'error');
                    }
                } else {
                    // Original lesson creation logic
                    const response = await fetch(endpoint, {
                        method: method,
                        body: formData,
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Fetch the full lesson from the backend using the new lesson_id
                        const lessonResp = await fetch(`/api/lessons/lesson/${data.lesson_id}`, {
                            method: 'GET',
                            credentials: 'include'
                        });
                        if (lessonResp.ok) {
                            const lessonData = await lessonResp.json();
                            currentLessonData = lessonData.lesson;
                            // Mark lesson as not finalized when first created
                            currentLessonData.isFinalized = false;
                            generatedLessonContent = currentLessonData.content;
                            displayGeneratedLesson();
                            showLessonStep('display');
                            showNotification('Lesson generated successfully! You can continue editing or finalize it.', 'success');
                        } else {
                            showNotification('Failed to fetch full lesson content', 'error');
                        }
                    } else {
                        const errorData = await response.json();
                        showNotification(`Error generating lesson: ${errorData.error || 'Generation failed'}`, 'error');
                    }
                }

            } catch (error) {
                console.error('Error generating lesson:', error);
                showNotification('Error generating lesson. Please try again.', 'error');

            } finally {
                // Re-enable button and hide loading
                if (generateBtn) {
                    generateBtn.disabled = false;
                }
                if (generateBtnText) {
                    generateBtnText.textContent = 'Generate Lesson';
                }

                // Reset loading icon
                const loadingIcon = generateBtn?.querySelector('i');
                if (loadingIcon) {
                    loadingIcon.className = 'fas fa-magic mr-2';
                }

                // Re-enable all sidebar tabs after lesson generation completes
                enableSidebarTabs();
            }
        }

        function displayGeneratedLesson() {
            if (currentLessonData) {
                const lessonSummary = document.getElementById('lessonSummary');
                // Show content, fallback to summary if content is missing
                const content = generatedLessonContent || currentLessonData.content || currentLessonData.summary || 'No content available.';

                // Format content without numbers for generation view
                const formattedContent = formatLessonContentWithoutNumbers(content);
                lessonSummary.innerHTML = formattedContent;

                // Show additional notes if provided
                if (currentLessonData.additionalNotes) {
                    const additionalNotesDisplay = document.getElementById('additionalNotesDisplay');
                    const displayAdditionalNotes = document.getElementById('displayAdditionalNotes');
                    if (additionalNotesDisplay && displayAdditionalNotes) {
                        displayAdditionalNotes.textContent = currentLessonData.additionalNotes;
                        additionalNotesDisplay.classList.remove('hidden');
                    }
                }
            }
        }

        function formatLessonContentWithoutNumbers(content) {
            console.log('formatLessonContentWithoutNumbers called with content:', content);

            if (!content || content.trim() === '') {
                return '<p>No content available</p>';
            }

            // Split content into paragraphs
            const paragraphs = content.split('\n\n').filter(p => p.trim() !== '');

            let formattedContent = '';

            paragraphs.forEach(paragraph => {
                const trimmedParagraph = paragraph.trim();
                if (trimmedParagraph) {
                    // Check if it's a complete sentence (ends with period, exclamation, or question mark)
                    const isCompleteSentence = /[.!?]$/.test(trimmedParagraph);

                    if (isCompleteSentence) {
                        // It's a complete sentence - display as one paragraph
                        formattedContent += `<p class="text-gray-700 leading-relaxed mb-3">${trimmedParagraph}</p>`;
                    } else {
                        // Split into sentences and display each as a paragraph
                        const sentences = trimmedParagraph.split(/[.!?]+/).filter(s => s.trim() !== '');
                        if (sentences.length > 1) {
                            sentences.forEach(sentence => {
                                const trimmedSentence = sentence.trim();
                                if (trimmedSentence) {
                                    formattedContent += `<p class="text-gray-700 leading-relaxed mb-3">${trimmedSentence}.</p>`;
                                }
                            });
                        } else {
                            // Single sentence or short text - display as one paragraph
                            formattedContent += `<p class="text-gray-700 leading-relaxed mb-3">${trimmedParagraph}</p>`;
                        }
                    }
                }
            });

            return formattedContent || '<p>No content available</p>';
        }

        function formatLessonContentWithNumbers(content) {
            console.log('formatLessonContentWithNumbers called with content:', content);

            if (!content || content.trim() === '') {
                return '<p>No content available</p>';
            }

            // Clean up the content - remove HTML tags if present
            const cleanContent = content.replace(/<[^>]*>/g, '').trim();
            console.log('Cleaned content:', cleanContent);

            // Split content into paragraphs first
            let paragraphs = cleanContent.split('\n\n').filter(p => p.trim());

            // If no double line breaks, try single line breaks
            if (paragraphs.length === 1) {
                paragraphs = cleanContent.split('\n').filter(p => p.trim());
            }

            // If still only one paragraph, split by sentences
            if (paragraphs.length === 1) {
                paragraphs = cleanContent.split(/[.!?]+/).filter(p => p.trim());
            }

            let numberedContent = '';
            let lineNumber = 1;

            paragraphs.forEach(paragraph => {
                const trimmedParagraph = paragraph.trim();
                if (trimmedParagraph) {
                    // Check if this looks like a sentence (ends with punctuation)
                    const isCompleteSentence = /[.!?]$/.test(trimmedParagraph);

                    if (isCompleteSentence) {
                        // It's a complete sentence - number it as one line
                        numberedContent += `<div class="numbered-line mb-2" data-line="${lineNumber}">
                        <span class="line-number font-bold text-[#05B0FC] mr-2">${lineNumber}:</span>
                        <span class="line-content">${trimmedParagraph}</span>
                    </div>`;
                        lineNumber++;
                    } else {
                        // It might be a paragraph with multiple sentences
                        const sentences = trimmedParagraph.split(/[.!?]+/).filter(s => s.trim());

                        if (sentences.length > 1) {
                            // Multiple sentences - number each sentence
                            sentences.forEach(sentence => {
                                const trimmedSentence = sentence.trim();
                                if (trimmedSentence) {
                                    numberedContent += `<div class="numbered-line mb-2" data-line="${lineNumber}">
                                    <span class="line-number font-bold text-[#05B0FC] mr-2">${lineNumber}:</span>
                                    <span class="line-content">${trimmedSentence}.</span>
                                </div>`;
                                    lineNumber++;
                                }
                            });
                        } else {
                            // Single sentence or short text - number as one line
                            numberedContent += `<div class="numbered-line mb-2" data-line="${lineNumber}">
                            <span class="line-number font-bold text-[#05B0FC] mr-2">${lineNumber}:</span>
                            <span class="line-content">${trimmedParagraph}</span>
                        </div>`;
                            lineNumber++;
                        }
                    }

                    // Add spacing between paragraphs
                    numberedContent += '<div class="mb-3"></div>';
                }
            });

            console.log('Generated numbered content:', numberedContent);
            return numberedContent;
        }

        function parseLineReference(question) {
            console.log('parseLineReference called with question:', question);

            // Parse line references like "line 1", "sentence 2", "paragraph 3", etc.
            const linePatterns = [
                /line\s+(\d+)/gi,
                /sentence\s+(\d+)/gi,
                /paragraph\s+(\d+)/gi,
                /point\s+(\d+)/gi,
                /number\s+(\d+)/gi,
                /(\d+)(?:st|nd|rd|th)?\s+(?:line|sentence|paragraph|point)/gi
            ];

            const references = [];
            linePatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(question)) !== null) {
                    const lineNumber = parseInt(match[1]);
                    if (lineNumber > 0) {
                        references.push(lineNumber);
                    }
                }
            });

            console.log('Found line references:', references);
            return references;
        }

        function getLineContent(lineNumber) {
            // Get the content of a specific line number from the lesson
            const lineElement = document.querySelector(`[data-line="${lineNumber}"]`);
            if (lineElement) {
                const contentElement = lineElement.querySelector('.line-content');
                return contentElement ? contentElement.textContent.trim() : '';
            }
            return '';
        }

        function highlightLineReference(lineNumber) {
            console.log('highlightLineReference called with lineNumber:', lineNumber);

            // Highlight the referenced line
            const lineElement = document.querySelector(`[data-line="${lineNumber}"]`);
            console.log('Found line element:', lineElement);

            if (lineElement) {
                // Remove previous highlights
                document.querySelectorAll('.highlighted-line').forEach(el => {
                    el.classList.remove('highlighted-line');
                });

                // Add highlight to current line
                lineElement.classList.add('highlighted-line');
                console.log('Highlighted line', lineNumber);

                // Scroll to the line
                lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Remove highlight after 3 seconds
                setTimeout(() => {
                    lineElement.classList.remove('highlighted-line');
                }, 3000);
            } else {
                console.log('No line element found for line number:', lineNumber);
            }
        }

        // Zoom functionality
        let currentZoomLevel = 100;
        const zoomLevels = [100, 110, 125, 150, 175, 200];
        let currentZoomIndex = 0;

        function applyZoom(zoomLevel) {
            // Try multiple selectors to find content elements
            const selectors = [
                '#chatMessages',
                '#lessonSummary',
                '#studentLessonContent',
                '.numbered-line',
                '.line-content',
                '.prose',
                '.markdown-content',
                '.lesson-content',
                '.chat-messages',
                '.lesson-display-content'
            ];

            let contentElements = [];
            selectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                contentElements = contentElements.concat(Array.from(elements));
            });

            // Also try to find any text content in the main areas
            const mainContentAreas = document.querySelectorAll('div[class*="content"], div[id*="content"], div[class*="message"], div[id*="message"]');
            contentElements = contentElements.concat(Array.from(mainContentAreas));

            console.log(`Found ${contentElements.length} elements to zoom`);
            console.log('Elements found:', contentElements);

            contentElements.forEach((element, index) => {
                if (element && element.style) {
                    console.log(`Element ${index}:`, element);
                    console.log(`Current font size: ${element.style.fontSize || 'not set'}`);
                    element.style.setProperty('font-size', `${zoomLevel}%`, 'important');
                    console.log(`New font size: ${element.style.fontSize}`);
                }
            });

            // Also try applying to the body as a fallback
            if (contentElements.length === 0) {
                console.log('No specific elements found, applying to body');
                document.body.style.setProperty('font-size', `${zoomLevel}%`, 'important');
            }

            currentZoomLevel = zoomLevel;
            console.log(`Applied zoom level: ${zoomLevel}%`);

            // Show zoom level indicator
            showZoomIndicator(zoomLevel);
        }

        function showZoomIndicator(zoomLevel) {
            // Remove existing indicator
            const existingIndicator = document.getElementById('zoomIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // Create new indicator
            const indicator = document.createElement('div');
            indicator.id = 'zoomIndicator';
            indicator.className = 'fixed top-4 right-4 bg-blue-600 text-white px-3 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
            indicator.textContent = `Zoom: ${zoomLevel}%`;

            document.body.appendChild(indicator);

            // Remove indicator after 2 seconds
            setTimeout(() => {
                if (indicator) {
                    indicator.style.opacity = '0';
                    setTimeout(() => {
                        if (indicator.parentNode) {
                            indicator.remove();
                        }
                    }, 300);
                }
            }, 2000);
        }

        function zoomIn() {
            if (currentZoomIndex < zoomLevels.length - 1) {
                currentZoomIndex++;
                applyZoom(zoomLevels[currentZoomIndex]);
            }
        }

        function zoomOut() {
            if (currentZoomIndex > 0) {
                currentZoomIndex--;
                applyZoom(zoomLevels[currentZoomIndex]);
            }
        }

        function resetZoom() {
            currentZoomIndex = 0;
            applyZoom(zoomLevels[0]);
        }

        // Selected text zoom functionality
        let selectedTextZoomLevel = 100;
        const selectedTextZoomLevels = [100, 110, 125, 150, 175, 200, 250, 300];
        let selectedTextZoomIndex = 0;

        function zoomSelectedText() {
            const selection = window.getSelection();
            if (!selection.toString().trim()) {
                showNotification('Please select some text first', 'info');
                return;
            }

            if (selectedTextZoomIndex < selectedTextZoomLevels.length - 1) {
                selectedTextZoomIndex++;
                applySelectedTextZoom(selectedTextZoomLevels[selectedTextZoomIndex]);
            } else {
                showNotification('Maximum zoom level reached', 'info');
            }
        }

        function zoomOutSelectedText() {
            const selection = window.getSelection();
            if (!selection.toString().trim()) {
                showNotification('Please select some text first', 'info');
                return;
            }

            if (selectedTextZoomIndex > 0) {
                selectedTextZoomIndex--;
                applySelectedTextZoom(selectedTextZoomLevels[selectedTextZoomIndex]);
            } else {
                showNotification('Minimum zoom level reached', 'info');
            }
        }

        function applySelectedTextZoom(zoomLevel) {
            const selection = window.getSelection();
            if (!selection.toString().trim()) {
                return;
            }

            // Get the range of selected text
            const range = selection.getRangeAt(0);

            // Create a span wrapper around the selected text
            const span = document.createElement('span');
            span.className = 'selected-text-zoom';
            span.style.fontSize = `${zoomLevel}%`;
            span.style.transition = 'font-size 0.2s ease';
            span.style.backgroundColor = '#fef3c7';
            span.style.padding = '2px 4px';
            span.style.borderRadius = '3px';
            span.style.display = 'inline-block';

            try {
                // Wrap the selected text with the span
                range.surroundContents(span);

                // Update selection to the new span
                selection.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNode(span);
                selection.addRange(newRange);

                selectedTextZoomLevel = zoomLevel;
                showZoomIndicator(`Selected Text: ${zoomLevel}%`);

                // Remove highlight after 3 seconds
                setTimeout(() => {
                    span.style.backgroundColor = 'transparent';
                    span.style.padding = '0';
                }, 3000);

            } catch (error) {
                console.error('Error applying selected text zoom:', error);
                showNotification('Could not zoom selected text', 'error');
            }
        }

        function resetSelectedTextZoom() {
            // Find all selected text zoom spans and reset them
            const zoomSpans = document.querySelectorAll('.selected-text-zoom');
            zoomSpans.forEach(span => {
                span.style.fontSize = '100%';
                span.style.backgroundColor = 'transparent';
                span.style.padding = '0';
            });

            selectedTextZoomIndex = 0;
            selectedTextZoomLevel = 100;
            showZoomIndicator('Selected Text Reset');
        }

        // Test function for debugging zoom
        function testZoom() {
            console.log('Testing zoom functionality...');
            applyZoom(150);
        }

        // Make test function available globally
        window.testZoom = testZoom;

        // Keyboard event listener for zoom functionality
        document.addEventListener('keydown', function (event) {
            console.log('Key pressed:', event.key, 'Ctrl:', event.ctrlKey);

            // Check for Ctrl + Plus (zoom in)
            if (event.ctrlKey && (event.key === '+' || event.key === '=')) {
                console.log('Ctrl + Plus detected');
                event.preventDefault();

                // Check if text is selected
                const selection = window.getSelection();
                console.log('Selected text:', selection.toString().trim());

                if (selection.toString().trim()) {
                    // Zoom selected text only
                    console.log('Zooming selected text');
                    zoomSelectedText();
                } else {
                    // Zoom all content
                    console.log('Zooming all content');
                    zoomIn();
                }
            }
            // Check for Ctrl + Minus (zoom out)
            else if (event.ctrlKey && event.key === '-') {
                event.preventDefault();

                // Check if text is selected
                const selection = window.getSelection();
                if (selection.toString().trim()) {
                    // Zoom out selected text only
                    zoomOutSelectedText();
                } else {
                    // Zoom out all content
                    zoomOut();
                }
            }
            // Check for Ctrl + 0 (reset zoom)
            else if (event.ctrlKey && event.key === '0') {
                event.preventDefault();
                const selection = window.getSelection();
                if (selection.toString().trim()) {
                    // Reset selected text zoom
                    resetSelectedTextZoom();
                } else {
                    // Reset all content zoom
                    resetZoom();
                }
            }
        });

        // Review Functions - Updated for inline editing
        function reviewWithHuman() {
            // Switch to inline editing mode
            const lessonSummary = document.getElementById('lessonSummary');
            const inlineEditTextarea = document.getElementById('inlineEditTextarea');
            const defaultButtons = document.getElementById('defaultReviewButtons');
            const inlineEditButtons = document.getElementById('inlineEditButtons');
            const aiPromptContainer = document.getElementById('inlineAIPromptContainer');
            const inlineAIButtons = document.getElementById('inlineAIButtons');

            // Hide AI prompt container if it's visible
            if (aiPromptContainer) aiPromptContainer.classList.add('hidden');
            if (inlineAIButtons) inlineAIButtons.classList.add('hidden');

            // Populate textarea with current lesson content
            const content = generatedLessonContent || (currentLessonData && currentLessonData.content) || '';
            inlineEditTextarea.value = content;

            // Auto-resize textarea based on content
            autoResizeTextarea(inlineEditTextarea);

            // Add input event listener for dynamic resizing
            inlineEditTextarea.addEventListener('input', function () {
                autoResizeTextarea(this);
            });

            // Switch to editing mode
            lessonSummary.classList.add('hidden');
            inlineEditTextarea.classList.remove('hidden');
            defaultButtons.classList.add('hidden');
            inlineEditButtons.classList.remove('hidden');
        }

        function reviewWithAI() {
            // Switch to inline AI prompt mode
            const lessonSummary = document.getElementById('lessonSummary');
            const inlineEditTextarea = document.getElementById('inlineEditTextarea');
            const defaultButtons = document.getElementById('defaultReviewButtons');
            const inlineEditButtons = document.getElementById('inlineEditButtons');
            const aiPromptContainer = document.getElementById('inlineAIPromptContainer');
            const inlineAIButtons = document.getElementById('inlineAIButtons');

            // Hide editing elements if they're visible
            if (inlineEditTextarea) inlineEditTextarea.classList.add('hidden');
            if (inlineEditButtons) inlineEditButtons.classList.add('hidden');

            // Clear previous prompt
            const aiPrompt = document.getElementById('inlineAIPrompt');
            if (aiPrompt) aiPrompt.value = '';

            // Show AI prompt interface
            lessonSummary.classList.remove('hidden');
            aiPromptContainer.classList.remove('hidden');
            defaultButtons.classList.add('hidden');
            inlineAIButtons.classList.remove('hidden');
        }

        function cancelHumanReview() {
            showLessonStep('display');
        }

        // New inline editing functions
        function saveInlineEdit() {
            const editedContent = document.getElementById('inlineEditTextarea').value;

            if (editedContent.trim()) {
                // Update the lesson content
                generatedLessonContent = editedContent;
                if (currentLessonData) {
                    currentLessonData.content = editedContent;
                    // Mark as not finalized since it was edited
                    currentLessonData.isFinalized = false;
                }

                // Update the display
                const formattedContent = formatLessonContentWithoutNumbers(editedContent);
                document.getElementById('lessonSummary').innerHTML = formattedContent;

                // Switch back to default view
                cancelInlineEdit();

                showNotification('Lesson updated successfully!', 'success');
            } else {
                showNotification('Please enter some content before saving.', 'error');
            }
        }

        function cancelInlineEdit() {
            const lessonSummary = document.getElementById('lessonSummary');
            const inlineEditTextarea = document.getElementById('inlineEditTextarea');
            const defaultButtons = document.getElementById('defaultReviewButtons');
            const inlineEditButtons = document.getElementById('inlineEditButtons');

            // Switch back to default view
            lessonSummary.classList.remove('hidden');
            inlineEditTextarea.classList.add('hidden');
            defaultButtons.classList.remove('hidden');
            inlineEditButtons.classList.add('hidden');
        }

        // Function to disable/enable other buttons during AI processing
        function toggleOtherButtons(disable) {
            // Disable/Enable Generate Lesson buttons
            const generateLessonBtn = document.getElementById('generateLessonBtn');
            const generateLessonTopBtn = document.getElementById('generateLessonTopBtn');
            const generateLessonFormBtn = document.getElementById('generateLessonFormBtn');

            if (generateLessonBtn) generateLessonBtn.disabled = disable;
            if (generateLessonTopBtn) generateLessonTopBtn.disabled = disable;
            if (generateLessonFormBtn) generateLessonFormBtn.disabled = disable;

            // Disable/Enable New Lesson buttons
            const newLessonButtons = document.querySelectorAll('button[onclick="startNewLesson()"]');
            newLessonButtons.forEach(btn => btn.disabled = disable);

            // Disable/Enable API Key button
            const apiKeyBtn = document.querySelector('button[onclick="openApiKeyModal()"]');
            if (apiKeyBtn) apiKeyBtn.disabled = disable;

            // Disable/Enable Finalize and Download button
            const finalizeBtn = document.querySelector('button[onclick="proceedToCompletion()"]');
            if (finalizeBtn) finalizeBtn.disabled = disable;

            // Disable/Enable Sidebar navigation buttons
            const newChatBtn = document.querySelector('button[onclick="startNewChat()"]');
            const viewLessonsBtn = document.getElementById('viewLessonsBtn');
            const resetChatBtn = document.querySelector('button[onclick="resetChat()"]');
            const voiceRecordingBtn = document.querySelector('button[onclick="toggleVoiceRecording()"]');
            const chatHistoryBtn = document.querySelector('button[onclick="toggleDropdown()"]');

            if (newChatBtn) newChatBtn.disabled = disable;
            if (viewLessonsBtn) viewLessonsBtn.disabled = disable;
            if (resetChatBtn) resetChatBtn.disabled = disable;
            if (voiceRecordingBtn) voiceRecordingBtn.disabled = disable;
            if (chatHistoryBtn) chatHistoryBtn.disabled = disable;
        }

        // Hide/Show finalize button and modal close buttons during processing
        function setFinalizeAndModalCloseVisibility(hidden) {
            const finalizeBtn = document.querySelector('button[onclick="proceedToCompletion()"]');
            if (finalizeBtn) finalizeBtn.style.visibility = hidden ? 'hidden' : '';

            // Also handle AI Versioning finalize button if present
            const versionFinalizeBtn = document.getElementById('finalizeAIVersionBtn');
            if (versionFinalizeBtn) versionFinalizeBtn.style.visibility = hidden ? 'hidden' : '';

            const closeHandlers = [
                'closeAskQuestionModal()',
                'closeEditLessonModal()',
                'closeFaqModal()',
                'closeApiKeyModal()',
                'closeStudentLessonModal()',
                'closeAIVersioningModal()',
                'closeComparisonModal()',
                'closeLessonModal()'
            ];

            closeHandlers.forEach(handler => {
                document.querySelectorAll(`button[onclick="${handler}"]`).forEach(btn => {
                    btn.style.visibility = hidden ? 'hidden' : '';
                });
            });

            // Also cover generic close controls if present
            document.querySelectorAll('.btn-close, [data-bs-dismiss="modal"]').forEach(el => {
                el.style.visibility = hidden ? 'hidden' : '';
            });
        }

        async function applyInlineAI() {
            const prompt = document.getElementById('inlineAIPrompt').value.trim();

            if (!prompt) {
                showNotification('Please enter a prompt for the AI.', 'error');
                return;
            }

            const lessonContent = generatedLessonContent || (currentLessonData && currentLessonData.content) || '';
            if (!lessonContent) {
                showNotification('No lesson content available for AI review.', 'error');
                return;
            }

            // Show loading state
            const applyBtn = document.getElementById('applyInlineAIBtn');
            const applyText = document.getElementById('applyInlineAIText');
            const applyLoader = document.getElementById('applyInlineAILoader');

            applyBtn.disabled = true;
            applyText.textContent = 'Processing...';
            applyLoader.classList.remove('hidden');

            // Disable other buttons during AI processing
            toggleOtherButtons(true);
            // Hide finalize and any modal close buttons during processing
            setFinalizeAndModalCloseVisibility(true);

            try {
                const response = await fetch('/edit_lesson_with_prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lesson_text: lessonContent,
                        user_prompt: prompt
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const newContent = result.lesson_markdown;

                    if (newContent && newContent.trim()) {
                        // Update the lesson content
                        generatedLessonContent = newContent;
                        if (currentLessonData) {
                            currentLessonData.content = newContent;
                            // Mark as not finalized since it was edited
                            currentLessonData.isFinalized = false;
                        }

                        // Update the display
                        const formattedContent = formatLessonContentWithoutNumbers(newContent);
                        document.getElementById('lessonSummary').innerHTML = formattedContent;

                        // Reset button state before switching views
                        applyBtn.disabled = false;
                        applyText.textContent = 'Apply AI Changes';
                        applyLoader.classList.add('hidden');

                        // Re-enable other buttons
                        toggleOtherButtons(false);

                        // Switch back to default view
                        cancelInlineAI();

                        showNotification('AI changes applied successfully!', 'success');
                    } else {
                        // Reset button state for error case
                        applyBtn.disabled = false;
                        applyText.textContent = 'Apply AI Changes';
                        applyLoader.classList.add('hidden');
                        // Re-enable other buttons
                        toggleOtherButtons(false);
                        showNotification('AI did not return any content. Please try a different prompt.', 'error');
                    }
                } else {
                    // Reset button state for error case
                    applyBtn.disabled = false;
                    applyText.textContent = 'Apply AI Changes';
                    applyLoader.classList.add('hidden');
                    // Re-enable other buttons
                    toggleOtherButtons(false);
                    showNotification('Failed to apply AI changes. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error applying AI changes:', error);
                // Reset button state for error case
                applyBtn.disabled = false;
                applyText.textContent = 'Apply AI Changes';
                applyLoader.classList.add('hidden');
                // Re-enable other buttons
                toggleOtherButtons(false);
                showNotification('Error applying AI changes. Please try again.', 'error');
            } finally {
                // Restore finalize and modal close buttons visibility
                setFinalizeAndModalCloseVisibility(false);
            }
        }

        function cancelInlineAI() {
            const lessonSummary = document.getElementById('lessonSummary');
            const defaultButtons = document.getElementById('defaultReviewButtons');
            const aiPromptContainer = document.getElementById('inlineAIPromptContainer');
            const inlineAIButtons = document.getElementById('inlineAIButtons');

            // Clear the prompt
            const aiPrompt = document.getElementById('inlineAIPrompt');
            if (aiPrompt) aiPrompt.value = '';

            // Switch back to default view
            lessonSummary.classList.remove('hidden');
            aiPromptContainer.classList.add('hidden');
            defaultButtons.classList.remove('hidden');
            inlineAIButtons.classList.add('hidden');
        }

        function saveHumanReview() {
            const editedContent = document.getElementById('humanReviewContent').value;

            if (editedContent.trim()) {
                generatedLessonContent = editedContent;
                currentLessonData.content = editedContent;
                // Preserve the finalized state
                const wasFinalized = currentLessonData.isFinalized;
                currentLessonData.isFinalized = false; // Mark as not finalized since it was edited
                displayGeneratedLesson();
                showLessonStep('display');
                showNotification('Changes applied successfully!', 'success');
            } else {
                showNotification('Please enter some content', 'error');
            }
        }

        function cancelAIReview() {
            document.getElementById('aiReviewPrompt').value = '';
            showLessonStep('display');
        }

        async function applyAIReview() {
            const prompt = document.getElementById('aiReviewPrompt').value.trim();

            if (!prompt) {
                showNotification('Please enter instructions for AI', 'error');
                return;
            }

            const lessonContent = generatedLessonContent || (currentLessonData && currentLessonData.content) || '';
            if (!lessonContent) {
                showNotification('No lesson content available for AI review.', 'error');
                return;
            }

            const applyBtn = document.getElementById('applyAIReviewBtn');
            const applyBtnText = document.getElementById('applyAIReviewText');
            const applyBtnLoader = document.getElementById('applyAIReviewLoader');

            // Disable button and show loading
            applyBtn.disabled = true;
            applyBtnText.textContent = 'Processing...';
            applyBtnLoader.classList.remove('hidden');

            // Disable all sidebar tabs during AI review processing
            disableSidebarTabs();
            // Hide finalize and any modal close buttons during processing
            setFinalizeAndModalCloseVisibility(true);

            try {
                const response = await fetch('/edit_lesson_with_prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lesson_text: lessonContent,
                        user_prompt: prompt
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const newContent = data.lesson_markdown || data.updated_content || data.content || '';
                    if (!newContent.trim()) {
                        showNotification('AI did not return any content. Please try a different prompt.', 'error');
                        return;
                    }
                    generatedLessonContent = newContent;
                    currentLessonData.content = newContent;
                    // Mark as not finalized since it was edited
                    currentLessonData.isFinalized = false;
                    displayGeneratedLesson();
                    showLessonStep('display');
                    showNotification('AI review applied successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    showNotification(`Error applying AI review: ${errorData.error}`, 'error');
                }

            } catch (error) {
                console.error('Error applying AI review:', error);
                showNotification('Error applying AI review', 'error');

            } finally {
                // Re-enable button and hide loading
                applyBtn.disabled = false;
                applyBtnText.textContent = 'Apply AI Changes';
                applyBtnLoader.classList.add('hidden');
                document.getElementById('aiReviewPrompt').value = '';

                // Re-enable all sidebar tabs after AI review processing completes
                enableSidebarTabs();
                // Restore finalize and modal close buttons visibility
                setFinalizeAndModalCloseVisibility(false);
            }
        }

        // Function to clear uploaded file
        function clearUploadedFile() {
            // Clear the file variable
            currentLessonFile = null;

            // Reset the file input
            const fileInput = document.getElementById('lessonFileInput');
            if (fileInput) {
                fileInput.value = '';
            }

            // Hide file display
            const fileNameDisplay = document.getElementById('selectedFileName');
            if (fileNameDisplay) {
                fileNameDisplay.classList.add('hidden');
            }

            // Disable proceed button
            const proceedBtn = document.getElementById('proceedBtn');
            if (proceedBtn) {
                proceedBtn.disabled = true;
            }
        }

        // Completion Functions
        async function proceedToCompletion() {
            if (currentLessonData) {
                // Send updated lesson to backend
                try {
                    const response = await fetch(`/api/lessons/lesson/${currentLessonData.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            title: currentLessonData.title,
                            summary: currentLessonData.summary || '',
                            lesson_prompt: currentLessonData.lesson_prompt || '',
                            focus_area: currentLessonData.focus_area || currentLessonData.focusArea || '',
                            grade_level: currentLessonData.grade_level || currentLessonData.gradeLevel || '',
                            content: generatedLessonContent || currentLessonData.content || '',
                            // Add other fields as needed
                        })
                    });
                    if (response.ok) {
                        showNotification('Lesson updated in database!', 'success');
                    } else {
                        showNotification('Failed to update lesson in database.', 'error');
                    }
                } catch (error) {
                    showNotification('Error updating lesson in database.', 'error');
                }

                // Mark lesson as finalized
                currentLessonData.isFinalized = true;

                // Clear generated content so form shows for next lesson
                generatedLessonContent = '';

                showNotification('Lesson finalized successfully!', 'success');

                // Clear the uploaded file after finalization
                clearUploadedFile();

                // Go directly to My Lessons page
                openViewLessons();
            }
        }

        async function downloadLesson(format) {
            if (!currentLessonData) {
                showNotification('No lesson to download', 'error');
                return;
            }
            try {
                let url;
                if (format === 'pdf') {
                    url = `/api/lessons/download_lesson_pdf/${currentLessonData.id}`;
                } else if (format === 'pptx') {
                    url = `/api/lessons/download_lesson_ppt/${currentLessonData.id}`;
                } else {
                    url = `/api/lessons/download_lesson/${currentLessonData.id}`;
                }
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const a = document.createElement('a');
                    a.href = window.URL.createObjectURL(blob);
                    a.download = `${currentLessonData.title}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(a.href);
                    a.remove();
                    showNotification(`Lesson downloaded as ${format.toUpperCase()}!`, 'success');

                    // Clear the uploaded file after successful download
                    clearUploadedFile();

                    // Redirect to My Lessons page after successful download
                    setTimeout(() => {
                        openViewLessons();
                    }, 1500);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error || 'Error downloading lesson';
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                showNotification('Error downloading lesson.', 'error');
            }
        }

        function startNewLesson() {
            // Reset lesson state completely (including finalized state)
            currentLessonData = null;
            generatedLessonContent = '';

            // Clear form
            document.getElementById('lessonConfigForm').reset();
            document.getElementById('additionalNotesDisplay').classList.add('hidden');

            // Clear uploaded file using the dedicated function
            clearUploadedFile();

            // Clear lesson completion page content
            document.getElementById('lessonCompletionPage').classList.add('hidden');
            document.getElementById('completedLessonTitle').textContent = 'Sample Lesson from document.pdf';

            // Clear lesson display content
            const lessonSummary = document.getElementById('lessonSummary');
            if (lessonSummary) {
                lessonSummary.innerHTML = '';
            }

            // Clear review interfaces
            document.getElementById('humanReviewInterface').classList.add('hidden');
            document.getElementById('aiReviewInterface').classList.add('hidden');

            // Clear review content
            const humanReviewContent = document.getElementById('humanReviewContent');
            if (humanReviewContent) {
                humanReviewContent.value = '';
            }

            const aiReviewPrompt = document.getElementById('aiReviewPrompt');
            if (aiReviewPrompt) {
                aiReviewPrompt.value = '';
            }

            const currentLessonPreview = document.getElementById('currentLessonPreview');
            if (currentLessonPreview) {
                currentLessonPreview.textContent = '';
            }

            // Reset lesson step to upload
            showLessonStep('upload');

            // Reset button states
            const generateBtn = document.getElementById('generateLessonFormBtn');
            const generateBtnText = document.getElementById('generateBtnText');

            if (generateBtn) generateBtn.disabled = false;
            if (generateBtnText) generateBtnText.textContent = 'Generate Lesson';

            // Reset loading icon
            const loadingIcon = generateBtn?.querySelector('i');
            if (loadingIcon) {
                loadingIcon.className = 'fas fa-magic mr-2';
            }

            // Reset editing state
            window.editingLessonId = null;

            showNotification('Ready to create a new lesson!', 'info');
        }

        // Respond to student question
        function respondToQuestion(questionId) {
            // Switch to chat and prepare response
            changeTab(null, 'chat');

            // You could fetch specific question details here
            addMessageToChat('ai', `I'll help you prepare a comprehensive response for the student question. What would you like to include in your response?`);
            showNotification('Response prepared in chat area', 'success');
        }

        // Export FAQ report
        function exportFAQReport() {
            showNotification('FAQ report export functionality would generate a detailed report of all questions and analytics.', 'info');
        }

        // Content management (no tabs needed)
        function changeTab(button, tabType) {
            // Hide all content areas
            hideAllContentAreas();

            // Show/hide download button based on active view
            const downloadBtn = document.getElementById('chatDownloadBtn');
            if (downloadBtn) {
                if (tabType === 'chat') {
                    downloadBtn.classList.remove('hidden');
                } else {
                    downloadBtn.classList.add('hidden');
                }
            }

            // Show selected content area
            currentView = tabType;
            switch (tabType) {
                case 'chat':
                    document.getElementById('chatMessages').classList.remove('hidden');
                    // Show chat input area
                    const chatInputArea = document.getElementById('chatInputArea');
                    if (chatInputArea) {
                        chatInputArea.classList.remove('hidden');
                    }
                    // Reset header to New Chat when starting a new chat
                    const chatTitleElement = document.getElementById('chatTitle');
                    if (!currentChatId || chatTitleElement.textContent === '' || chatTitleElement.textContent === 'Lesson Generator' || chatTitleElement.textContent === 'My Lessons' || chatTitleElement.textContent === 'Browse Lessons') {
                        chatTitleElement.textContent = 'New Chat';
                    }
                    document.getElementById('chatStatus').textContent = 'Online';
                    break;
                case 'settings':
                    document.getElementById('settingsContent').classList.remove('hidden');
                    document.getElementById('chatTitle').textContent = 'Settings';
                    document.getElementById('chatStatus').textContent = 'Update API Key';
                    break;
            }
        }

        // Open Ask Question Modal
        function openAskQuestionModal(lessonId, lessonTitle) {
            // Store the current lesson ID for question submission
            currentQuestionLessonId = lessonId;

            // Update modal title and helper text
            document.getElementById('modalLessonTitle').textContent = lessonTitle;
            document.getElementById('modalLessonHelper').textContent = `Tell me how to help you to understand the '${lessonTitle}'...`;

            // Load existing lesson chat history
            loadLessonChatHistory(lessonId);

            // Show modal and focus on input
            document.getElementById('askQuestionModal').classList.remove('hidden');
            document.getElementById('questionInput').focus();
        }

        // Load lesson chat history from backend
        async function loadLessonChatHistory(lessonId) {
            try {
                const response = await fetch(`/api/lessons/lesson_chat_history/${lessonId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayLessonChatHistory(data.history || []);
                } else {
                    console.error('Failed to load lesson chat history');
                    displayLessonChatHistory([]);
                }
            } catch (error) {
                console.error('Error loading lesson chat history:', error);
                displayLessonChatHistory([]);
            }
        }

        // Display lesson chat history in the modal
        function displayLessonChatHistory(history) {
            const qnaDiv = document.getElementById('lessonQnAHistory');
            if (!qnaDiv) return;

            if (history.length === 0) {
                qnaDiv.innerHTML = '<div class="text-gray-500 text-center py-8 flex items-center justify-center h-full"><i class="fas fa-comments mr-2"></i>No previous questions for this lesson</div>';
                return;
            }

            let historyHtml = '';
            history.forEach((item, index) => {
                historyHtml += `
                <div class="mb-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                    <div class="mb-3">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-user-circle text-blue-600 mt-0.5"></i>
                            <div class="flex-1">
                                <span class="font-semibold text-blue-700">You:</span> 
                                <span class="text-gray-900 ml-1">${item.question}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pl-6 border-l-2 border-blue-100">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-robot text-green-600 mt-0.5"></i>
                            <div class="flex-1">
                                <span class="font-semibold text-green-700">AI:</span> 
                                <div class="text-gray-800 ml-1 whitespace-pre-wrap">${item.answer}</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-3 flex items-center justify-end">
                        <i class="fas fa-clock mr-1"></i>
                        ${new Date(item.created_at).toLocaleString()}
                    </div>
                </div>
            `;
            });

            qnaDiv.innerHTML = historyHtml;

            // Smooth scroll to bottom after content is loaded
            setTimeout(() => {
                qnaDiv.scrollTop = qnaDiv.scrollHeight;
            }, 50);
        }

        // Clear lesson chat history
        async function clearLessonChatHistory() {
            if (!currentQuestionLessonId) {
                showNotification('No lesson selected', 'error');
                return;
            }

            if (!confirm('Are you sure you want to clear all questions for this lesson? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/lessons/clear_lesson_chat_history/${currentQuestionLessonId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showNotification('Lesson chat history cleared successfully', 'success');
                    // Reload the chat history (which will be empty now)
                    loadLessonChatHistory(currentQuestionLessonId);
                } else {
                    showNotification('Failed to clear lesson chat history', 'error');
                }
            } catch (error) {
                console.error('Error clearing lesson chat history:', error);
                showNotification('Error clearing lesson chat history', 'error');
            }
        }

        // Toggle modal fullscreen
        function toggleModalFullscreen(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = document.getElementById(modalId + 'Content');
            const fullscreenIcon = document.getElementById(modalId + 'FullscreenIcon');
            const historyContainer = document.getElementById('lessonQnAHistory');

            if (!modal || !modalContent) return;

            const isFullscreen = modalContent.classList.contains('fullscreen');

            if (isFullscreen) {
                // Exit fullscreen - restore original dimensions
                modalContent.classList.remove('fullscreen');
                modalContent.classList.remove('w-screen', 'h-screen', 'max-w-none', 'max-h-none', 'mx-0', 'rounded-none');

                // Restore original classes based on modal type
                if (modalId === 'askQuestionModal') {
                    modalContent.classList.add('w-full', 'max-w-sm', 'sm:max-w-lg', 'lg:max-w-[600px]', 'mx-4');
                    modalContent.style.maxHeight = '80vh';
                } else if (modalId === 'aiVersioningModal') {
                    modalContent.classList.add('max-w-xs', 'sm:max-w-2xl', 'lg:max-w-4xl', 'mx-4');
                    modalContent.style.maxHeight = '90vh';
                } else if (modalId === 'lessonModal') {
                    modalContent.classList.add('max-w-6xl', 'mx-4');
                    modalContent.style.maxHeight = '90vh';
                } else if (modalId === 'studentLessonModal') {
                    modalContent.classList.add('max-w-6xl', 'mx-4');
                    modalContent.style.maxHeight = '90vh';
                } else if (modalId === 'comparisonModal') {
                    modalContent.classList.add('max-w-7xl', 'mx-4');
                    modalContent.style.maxHeight = '90vh';
                } else {
                    // Default fallback
                    modalContent.classList.add('max-w-lg', 'mx-4');
                    modalContent.style.maxHeight = '80vh';
                }

                modalContent.classList.add('rounded-lg');
                modalContent.style.overflowY = 'auto';

                // Reset history container height for normal mode
                if (historyContainer) {
                    historyContainer.className = 'h-60 sm:h-72 lg:h-80 max-h-60 sm:max-h-72 lg:max-h-80 overflow-y-auto bg-gray-50 rounded p-2 sm:p-3 text-xs sm:text-sm border border-gray-200 flex-1';
                }

                if (fullscreenIcon) {
                    fullscreenIcon.className = 'fas fa-expand text-base sm:text-lg';
                }
            } else {
                // Enter fullscreen
                modalContent.classList.add('fullscreen');
                modalContent.classList.remove('max-w-xs', 'max-w-sm', 'max-w-lg', 'max-w-2xl', 'max-w-4xl', 'max-w-6xl', 'max-w-7xl', 'w-full', 'mx-4', 'rounded-lg');
                modalContent.classList.add('w-screen', 'h-screen', 'max-w-none', 'max-h-none', 'mx-0', 'rounded-none');
                modalContent.style.maxHeight = '100vh';
                modalContent.style.overflowY = 'auto';

                // Expand history container height for fullscreen mode
                if (historyContainer) {
                    historyContainer.className = 'flex-1 min-h-96 max-h-none overflow-y-auto bg-gray-50 rounded p-3 text-sm border border-gray-200';
                }

                if (fullscreenIcon) {
                    fullscreenIcon.className = 'fas fa-compress text-base sm:text-lg';
                }
            }

            // Force scroll to bottom after layout change
            setTimeout(() => {
                if (historyContainer) {
                    historyContainer.scrollTop = historyContainer.scrollHeight;
                }
            }, 100);
        }

        // Close Ask Question Modal
        function closeAskQuestionModal() {
            // Exit fullscreen if active
            const modalContent = document.getElementById('askQuestionModalContent');
            if (modalContent && modalContent.classList.contains('fullscreen')) {
                toggleModalFullscreen('askQuestionModal');
            }

            // Hide the modal
            document.getElementById('askQuestionModal').classList.add('hidden');

            // Clear the question input
            document.getElementById('questionInput').value = '';

            // Clear Q&A history when closing the modal
            // This ensures a clean state for the next lesson
            const qnaDiv = document.getElementById('lessonQnAHistory');
            if (qnaDiv) {
                qnaDiv.innerHTML = '';
            }

            // Reset the current lesson ID
            currentQuestionLessonId = null;
        }

        // Global variable to track if AI is currently typing
        let isAITyping = false;

        // Submit Question
        async function submitQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                showNotification('Please enter a question', 'error');
                return;
            }
            if (!currentQuestionLessonId) {
                showNotification('No lesson selected', 'error');
                return;
            }

            // Prevent sending if AI is already typing
            if (isAITyping) {
                showNotification('Please wait for AI to finish typing...', 'warning');
                return;
            }

            // Set AI typing state
            isAITyping = true;

            // Disable input and button while AI is typing
            const questionInput = document.getElementById('questionInput');
            const submitButton = document.querySelector('#askQuestionModal button[onclick*="submitQuestion"]');
            if (questionInput) questionInput.disabled = true;
            if (submitButton) submitButton.disabled = true;

            // Store the lesson ID to ensure consistency throughout the request
            const lessonIdToSend = currentQuestionLessonId;

            // Generate unique ID for this question's loading state
            const loadingId = 'lessonQnALoading_' + Date.now();

            // Append question to Q&A history
            const qnaDiv = document.getElementById('lessonQnAHistory');
            if (qnaDiv) {
                // Add the new question to the history
                const questionHtml = `
                <div class="mb-3 p-3 bg-white rounded border">
                    <div class="mb-2">
                        <span class="font-semibold text-blue-700">You:</span> 
                        <span class="text-gray-800">${question}</span>
                    </div>
                    <div id="${loadingId}">
                        <span class="font-semibold text-green-700">AI:</span> 
                        <span class="italic text-gray-400">
                            <i class="fas fa-circle animate-pulse"></i>
                            <i class="fas fa-circle animate-pulse" style="animation-delay: 0.2s;"></i>
                            <i class="fas fa-circle animate-pulse" style="animation-delay: 0.4s;"></i>
                            AI typing...
                        </span>
                    </div>
                </div>
            `;
                qnaDiv.innerHTML += questionHtml;
                qnaDiv.scrollTop = qnaDiv.scrollHeight;
            }

            // Clear the input field
            document.getElementById('questionInput').value = '';

            try {
                const response = await fetch('/api/lessons/ask_question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lesson_id: lessonIdToSend,
                        question: question
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Find the loading div by the specific ID we created
                    const loadingDiv = document.getElementById(loadingId);
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                        <span class="font-semibold text-green-700">AI:</span> 
                        <span class="text-gray-800">${data.answer}</span>
                        <div class="text-xs text-gray-500 mt-1">
                            ${new Date().toLocaleString()}
                        </div>
                    `;
                    }
                    if (qnaDiv) {
                        qnaDiv.scrollTop = qnaDiv.scrollHeight;
                    }
                } else {
                    const errorData = await response.json();
                    const loadingDiv = document.getElementById(loadingId);
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                        <span class="font-semibold text-green-700">AI:</span> 
                        <span class="text-red-600">Error: ${errorData.error || 'Failed to process your question'}</span>
                    `;
                    }
                    if (qnaDiv) {
                        qnaDiv.scrollTop = qnaDiv.scrollHeight;
                    }
                }
            } catch (error) {
                console.error('Error submitting question:', error);
                const loadingDiv = document.getElementById(loadingId);
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                    <span class="font-semibold text-green-700">AI:</span> 
                    <span class="text-red-600">Error asking question. Please try again.</span>
                `;
                }
                if (qnaDiv) {
                    qnaDiv.scrollTop = qnaDiv.scrollHeight;
                }
            } finally {
                // Re-enable input and button after AI finishes typing
                isAITyping = false;
                if (questionInput) questionInput.disabled = false;
                if (submitButton) submitButton.disabled = false;
            }
        }

        // Allow Enter key to submit question
        document.addEventListener('DOMContentLoaded', function () {
            const questionInput = document.getElementById('questionInput');
            if (questionInput) {
                questionInput.addEventListener('keypress', function (event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        // Only submit if AI is not currently typing
                        if (!isAITyping) {
                            submitQuestion();
                        } else {
                            showNotification('Please wait for AI to finish typing...', 'warning');
                        }
                    }
                });
            }

            // Ensure sidebar is expanded by default on desktop
            if (window.innerWidth >= 768) {
                setTimeout(() => {
                    initializeSidebar();
                    // Apply compact sizing for better 100% screen scaling
                    applyCompactSidebarSizing();
                }, 100);
            }
        });

        // Additional backup to ensure sidebar is expanded on window load
        window.addEventListener('load', function () {
            if (window.innerWidth >= 768) {
                setTimeout(() => {
                    initializeSidebar();
                    // Also apply compact sizing immediately for better 100% screen scaling
                    applyCompactSidebarSizing();
                }, 200);
            }
        });

        // Note: Removed automatic sidebar expansion to respect user's manual choice to hide sidebar

        // Chat Functions
        async function restoreOrStartChat() {
            try {
                // Check if there's an existing active chat in localStorage
                const savedChatId = localStorage.getItem('currentChatId');
                const savedChatData = localStorage.getItem('chatData_' + savedChatId);

                if (savedChatId && savedChatData) {
                    // Try to restore the existing chat
                    const chatData = JSON.parse(savedChatData);
                    const response = await fetch(`/get_messages/${savedChatId}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.messages && data.messages.length > 0) {
                            // Restore the existing chat
                            currentChatId = savedChatId;
                            await restoreChatDisplay(data.messages);
                            console.log('Restored existing chat:', savedChatId);
                            return;
                        }
                    }
                }

                // If no valid existing chat, start a new one
                await startNewChat();
            } catch (error) {
                console.error('Error restoring chat:', error);
                // Fallback to starting new chat
                await startNewChat();
            }
        }

        async function restoreChatDisplay(messages) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            chatMessages.innerHTML = '';

            // Restore all messages
            messages.forEach(msg => {
                addMessageToChat(msg.role === 'bot' ? 'ai' : 'user', msg.message);
            });

            // Load conversation title
            try {
                const response = await fetch(`/get_conversation/${currentChatId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const conversationData = await response.json();
                    const chatTitleElement = document.getElementById('chatTitle');
                    if (chatTitleElement && conversationData.title) {
                        chatTitleElement.textContent = conversationData.title;
                    }
                }
            } catch (error) {
                console.error('Error loading conversation title:', error);
            }

            // Switch to chat view
            changeTab(null, 'chat');
        }

        async function startNewChat() {
            try {
                const response = await fetch('/create_conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'New Chat' }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentChatId = data.conversation_id;
                    // Save chat ID to localStorage for persistence
                    localStorage.setItem('currentChatId', currentChatId);
                } else {
                    currentChatId = Date.now();
                    localStorage.setItem('currentChatId', currentChatId);
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
                currentChatId = Date.now();
            }

            // Reset header to New Chat
            document.getElementById('chatTitle').textContent = 'New Chat';
            document.getElementById('chatStatus').textContent = 'Online';

            changeTab(null, 'chat');

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                    AI
                </div>
                <div class="bg-gray-100 rounded-2xl px-4 py-3 w-full">
                    <p class="text-gray-700 leading-relaxed">
                        Hello! I'm your AI assistant. How can I help you today?
                    </p>
                </div>
            </div>
        `;

            const messageInput = document.getElementById('messageInput');
            messageInput.value = '';
            // Reset textarea height after clearing
            autoResizeTextarea(messageInput);

            // Clear old chat data from localStorage when starting new chat
            clearOldChatData();

            loadChatHistory();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message) {
                // Switch to chat if not already there
                if (currentView !== 'chat') {
                    changeTab(null, 'chat');
                }

                addMessageToChat('user', message);
                input.value = '';
                // Reset textarea height after clearing
                autoResizeTextarea(input);

                // Auto-focus back to input for better user experience
                setTimeout(() => {
                    input.focus();
                }, 100);

                showTypingIndicator();

                try {
                    const response = await authenticatedFetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            input: message,
                            conversation_id: currentChatId
                        })
                    });

                    if (!response) return; // Authentication error handled by authenticatedFetch

                    hideTypingIndicator();

                    if (response.ok) {
                        const data = await response.json();
                        if (data.error) {
                            addMessageToChat('ai', `Error: ${data.error}`);
                        } else {
                            addMessageToChat('ai', data.response);

                            // Focus back to input after AI response for better engagement
                            setTimeout(() => {
                                focusMessageInput();
                            }, 500);

                            // Generate and update chat title after first message
                            if (currentChatId && document.getElementById('chatTitle').textContent === 'New Chat') {
                                const generatedTitle = generateChatTitle(message);
                                updateChatTitle(currentChatId, generatedTitle);
                            }

                            // Automatically speak the response if voice recording was used or voice output is enabled
                            if (isVoiceOutputEnabled || isRecording) {
                                speakText(data.response);
                            }
                        }

                        // Save chat data to localStorage for persistence
                        saveChatToLocalStorage();
                    } else {
                        const errorData = await response.json();
                        addMessageToChat('ai', `Error: ${errorData.error || 'Failed to get response'}`);
                    }

                    updateTokenMeter();

                } catch (error) {
                    hideTypingIndicator();
                    console.error('Error sending message:', error);
                    addMessageToChat('ai', 'Sorry, there was an error processing your message. Please try again.');
                }

                saveChatToHistory();
            }
        }

        // Search lessons
        async function searchLessons() {
            currentLessonPage = 1;
            const searchTerm = document.getElementById('searchLessons').value.trim();
            if (!searchTerm) {
                loadAvailableLessons();
                return;
            }
            try {
                const response = await fetch(`/api/lessons/search_lessons?q=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        availableLessons = data.lessons || [];
                        displayLessonsBasedOnRole();
                        showNotification(`Found ${availableLessons.length} lessons matching "${searchTerm}"`, 'info');
                    } else {
                        // Response is not JSON, likely an HTML error page
                        const text = await response.text();
                        console.error('Received non-JSON response:', text.substring(0, 200));
                        showNotification('Search service temporarily unavailable. Please try again.', 'error');
                    }
                } else {
                    // Handle different HTTP status codes
                    if (response.status === 401) {
                        showNotification('Please log in to search lessons', 'error');
                    } else if (response.status === 403) {
                        showNotification('You do not have permission to search lessons', 'error');
                    } else {
                        showNotification(`Search failed (${response.status}). Please try again.`, 'error');
                    }
                }
            } catch (error) {
                console.error('Error searching lessons:', error);
                showNotification('Network error while searching. Please check your connection.', 'error');
            }
        }

        function handleLessonSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchLessons();
            }
        }

        // Download lesson file
        async function downloadLessonFile(lessonId) {
            try {
                const response = await fetch(`/api/lessons/download_lesson/${lessonId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    // Get filename from response headers or use lesson ID as fallback
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = `lesson_${lessonId}.docx`; // fallback

                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();

                    showNotification('Lesson downloaded successfully!', 'success');
                } else {
                    showNotification('Error downloading lesson', 'error');
                }
            } catch (error) {
                console.error('Error downloading lesson:', error);
                showNotification('Error downloading lesson. Please try again.', 'error');
            }
        }













        // Settings Functions
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            const icon = document.getElementById('toggleApiKeyIcon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function clearApiKey() {
            document.getElementById('apiKeyInput').value = '';
            showNotification('API key field cleared', 'info');
        }

        async function saveApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const newApiKey = apiKeyInput.value.trim();
            const saveBtn = document.querySelector('button[onclick="saveApiKey()"]');
            let spinner = document.getElementById('saveApiKeySpinner');
            if (!spinner) {
                spinner = document.createElement('i');
                spinner.id = 'saveApiKeySpinner';
                spinner.className = 'fas fa-spinner fa-spin ml-2';
            }
            if (saveBtn && !saveBtn.contains(spinner)) {
                saveBtn.appendChild(spinner);
            }
            if (saveBtn) saveBtn.disabled = true;

            if (!newApiKey) {
                showNotification('Please enter an API key', 'error');
                if (saveBtn) saveBtn.disabled = false;
                if (spinner) spinner.remove();
                return;
            }

            try {
                const response = await fetch('/update_api_key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: newApiKey }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('API key updated successfully', 'success');
                        apiKeyInput.value = '';
                        changeTab(null, 'chat');
                    } else {
                        showNotification(data.error || 'Failed to update API key', 'error');
                    }
                } else {
                    const errorData = await response.json();
                    showNotification(errorData.error || 'Failed to update API key', 'error');
                }
            } catch (error) {
                console.error('Error updating API key:', error);
                showNotification('Error updating API key', 'error');
            } finally {
                if (saveBtn) saveBtn.disabled = false;
                if (spinner) spinner.remove();
            }
        }

        // Voice Functions
        function toggleVoiceRecording() {
            if (!isRecording) {
                startVoiceInput();
                // Automatically enable voice output when starting voice recording
                if (!isVoiceOutputEnabled) {
                    toggleVoiceOutput();
                }
            } else {
                stopVoiceInput();
            }
        }

        function startVoiceInput() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.start();
                isRecording = true;

                // Automatically enable voice output when starting voice recording
                if (!isVoiceOutputEnabled) {
                    isVoiceOutputEnabled = true;
                    const voiceBtn = document.getElementById('voiceOutputBtn');
                    voiceBtn.classList.add('bg-blue-50', 'border-blue-300');
                    showNotification('Voice output automatically enabled for voice chat', 'success');
                }

                document.getElementById('voiceRecordingIndicator').classList.remove('hidden');
                const micBtn = document.getElementById('micButton');
                micBtn.classList.add('bg-red-50', 'border-red-300');

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const messageInput = document.getElementById('messageInput');
                    messageInput.value = transcript;
                    // Resize textarea to fit the transcript
                    autoResizeTextarea(messageInput);
                    stopVoiceInput();
                    // Send message and automatically speak the response
                    sendMessage();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceInput();
                    showNotification('Voice recognition error: ' + event.error, 'error');
                };

                recognition.onend = () => {
                    stopVoiceInput();
                };
            } else {
                showNotification('Speech recognition not supported in this browser', 'error');
            }
        }

        function stopVoiceInput() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            document.getElementById('voiceRecordingIndicator').classList.add('hidden');
            const micBtn = document.getElementById('micButton');
            micBtn.classList.remove('bg-red-50', 'border-red-300');
        }

        function stopRecording() {
            stopVoiceInput();
        }

        function toggleVoiceOutput() {
            // If voice output is currently enabled and speech is playing, stop it
            if (isVoiceOutputEnabled && window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                showNotification('Voice playback stopped', 'info');
                return;
            }

            // Toggle voice output state
            isVoiceOutputEnabled = !isVoiceOutputEnabled;
            const btn = document.getElementById('voiceOutputBtn');

            if (isVoiceOutputEnabled) {
                btn.classList.add('bg-blue-50', 'border-blue-300');
                showNotification('Voice output enabled', 'success');
            } else {
                btn.classList.remove('bg-blue-50', 'border-blue-300');
                showNotification('Voice output disabled', 'info');
            }
        }

        function stopSpeech() {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                const voiceBtn = document.getElementById('voiceOutputBtn');
                if (isVoiceOutputEnabled) {
                    voiceBtn.classList.add('bg-blue-50', 'border-blue-300');
                }
                voiceBtn.classList.remove('bg-green-50', 'border-green-300');
                showNotification('Voice playback stopped', 'info');
            }
        }

        function speakText(text) {
            if ('speechSynthesis' in window && (isVoiceOutputEnabled || isRecording)) {
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                const voices = window.speechSynthesis.getVoices();
                const femaleVoice = voices.find(voice =>
                    voice.name.includes('Female') ||
                    voice.name.includes('Zira') ||
                    voice.name.includes('Emma')
                );
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }

                // Add visual feedback when speech starts
                utterance.onstart = () => {
                    const voiceBtn = document.getElementById('voiceOutputBtn');
                    voiceBtn.classList.add('bg-green-50', 'border-green-300');
                    voiceBtn.classList.remove('bg-blue-50', 'border-blue-300');
                };

                // Remove visual feedback when speech ends
                utterance.onend = () => {
                    const voiceBtn = document.getElementById('voiceOutputBtn');
                    if (isVoiceOutputEnabled) {
                        voiceBtn.classList.add('bg-blue-50', 'border-blue-300');
                    }
                    voiceBtn.classList.remove('bg-green-50', 'border-green-300');
                };

                // Remove visual feedback if speech is cancelled
                utterance.onerror = () => {
                    const voiceBtn = document.getElementById('voiceOutputBtn');
                    if (isVoiceOutputEnabled) {
                        voiceBtn.classList.add('bg-blue-50', 'border-blue-300');
                    }
                    voiceBtn.classList.remove('bg-green-50', 'border-green-300');
                };

                window.speechSynthesis.speak(utterance);
            }
        }

        // Sidebar Functions
        function setupSidebarListeners() {
            const overlay = document.getElementById('overlay');

            if (overlay) {
                overlay.addEventListener('click', hideSidebar);
            }

            window.addEventListener('resize', handleResize);

            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', showSidebar);
            }
        }

        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            if (window.innerWidth >= 768) {
                sidebar.classList.remove('-translate-x-full');
                if (overlay) overlay.classList.add('hidden');

                if (isCollapsed) {
                    restoreFullSidebar();
                }
            } else {
                sidebar.classList.add('-translate-x-full');
                if (overlay) overlay.classList.add('hidden');
                isCollapsed = false;
            }
        }

        function hideSidebar() {
            const sidebar = document.getElementById('sidebar');

            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
                const overlay = document.getElementById('overlay');
                if (overlay) overlay.classList.add('hidden');
            } else {
                // Create collapsed sidebar content
                const mainContent = document.querySelector('.flex-1');

                sidebar.innerHTML = `
                <div class="flex flex-col h-full justify-between items-center py-4">
                    <button onclick="showSidebar()" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center justify-center transition-colors">
                        <i class="fas fa-bars w-6 h-6"></i>
                    </button>
                    <button onclick="logout()" class="w-10 h-10 bg-white shadow hover:bg-gray-50 text-red-600 rounded-lg flex items-center justify-center transition-colors">
                        <i class="fas fa-sign-out-alt text-[#F50D0D]"></i>
                    </button>
                </div>
            `;
                sidebar.className = "w-16 bg-white shadow-md h-full flex flex-col";
                if (mainContent) mainContent.style.marginLeft = "0px";

                // Adjust main content areas padding when sidebar is collapsed
                adjustContentPaddingForCollapsedSidebar();

                isCollapsed = true;
            }
        }

        function showSidebar() {
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('-translate-x-full');
                const overlay = document.getElementById('overlay');
                if (overlay) overlay.classList.remove('hidden');
            } else {
                restoreFullSidebar();
            }
        }

        function adjustContentPaddingForCollapsedSidebar() {
            // List of content areas that need padding adjustment
            const contentAreas = [
                'chatMessages',
                'lessonGeneratorContent',
                'viewLessonsContent',
                'faqDashboard',
                'settingsContent'
            ];

            contentAreas.forEach(areaId => {
                const element = document.getElementById(areaId);
                if (element) {
                    element.classList.remove('px-3', 'sm:px-4', 'lg:px-6');
                    element.classList.add('px-2', 'sm:px-3', 'lg:px-4');
                }
            });

            // Also adjust mobile menu button section and header
            const mobileMenuSection = document.querySelector('.px-3.sm\\:px-4.lg\\:px-6.py-3.sm\\:py-4');
            if (mobileMenuSection) {
                mobileMenuSection.classList.remove('px-3', 'sm:px-4', 'lg:px-6');
                mobileMenuSection.classList.add('px-2', 'sm:px-3', 'lg:px-4');
            }
        }

        function restoreContentPaddingForExpandedSidebar() {
            // List of content areas that need padding restoration
            const contentAreas = [
                'chatMessages',
                'lessonGeneratorContent',
                'viewLessonsContent',
                'faqDashboard',
                'settingsContent'
            ];

            contentAreas.forEach(areaId => {
                const element = document.getElementById(areaId);
                if (element) {
                    element.classList.remove('px-2', 'sm:px-3', 'lg:px-4');
                    element.classList.add('px-3', 'sm:px-4', 'lg:px-6');
                }
            });

            // Also restore mobile menu button section and header
            const mobileMenuSection = document.querySelector('.px-2.sm\\:px-3.lg\\:px-4.py-3.sm\\:py-4');
            if (mobileMenuSection) {
                mobileMenuSection.classList.remove('px-2', 'sm:px-3', 'lg:px-4');
                mobileMenuSection.classList.add('px-3', 'sm:px-4', 'lg:px-6');
            }
        }

        function restoreFullSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.flex-1');

            sidebar.innerHTML = `
            <!-- Header Section -->
            <div class="flex justify-between items-center">
                <img src="{{ url_for('static', filename='images/logo.png') }}" class="w-20 sm:w-24 lg:w-28 xl:w-32 h-6 sm:h-8 lg:h-10" alt="">
                <button onclick="hideSidebar()" class="mt-2 sm:mt-4 hover:bg-gray-100 p-1 rounded">
                    <img src="{{ url_for('static', filename='images/slider.png') }}" alt="">
                </button>
            </div>
            
            <!-- Border Line -->
            <div class="mt-3 sm:mt-4 border-t-2 border-gray-300 -mx-3 sm:-mx-4"></div>
            
            <!-- Main Content Section -->
            <div class="flex-1 flex flex-col">
            <div class="flex flex-col space-y-2 sm:space-y-3 lg:space-y-4 justify-center items-center mt-4 sm:mt-6 mb-2">

                <!-- New Chat -->
                <button onclick="startNewChat()" class="w-full max-w-[180px] sm:max-w-[200px] lg:max-w-[230px] h-10 sm:h-12 lg:h-[50px] mt-2 sm:mt-3 mb-1 sm:mb-2 px-3 sm:px-4 flex items-center justify-center gap-2 bg-[#05B0FC] text-white text-sm sm:text-base font-bold rounded transition duration-200 ease-in-out hover:bg-blue-600">
                    <img src="{{ url_for('static', filename='images/msg.png') }}" alt="">
                    <span>New Chat</span>
                </button>

                <!-- Action Buttons -->
                <button onclick="openLessonGenerator()" class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors" id="generateLessonBtn">
                    <img src="{{ url_for('static', filename='images/lesson.png') }}" alt="" class="w-3.5 h-3.5">
                    <span>Generate Lessons</span>
                </button>

                <!-- View Lessons Button in Sidebar -->
                <button onclick="openViewLessons()" class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors" id="viewLessonsBtn">
                    <img src="{{ url_for('static', filename='images/lesson.png') }}" alt="" class="w-3.5 h-3.5">
                    <span id="viewLessonsLabel">View Lessons</span>
                </button>

                <button onclick="toggleVoiceRecording()" class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors">
                    <i class="fas fa-microphone w-3.5 h-3.5"></i>
                    <span>Real Time Chat</span>
                </button>

                <button onclick="resetChat()" class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center gap-1.5 font-semibold text-xs text-gray-700 hover:bg-gray-50 rounded transition-colors">
                    <i class="fas fa-refresh text-[#B7B7B7] w-3.5 h-3.5"></i>
                    <span>Reset Chat</span>
                </button>

                <!-- Chat History Button -->
                <button onclick="toggleDropdown()" class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center justify-between font-semibold text-xs text-gray-700 mt-1.5 hover:bg-gray-50 rounded transition-colors">
                    <i class="fas fa-history text-[#B7B7B7] w-3 h-3"></i>
                    <span>Chat History</span>
                    <i class="fas fa-chevron-down text-[#666] w-2 h-2" id="historyArrow"></i>
                </button>

                <!-- Dropdown Chat History -->
                <div id="dropdownContent" class="mt-1.5 hidden flex-col gap-1 w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] max-h-20 sm:max-h-28 lg:max-h-36 overflow-y-auto sidebar-scroll">
                    <!-- Chat history items will be populated here -->
                </div>

                <!-- Voice Recording Indicator -->
                <div id="voiceRecordingIndicator" class="hidden px-4 sm:px-6 py-2 bg-red-50 border-l-4 border-red-500">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span class="text-red-700 font-medium text-sm sm:text-base">Recording... Click to stop</span>
                        <button onclick="stopRecording()" class="ml-auto text-red-700 hover:text-red-900">
                            <i class="fas fa-stop-circle text-lg sm:text-xl"></i>
                        </button>
                    </div>
                </div>

            </div>
            
            <!-- Logout Button -->
            <div class="mt-auto p-2">
                <button onclick="logout()" class="w-full max-w-[140px] sm:max-w-[160px] lg:max-w-[180px] h-6 sm:h-7 lg:h-8 px-2 flex items-center justify-center gap-1.5 font-semibold text-xs text-gray-700 bg-white shadow rounded hover:bg-gray-50 transition-colors">
                    <i class="fas fa-sign-out-alt text-[#F50D0D] w-3 h-3"></i>
                    <span class="text-[#F50D0D]">Log out</span>
                </button>
            </div>
            </div>
        `;

            sidebar.className = "w-52 sm:w-60 lg:w-68 xl:w-[220px] bg-white shadow-md p-2 sm:p-3 fixed md:static top-0 left-0 h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40 flex flex-col";

            if (mainContent) mainContent.style.marginLeft = "0";

            // Restore original content areas padding when sidebar is expanded
            restoreContentPaddingForExpandedSidebar();

            // Re-apply role-based UI after restoring sidebar
            setupRoleBasedUI();
            updateChatHistoryDisplay();
            isCollapsed = false;
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownContent');
            const arrow = document.getElementById('historyArrow');

            if (dropdown && arrow) {
                if (dropdown.classList.contains('hidden')) {
                    dropdown.classList.remove('hidden');
                    arrow.classList.add('fa-chevron-up');
                    arrow.classList.remove('fa-chevron-down');
                } else {
                    dropdown.classList.add('hidden');
                    arrow.classList.remove('fa-chevron-up');
                    arrow.classList.add('fa-chevron-down');
                }
            }
        }

        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        window.location.href = '/auth/login';
                    }
                } else {
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                window.location.href = '/auth/login';
            }
        }

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transform transition-all duration-300 translate-x-full`;

            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-500');
                    break;
                case 'error':
                    notification.classList.add('bg-red-500');
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-500');
                    break;
                default:
                    notification.classList.add('bg-blue-500');
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-start gap-3 mb-2 typing-indicator';
            typingDiv.innerHTML = `
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                AI
            </div>
            <div class="bg-gray-100 rounded-2xl px-4 py-3 w-full">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        `;
            chatMessages.appendChild(typingDiv);
            smoothScrollToBottom(chatMessages);

            // Add subtle pulsing effect to typing indicator
            setTimeout(() => {
                typingDiv.style.animation = 'messagePulse 2s ease-in-out infinite';
            }, 100);
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Enhanced focus and attention functions
        function smoothScrollToBottom(element) {
            element.scrollTo({
                top: element.scrollHeight,
                behavior: 'smooth'
            });
        }

        function smoothScrollToTop(element) {
            element.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function smoothScrollToElement(element, container) {
            const containerRect = container.getBoundingClientRect();
            const elementRect = element.getBoundingClientRect();
            const scrollTop = container.scrollTop + elementRect.top - containerRect.top - 20; // 20px offset from top

            container.scrollTo({
                top: scrollTop,
                behavior: 'smooth'
            });
        }

        function handleLongMessageScrolling(messageElement, chatContainer) {
            const messageBubble = messageElement.querySelector('.message-bubble');
            if (!messageBubble) return;

            // Get the height of the message bubble
            const messageHeight = messageBubble.offsetHeight;
            const containerHeight = chatContainer.clientHeight;

            // If message is longer than 60% of container height, it's considered "long"
            const isLongMessage = messageHeight > (containerHeight * 0.6);

            if (isLongMessage) {
                // For long messages, scroll to show the beginning of the message
                setTimeout(() => {
                    smoothScrollToElement(messageElement, chatContainer);

                    // Add a visual indicator that this is a long message
                    addLongMessageIndicator(messageElement);

                    // After 2 seconds, optionally scroll to bottom to show the end
                    setTimeout(() => {
                        showScrollToBottomOption(chatContainer);
                    }, 2000);
                }, 200);
            } else {
                // For normal messages, scroll to bottom
                smoothScrollToBottom(chatContainer);
            }
        }

        function addLongMessageIndicator(messageElement) {
            const messageBubble = messageElement.querySelector('.message-bubble');
            if (messageBubble) {
                // Add CSS class for long message styling
                messageBubble.classList.add('long-response');

                // Create a container for the hint and button
                const hintContainer = document.createElement('div');
                hintContainer.className = 'flex items-center justify-between mt-2 text-xs text-gray-500 opacity-70';

                // Add scroll hint
                const scrollHint = document.createElement('span');
                scrollHint.innerHTML = 'ðŸ’¡ Long response - scroll down to see more';

                // Add "Jump to End" button
                const jumpBtn = document.createElement('button');
                jumpBtn.className = 'bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200 transition-colors';
                jumpBtn.innerHTML = 'Jump to End';
                jumpBtn.addEventListener('click', () => {
                    const chatContainer = document.getElementById('chatMessages');
                    smoothScrollToBottom(chatContainer);
                });

                hintContainer.appendChild(scrollHint);
                hintContainer.appendChild(jumpBtn);
                messageBubble.appendChild(hintContainer);

                // Add a subtle pulse effect to indicate it's a long message
                messageBubble.style.animation = 'messagePulse 2s ease-in-out';

                // Remove hint after 6 seconds
                setTimeout(() => {
                    if (hintContainer.parentNode) {
                        hintContainer.remove();
                    }
                    // Remove the pulse animation
                    messageBubble.style.animation = '';
                }, 6000);
            }
        }

        function showScrollToBottomOption(chatContainer) {
            // Check if scroll-to-bottom button already exists
            if (document.getElementById('scrollToBottomBtn')) return;

            const scrollBtn = document.createElement('button');
            scrollBtn.id = 'scrollToBottomBtn';
            scrollBtn.className = 'fixed bottom-20 right-4 bg-blue-500 text-white rounded-full p-3 shadow-lg hover:bg-blue-600 transition-all duration-300 z-50';
            scrollBtn.innerHTML = 'â†“';
            scrollBtn.title = 'Scroll to bottom';

            // Add click handler
            scrollBtn.addEventListener('click', () => {
                smoothScrollToBottom(chatContainer);
                scrollBtn.remove();
            });

            // Add to page
            document.body.appendChild(scrollBtn);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (scrollBtn.parentNode) {
                    scrollBtn.remove();
                }
            }, 5000);
        }

        function handleChatScroll(chatContainer) {
            const scrollTop = chatContainer.scrollTop;
            const scrollHeight = chatContainer.scrollHeight;
            const clientHeight = chatContainer.clientHeight;

            // Check if user is near the bottom (within 100px)
            const isNearBottom = (scrollHeight - scrollTop - clientHeight) < 100;

            const scrollBtn = document.getElementById('scrollToBottomBtn');

            if (isNearBottom) {
                // User is near bottom, hide the scroll button
                if (scrollBtn) {
                    scrollBtn.style.opacity = '0';
                    setTimeout(() => {
                        if (scrollBtn.parentNode) {
                            scrollBtn.remove();
                        }
                    }, 300);
                }
            } else {
                // User is not near bottom, show scroll button if there are long messages
                const longMessages = chatContainer.querySelectorAll('.long-response');
                if (longMessages.length > 0 && !scrollBtn) {
                    showScrollToBottomOption(chatContainer);
                }
            }
        }

        function highlightNewMessage(messageElement) {
            // Add pulsing animation to grab attention
            messageElement.style.animation = 'messagePulse 1.5s ease-in-out';

            // Add subtle glow effect
            const messageBubble = messageElement.querySelector('.message-bubble');
            if (messageBubble) {
                messageBubble.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                messageBubble.style.transition = 'box-shadow 0.3s ease';

                // Remove glow after animation
                setTimeout(() => {
                    messageBubble.style.boxShadow = '';
                }, 1500);
            }

            // Remove animation class after completion
            setTimeout(() => {
                messageElement.style.animation = '';
            }, 1500);
        }

        function focusMessageInput() {
            const input = document.getElementById('messageInput');
            if (input) {
                input.focus();
                // Add subtle focus animation
                input.style.transform = 'scale(1.02)';
                input.style.transition = 'transform 0.2s ease';
                setTimeout(() => {
                    input.style.transform = '';
                }, 200);
            }
        }

        function addMessageFocusEffect() {
            // Add CSS for message animations if not already present
            if (!document.getElementById('messageAnimations')) {
                const style = document.createElement('style');
                style.id = 'messageAnimations';
                style.textContent = `
                @keyframes messagePulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.02); opacity: 0.9; }
                    100% { transform: scale(1); opacity: 1; }
                }
                
                .message-container {
                    transition: all 0.3s ease;
                }
                
                .message-bubble {
                    transition: all 0.3s ease;
                }
                
                .message-container:hover {
                    transform: translateY(-1px);
                }
                
                #messageInput:focus {
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                }
                
                .typing-indicator {
                    animation: fadeIn 0.3s ease-in;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                
                .long-message-indicator {
                    border-left: 4px solid #3b82f6 !important;
                    padding-left: 12px !important;
                    transition: all 0.3s ease;
                }
                
                #scrollToBottomBtn {
                    animation: bounceIn 0.5s ease-out;
                }
                
                @keyframes bounceIn {
                    0% { transform: scale(0.3); opacity: 0; }
                    50% { transform: scale(1.05); }
                    70% { transform: scale(0.9); }
                    100% { transform: scale(1); opacity: 1; }
                }
                
                .message-bubble.long-response {
                    position: relative;
                }
                
                .message-bubble.long-response::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    height: 20px;
                    background: linear-gradient(transparent, rgba(255,255,255,0.8));
                    pointer-events: none;
                }
            `;
                document.head.appendChild(style);
            }

            // Add global keyboard shortcuts for better UX
            document.addEventListener('keydown', function (event) {
                // Ctrl/Cmd + Enter to send message
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }

                // Escape to clear input
                if (event.key === 'Escape') {
                    const input = document.getElementById('messageInput');
                    if (input && input === document.activeElement) {
                        input.value = '';
                        autoResizeTextarea(input);
                    }
                }
            });

            // Add click handler to chat messages area to focus input
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.addEventListener('click', function () {
                    focusMessageInput();
                });

                // Add scroll detection for long messages
                chatMessages.addEventListener('scroll', function () {
                    handleChatScroll(chatMessages);
                });
            }
        }

        function addMessageToChat(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start gap-3 mb-2 message-container';

            // Add unique ID for targeting
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            messageDiv.id = messageId;

            if (sender === 'user') {
                messageDiv.innerHTML = `
                <div class="flex items-start gap-3 flex-row-reverse w-full">
                    <div class="w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                        U
                    </div>
                    <div class="bg-blue-500 text-white rounded-2xl px-4 py-3 w-full message-bubble">
                        <p class="leading-relaxed">${message}</p>
                    </div>
                </div>
            `;
            } else {
                messageDiv.innerHTML = `
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                    AI
                </div>
                <div class="bg-gray-100 rounded-2xl px-4 py-3 w-full message-bubble">
                    <p class="text-gray-700 leading-relaxed">${message.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            }

            chatMessages.appendChild(messageDiv);

            // Handle scrolling based on message length
            if (sender === 'ai') {
                setTimeout(() => {
                    handleLongMessageScrolling(messageDiv, chatMessages);
                    highlightNewMessage(messageDiv);
                }, 100);
            } else {
                // For user messages, always scroll to bottom
                smoothScrollToBottom(chatMessages);
            }

            // Save chat to localStorage after adding message
            if (currentChatId) {
                saveChatToLocalStorage();
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';

            // Calculate the new height based on content
            let maxHeight = 200; // Default max height for chat input

            // If it's the lesson edit textarea, allow much larger height
            if (textarea.id === 'inlineEditTextarea') {
                maxHeight = Math.max(textarea.scrollHeight, 200); // At least 200px, but can grow much larger
            } else if (textarea.id === 'humanReviewContent') {
                maxHeight = Math.max(textarea.scrollHeight, 200); // At least 200px, but can grow much larger
            } else if (textarea.id === 'aiReviewPrompt') {
                maxHeight = Math.max(textarea.scrollHeight, 128); // At least 128px, but can grow larger
            }

            const newHeight = Math.min(textarea.scrollHeight, maxHeight);

            // Set the new height
            textarea.style.height = newHeight + 'px';

            // Ensure minimum height
            let minHeight = 48; // Default minimum height
            if (textarea.id === 'inlineEditTextarea' || textarea.id === 'humanReviewContent') {
                minHeight = 200;
            } else if (textarea.id === 'aiReviewPrompt') {
                minHeight = 128;
            }

            if (newHeight < minHeight) {
                textarea.style.height = minHeight + 'px';
            }
        }

        function generateChatTitle(firstMessage) {
            // Generate a meaningful title from the first message
            const words = firstMessage.trim().split(' ');

            // If message is short, use it as is (up to 4 words)
            if (words.length <= 4) {
                return firstMessage.trim();
            }

            // For longer messages, take first few words and add ellipsis
            const title = words.slice(0, 4).join(' ');
            return title.length > 50 ? title.substring(0, 47) + '...' : title;
        }

        async function updateChatTitle(conversationId, newTitle) {
            try {
                const response = await fetch(`/update_conversation_title/${conversationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: newTitle }),
                    credentials: 'include'
                });

                if (response.ok) {
                    // Update the chat title display
                    const chatTitleElement = document.getElementById('chatTitle');
                    if (chatTitleElement) {
                        chatTitleElement.textContent = newTitle;
                    }

                    // Reload chat history to show updated title
                    loadChatHistory();
                }
            } catch (error) {
                console.error('Error updating chat title:', error);
            }
        }



        // Chat history functions
        async function loadChatHistory() {
            try {
                const response = await fetch('/get_conversations', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    chatHistory = data.conversations || [];
                    updateChatHistoryDisplay();
                } else {
                    console.error('Failed to load chat history');
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        function saveChatToHistory() {
            // This would typically be handled by the server
            // after each message is sent
        }

        function saveChatToLocalStorage() {
            if (!currentChatId) return;

            try {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;

                const messages = [];
                const messageElements = chatMessages.querySelectorAll('.flex.items-start.gap-4');

                messageElements.forEach(element => {
                    const isAI = element.querySelector('.bg-blue-500') !== null;
                    const messageText = element.querySelector('.bg-gray-100, .bg-blue-100')?.textContent?.trim();

                    if (messageText) {
                        messages.push({
                            role: isAI ? 'bot' : 'user',
                            message: messageText
                        });
                    }
                });

                // Save chat data to localStorage
                const chatData = {
                    id: currentChatId,
                    messages: messages,
                    timestamp: Date.now()
                };

                localStorage.setItem('chatData_' + currentChatId, JSON.stringify(chatData));
            } catch (error) {
                console.error('Error saving chat to localStorage:', error);
            }
        }

        function clearOldChatData() {
            try {
                // Clear all chat data from localStorage
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('chatData_')) {
                        localStorage.removeItem(key);
                    }
                });
                console.log('Cleared old chat data from localStorage');
            } catch (error) {
                console.error('Error clearing old chat data:', error);
            }
        }

        function updateChatHistoryDisplay() {
            const dropdown = document.getElementById('dropdownContent');
            if (dropdown && chatHistory.length > 0) {
                // Show only the last 4 chat history items for cleaner UI
                const lastFourChats = chatHistory.slice(-4);
                let dropdownHTML = lastFourChats.map(chat => `
                <div class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer" onclick="loadChat('${chat.id}')">
                    <i class="fas fa-comment text-gray-400 text-sm"></i>
                    <span class="text-sm text-gray-700 truncate">${chat.title || 'Untitled Chat'}</span>
                </div>
            `).join('');

                // Add indicator if there are more chats available
                if (chatHistory.length > 4) {
                    dropdownHTML += `
                    <div class="flex items-center gap-2 p-2 text-gray-500 text-xs border-t border-gray-200">
                        <i class="fas fa-info-circle"></i>
                        <span>Showing last 4 of ${chatHistory.length} chats</span>
                    </div>
                    `;
                }

                dropdown.innerHTML = dropdownHTML;
            }
        }

        async function loadChat(chatId) {
            try {
                // Load both messages and conversation details
                const [messagesResponse, conversationResponse] = await Promise.all([
                    fetch(`/get_messages/${chatId}`, {
                        method: 'GET',
                        credentials: 'include'
                    }),
                    fetch(`/get_conversation/${chatId}`, {
                        method: 'GET',
                        credentials: 'include'
                    })
                ]);

                if (messagesResponse.ok && conversationResponse.ok) {
                    const messagesData = await messagesResponse.json();
                    const conversationData = await conversationResponse.json();
                    const messages = messagesData.messages || [];

                    // Clear current chat
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    // Load messages
                    messages.forEach(msg => {
                        // Use msg.role and msg.message for correct mapping
                        addMessageToChat(msg.role === 'bot' ? 'ai' : 'user', msg.message);
                    });

                    currentChatId = chatId;

                    // Update chat title with the actual conversation title
                    const chatTitleElement = document.getElementById('chatTitle');
                    if (chatTitleElement && conversationData.title) {
                        chatTitleElement.textContent = conversationData.title;
                    }

                    changeTab(null, 'chat');
                } else {
                    showNotification('Failed to load chat', 'error');
                }
            } catch (error) {
                console.error('Error loading chat:', error);
                showNotification('Error loading chat', 'error');
            }
        }

        async function downloadCurrentChat() {
            if (!currentChatId) {
                showNotification('No active chat to download', 'error');
                return;
            }

            try {
                const response = await fetch(`/download_chat/${currentChatId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat_${currentChatId}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();

                    showNotification('Chat downloaded successfully!', 'success');
                } else {
                    showNotification('Error downloading chat', 'error');
                }
            } catch (error) {
                console.error('Error downloading chat:', error);
                showNotification('Error downloading chat', 'error');
            }
        }

        async function resetChat() {
            if (confirm('Are you sure you want to reset the current chat?')) {
                try {
                    const response = await fetch('/delete_all_conversations', {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        startNewChat();
                        showNotification('Chat reset successfully!', 'success');
                    } else {
                        showNotification('Error resetting chat', 'error');
                    }
                } catch (error) {
                    console.error('Error resetting chat:', error);
                    showNotification('Error resetting chat', 'error');
                }
            }
        }

        async function checkApiKeyStatus() {
            try {
                const response = await fetch('/check_api_key_status', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (!data.has_api_key) {
                        showNotification('Please set your API key in settings', 'warning');
                    }
                }
            } catch (error) {
                console.error('Error checking API key status:', error);
            }
        }

        async function updateTokenMeter() {
            const bar = document.getElementById('tokenUsageBar');
            const text = document.getElementById('tokenUsageText');
            const resetText = document.getElementById('tokenResetText');

            // Collapsed sidebar elements (removed token meter)

            try {
                const response = await fetch('/token_status', { method: 'GET', credentials: 'include' });
                if (!response.ok) return;
                const data = await response.json();

                const used = Number(data.used || 0);
                const limit = Number(data.limit || 0);
                const remaining = Number(data.remaining || Math.max(limit - used, 0));
                const percent = limit > 0 ? Math.min(100, Math.max(0, Math.round((used / limit) * 100))) : 0;

                if (bar) bar.style.width = percent + '%';

                // Update main sidebar token meter
                if (text) text.textContent = `${used.toLocaleString()}/${limit.toLocaleString()}`;
                if (resetText) {
                    const resetIn = data.reset_in;
                    resetText.textContent = resetIn ? `Reset: ${formatResetIn(resetIn)}` : '';
                }



            } catch (error) {
                console.error('Error updating token meter:', error);
            }
        }

        function formatResetIn(resetIn) {
            // Accepts seconds or readable string
            const seconds = Number(resetIn);
            if (Number.isFinite(seconds)) {
                if (seconds < 60) return `${seconds}s`;
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const remMinutes = minutes % 60;
                return remMinutes ? `${hours}h${remMinutes}m` : `${hours}h`;
            }
            return String(resetIn);
        }

        function startTokenMeterAutoRefresh() {
            if (window.__tokenMeterInterval) return;
            window.__tokenMeterInterval = setInterval(updateTokenMeter, 30000);
        }

        // Helper function for lesson generator button
        function generateLessonButton() {
            openLessonGenerator();
        }

        async function loadUserInfo() {
            const response = await fetch('/user_info', { credentials: 'include' });
            if (!response.ok) throw new Error('Failed to fetch user info');
            const data = await response.json();
            if (data.success && data.user && data.user.role) {
                userRole = data.user.role;
                userInfo = data.user;
                window.userInfo = data.user; // Set window.userInfo for global access
                console.log('DEBUG: userRole set to', userRole); // Debug statement
                console.log('DEBUG: window.userInfo set to', window.userInfo); // Debug statement
                setupRoleBasedUI();
            } else {
                throw new Error('User info missing or invalid');
            }
        }

        // Placeholder loading state functions
        function showLoadingState() {
            // Optionally, show a loading spinner or overlay here
        }
        function hideLoadingState() {
            // Optionally, hide the loading spinner or overlay here
        }

        // Retry loading user info up to 3 times
        async function loadUserInfoWithRetry(retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    await loadUserInfo();
                    return;
                } catch (e) {
                    await new Promise(res => setTimeout(res, 500));
                }
            }
            throw new Error('Failed to load user info after retries');
        }

        // Handle authentication failure by redirecting to login
        function handleAuthenticationFailure() {
            window.location.href = '/login';
        }

        // View lesson details and versions
        async function viewLesson(lessonId, lessonTitle) {
            try {
                const response = await fetch(`/api/lessons/lesson/${lessonId}/view`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const lesson = data.lesson;
                    const versions = data.versions || [];

                    // Debug logging
                    console.log('Lesson data:', lesson);
                    console.log('Versions data:', versions);
                    console.log('Versions length:', versions.length);

                    // Sort versions by version number (newest first)
                    const sortedVersions = versions.sort((a, b) => (b.version || 1) - (a.version || 1));
                    const currentVersion = sortedVersions[0]; // Newest version

                    // Store versions data for switching
                    window.currentLessonVersions = sortedVersions;

                    // Check user role to show appropriate modal
                    const userRole = window.userInfo?.role || 'student';
                    console.log('DEBUG: viewLesson - window.userInfo:', window.userInfo);
                    console.log('DEBUG: viewLesson - userRole:', userRole);

                    if (userRole === 'teacher') {
                        // Teachers see AI versioning modal
                        console.log('DEBUG: Showing AI versioning for teacher');
                        if (currentVersion.has_child_version === true) {
                            showNotification('This lesson version is locked (already created a child). You cannot create another version from it.', 'warning');
                        }
                        showAIVersioning(currentVersion.id);
                    } else {
                        // Students see lesson view modal with ask question functionality
                        console.log('DEBUG: Showing student lesson modal for student');
                        showStudentLessonModal(currentVersion);
                    }

                } else {
                    showNotification('Failed to load lesson details', 'error');
                }
            } catch (error) {
                console.error('Error viewing lesson:', error);
                showNotification('Error loading lesson details', 'error');
            }
        }

        // Switch between versions
        function switchVersion() {
            const versionSelect = document.getElementById('versionSelect');
            const selectedVersionId = parseInt(versionSelect.value);
            const selectedVersion = window.currentLessonVersions.find(v => v.id === selectedVersionId);

            if (selectedVersion) {
                // Update lesson details
                document.getElementById('lessonSubject').textContent = selectedVersion.focus_area || 'Not specified';
                document.getElementById('lessonGrade').textContent = selectedVersion.grade_level || 'Not specified';
                document.getElementById('lessonObjectives').textContent = selectedVersion.lesson_prompt || 'Not specified';
                document.getElementById('lessonSummary').textContent = selectedVersion.summary || 'Not specified';
                document.getElementById('lessonCreated').textContent = new Date(selectedVersion.created_at).toLocaleDateString();
                document.getElementById('lessonVersion').textContent = selectedVersion.version || 1;
                const lessonContentEl = document.getElementById('lessonContent');
                if (lessonContentEl) {
                    const content = selectedVersion.content || 'No content available';
                    if (content !== 'No content available') {
                        lessonContentEl.innerHTML = formatLessonContentWithNumbers(content);
                    } else {
                        lessonContentEl.innerHTML = content;
                    }
                }

                // Update AI Improve button to use current version
                const aiButton = document.querySelector('button[onclick*="showAIVersioning"]');
                if (aiButton) {
                    aiButton.setAttribute('onclick', `showAIVersioning(${selectedVersion.id})`);
                }


            }
        }



        // Download lesson as PowerPoint
        async function downloadLessonPPT(lessonId) {
            try {
                const response = await fetch(`/api/lessons/download_lesson_ppt/${lessonId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const a = document.createElement('a');
                    a.href = window.URL.createObjectURL(blob);

                    // Get filename from Content-Disposition header or use default
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `lesson_${lessonId}.pptx`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(a.href);
                    a.remove();
                    showNotification('Lesson downloaded as PowerPoint!', 'success');
                } else {
                    const errorData = await response.json();
                    showNotification(`Error downloading PowerPoint: ${errorData.error || 'Download failed'}`, 'error');
                }
            } catch (error) {
                console.error('Error downloading PowerPoint:', error);
                showNotification('Error downloading PowerPoint. Please try again.', 'error');
            }
        }

        // Compare two versions of a lesson
        async function compareVersions(version1Id, version2Id) {
            try {
                const [response1, response2] = await Promise.all([
                    fetch(`/api/lessons/lesson/${version1Id}`, {
                        method: 'GET',
                        credentials: 'include'
                    }),
                    fetch(`/api/lessons/lesson/${version2Id}`, {
                        method: 'GET',
                        credentials: 'include'
                    })
                ]);

                if (response1.ok && response2.ok) {
                    const data1 = await response1.json();
                    const data2 = await response2.json();

                    const lesson1 = data1.lesson;
                    const lesson2 = data2.lesson;

                    // Create comparison modal
                    const comparisonContent = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-7xl w-full mx-4 max-h-[90vh] overflow-y-auto transition-all duration-300" id="comparisonModalContent">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-900">Version Comparison</h2>
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleModalFullscreen('comparisonModal')" class="text-gray-500 hover:text-gray-700 p-1 rounded" title="Toggle Fullscreen">
                                        <i class="fas fa-expand text-lg" id="comparisonModalFullscreenIcon"></i>
                                    </button>
                                <button onclick="closeComparisonModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-3 text-blue-600">Version ${lesson1.version} (${new Date(lesson1.created_at).toLocaleDateString()})</h3>
                                    <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                                        <div class="text-gray-900">${lesson1.content ? formatLessonContentWithNumbers(lesson1.content) : 'No content available'}</div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-3 text-green-600">Version ${lesson2.version} (${new Date(lesson2.created_at).toLocaleDateString()})</h3>
                                    <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                                        <div class="text-gray-900">${lesson2.content ? formatLessonContentWithNumbers(lesson2.content) : 'No content available'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2">Key Differences:</h4>
                                <ul class="text-yellow-700 text-sm space-y-1">
                                    <li>â€¢ Content length: ${lesson1.content?.length || 0} vs ${lesson2.content?.length || 0} characters</li>
                                    <li>â€¢ Created: ${new Date(lesson1.created_at).toLocaleString()} vs ${new Date(lesson2.created_at).toLocaleString()}</li>
                                    <li>â€¢ Version numbers: ${lesson1.version} vs ${lesson2.version}</li>
                                </ul>
                            </div>
                            
                            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                                <button onclick="closeComparisonModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                    // Add comparison modal to page
                    const comparisonContainer = document.createElement('div');
                    comparisonContainer.id = 'comparisonModal';
                    comparisonContainer.innerHTML = comparisonContent;
                    document.body.appendChild(comparisonContainer);

                } else {
                    showNotification('Failed to load lesson versions for comparison', 'error');
                }
            } catch (error) {
                console.error('Error comparing versions:', error);
                showNotification('Error comparing versions', 'error');
            }
        }

        function closeComparisonModal() {
            // Exit fullscreen if active
            const modalContent = document.getElementById('comparisonModalContent');
            if (modalContent && modalContent.classList.contains('fullscreen')) {
                toggleModalFullscreen('comparisonModal');
            }

            const modal = document.getElementById('comparisonModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeLessonModal() {
            // Exit fullscreen if active
            const modalContent = document.getElementById('lessonModalContent');
            if (modalContent && modalContent.classList.contains('fullscreen')) {
                toggleModalFullscreen('lessonModal');
            }

            const modal = document.getElementById('lessonModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show student lesson modal with ask question functionality
        function showStudentLessonModal(lesson) {
            const studentModalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto transition-all duration-300" id="studentLessonModalContent">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">${lesson.title || 'Untitled Lesson'}</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleModalFullscreen('studentLessonModal')" class="text-gray-500 hover:text-gray-700 p-1 rounded" title="Toggle Fullscreen">
                                <i class="fas fa-expand text-lg" id="studentLessonModalFullscreenIcon"></i>
                            </button>
                            <button onclick="closeStudentLessonModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column: Lesson Content -->
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Lesson Details</h3>
                                <div class="space-y-2 text-sm">
                                    ${lesson.summary ? `<div><strong>Summary:</strong> ${lesson.summary}</div>` : ''}
                                    ${lesson.lesson_prompt ? `<div><strong>Lesson Prompt:</strong> ${lesson.lesson_prompt}</div>` : ''}
                                    ${lesson.focus_area ? `<div><strong>Focus Area:</strong> ${lesson.focus_area}</div>` : ''}
                                    ${lesson.grade_level ? `<div><strong>Grade Level:</strong> ${lesson.grade_level}</div>` : ''}
                                </div>
                            </div>

                            <div class="bg-white border rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Lesson Content</h3>
                                <div class="prose max-w-none markdown-content zoomable-content" id="studentLessonContent">
                                    ${lesson.content ? formatLessonContentWithNumbers(lesson.content) : 'No content available'}
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Ask Question Section -->
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-blue-800 mb-3">
                                    <i class="fas fa-question-circle mr-2"></i>Ask Questions
                                </h3>
                                <p class="text-blue-700 text-sm mb-4">Have questions about this lesson? Ask the AI assistant for help!</p>
                                
                                <!-- Question Input -->
                                <div class="space-y-3">
                                    <textarea 
                                        id="studentQuestionInput" 
                                        rows="3" 
                                        class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" 
                                        placeholder="Ask a question about this lesson..."
                                    ></textarea>
                                    <button 
                                        onclick="submitStudentQuestion(${lesson.id}, '${lesson.title}')" 
                                        class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                                        id="submitStudentQuestionBtn"
                                    >
                                        <i class="fas fa-paper-plane mr-2"></i>Ask Question
                                    </button>
                                </div>
                            </div>

                            <!-- Previous Questions History -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-sm font-semibold text-gray-700">Previous Questions</h4>
                                    <button onclick="clearStudentLessonHistory(${lesson.id})" class="text-xs text-red-600 hover:text-red-800 px-2 py-1 rounded hover:bg-red-50">
                                        <i class="fas fa-trash mr-1"></i>Clear History
                                    </button>
                                </div>
                                <div id="studentLessonQnAHistory" class="max-h-64 overflow-y-auto space-y-3">
                                    <div class="text-gray-500 text-center py-4">Loading previous questions...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button onclick="downloadLessonFile(${lesson.id})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>Download DOCX
                        </button>
                        <button onclick="downloadLessonPPT(${lesson.id})" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">
                            <i class="fas fa-file-powerpoint mr-2"></i>Download PPT
                        </button>
                        <button onclick="closeStudentLessonModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;

            const studentModalContainer = document.createElement('div');
            studentModalContainer.id = 'studentLessonModal';
            studentModalContainer.innerHTML = studentModalContent;
            document.body.appendChild(studentModalContainer);

            // Load previous questions for this lesson
            loadStudentLessonChatHistory(lesson.id);
        }

        // Close student lesson modal
        function closeStudentLessonModal() {
            const modalContent = document.getElementById('studentLessonModalContent');
            if (modalContent && modalContent.classList.contains('fullscreen')) {
                toggleModalFullscreen('studentLessonModal');
            }

            const modal = document.getElementById('studentLessonModal');
            if (modal) {
                modal.remove();
            }
        }

        // Load lesson chat history for student modal
        async function loadStudentLessonChatHistory(lessonId) {
            try {
                const response = await fetch(`/api/lessons/lesson_chat_history/${lessonId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayStudentLessonChatHistory(data.history || []);
                } else {
                    console.error('Failed to load lesson chat history');
                    displayStudentLessonChatHistory([]);
                }
            } catch (error) {
                console.error('Error loading lesson chat history:', error);
                displayStudentLessonChatHistory([]);
            }
        }

        // Display lesson chat history in student modal
        function displayStudentLessonChatHistory(history) {
            const qnaDiv = document.getElementById('studentLessonQnAHistory');
            if (!qnaDiv) return;

            if (history.length === 0) {
                qnaDiv.innerHTML = '<div class="text-gray-500 text-center py-4">No previous questions for this lesson</div>';
                return;
            }

            let historyHtml = '';
            history.forEach(item => {
                historyHtml += `
                    <div class="bg-white p-3 rounded border">
                        <div class="mb-2">
                            <span class="font-semibold text-blue-700">You:</span> 
                            <span class="text-gray-800">${item.question}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-green-700">AI:</span> 
                            <span class="text-gray-800">${item.answer}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${new Date(item.created_at).toLocaleString()}
                        </div>
                    </div>
                `;
            });
            qnaDiv.innerHTML = historyHtml;
            qnaDiv.scrollTop = qnaDiv.scrollHeight;
        }

        // Submit question from student modal
        async function submitStudentQuestion(lessonId, lessonTitle) {
            const questionInput = document.getElementById('studentQuestionInput');
            const question = questionInput.value.trim();

            if (!question) {
                showNotification('Please enter a question', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitStudentQuestionBtn');
            const originalText = submitBtn.innerHTML;

            try {
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Asking...';
                submitBtn.disabled = true;

                // Check for line references in the question
                const lineReferences = parseLineReference(question);

                // Highlight referenced lines if any
                if (lineReferences.length > 0) {
                    lineReferences.forEach(lineNumber => {
                        highlightLineReference(lineNumber);
                    });
                }

                const response = await fetch('/api/lessons/ask_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lesson_id: lessonId,
                        question: question
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();

                    // Add the new Q&A to the history display
                    const qnaDiv = document.getElementById('studentLessonQnAHistory');
                    if (qnaDiv) {
                        const newQnA = `
                            <div class="bg-white p-3 rounded border">
                                <div class="mb-2">
                                    <span class="font-semibold text-blue-700">You:</span> 
                                    <span class="text-gray-800">${question}</span>
                                </div>
                                <div>
                                    <span class="font-semibold text-green-700">AI:</span> 
                                    <span class="text-gray-800">${data.answer}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${new Date().toLocaleString()}
                                </div>
                            </div>
                        `;

                        // Remove "no questions" message if it exists
                        if (qnaDiv.innerHTML.includes('No previous questions')) {
                            qnaDiv.innerHTML = '';
                        }

                        qnaDiv.innerHTML += newQnA;
                        qnaDiv.scrollTop = qnaDiv.scrollHeight;
                    }

                    // Clear the input
                    questionInput.value = '';
                    showNotification('Question answered successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    showNotification(`Error: ${errorData.error || 'Failed to get answer'}`, 'error');
                }
            } catch (error) {
                console.error('Error asking question:', error);
                showNotification('Error asking question', 'error');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Clear student lesson chat history
        async function clearStudentLessonHistory(lessonId) {
            if (!confirm('Are you sure you want to clear all questions for this lesson? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/lessons/clear_lesson_chat_history/${lessonId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showNotification('Lesson chat history cleared successfully', 'success');
                    loadStudentLessonChatHistory(lessonId);
                } else {
                    showNotification('Failed to clear lesson chat history', 'error');
                }
            } catch (error) {
                console.error('Error clearing lesson chat history:', error);
                showNotification('Error clearing lesson chat history', 'error');
            }
        }

        function editLesson(lessonId) {
            // Close the modal first
            closeLessonModal();

            // Switch to lesson generation view for editing
            hideAllContentAreas();

            // Hide download button for non-chat views
            const downloadBtn = document.getElementById('chatDownloadBtn');
            if (downloadBtn) {
                downloadBtn.classList.add('hidden');
            }

            document.getElementById('lessonGeneratorContent').classList.remove('hidden');
            currentView = 'lessonGenerator';

            // Update chat header
            document.getElementById('chatTitle').textContent = 'Edit Lesson';
            document.getElementById('chatStatus').textContent = 'Create New Version';

            // Load lesson data for editing
            loadLessonForEditing(lessonId);
        }

        async function loadLessonForEditing(lessonId) {
            try {
                const response = await fetch(`/api/lessons/lesson/${lessonId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const lesson = data.lesson;

                    // Populate form fields with current lesson data
                    document.getElementById('lessonTitle').value = lesson.title;
                    document.getElementById('lessonPrompt').value = lesson.lesson_prompt;
                    document.getElementById('focusArea').value = lesson.focus_area;
                    document.getElementById('gradeLevel').value = lesson.grade_level;
                    document.getElementById('additionalNotes').value = lesson.summary || '';

                    // Store the lesson data for versioning
                    currentLessonData = lesson;
                    generatedLessonContent = lesson.content || '';

                    // Store the original lesson ID for versioning
                    window.editingLessonId = lessonId;

                    // Update the submit button text
                    const generateBtnText = document.getElementById('generateBtnText');
                    if (generateBtnText) {
                        generateBtnText.textContent = 'Create New Version';
                    }

                } else {
                    showNotification('Failed to load lesson for editing', 'error');
                }
            } catch (error) {
                console.error('Error loading lesson for editing:', error);
                showNotification('Error loading lesson for editing', 'error');
            }
        }

        // Show AI versioning modal
        function showAIVersioning(lessonId) {
            // Determine the source version content and metadata
            let selectedVersion = null;
            if (Array.isArray(window.currentLessonVersions)) {
                selectedVersion = window.currentLessonVersions.find(v => v.id === lessonId) || window.currentLessonVersions[0];
            }

            // If we don't have version data, fetch the lesson directly
            if (!selectedVersion) {
                fetch(`/api/lessons/lesson/${lessonId}`, { method: 'GET', credentials: 'include' })
                    .then(r => r.ok ? r.json() : Promise.reject())
                    .then(data => {
                        selectedVersion = data.lesson;
                        checkVersionCreationStatus(selectedVersion);
                    })
                    .catch(() => {
                        showNotification('Failed to load lesson content', 'error');
                    });
                return;
            }

            // Check version creation status before showing modal using fresh data
            checkVersionCreationStatusWithFreshData(selectedVersion);
        }

        // Check if a version can be created from the current lesson
        async function checkVersionCreationStatus(selectedVersion) {
            try {
                // Refresh lesson data to ensure we have the latest information
                await refreshLessonData();

                // Determine the parent lesson ID
                const parentLessonId = selectedVersion.parent_lesson_id || selectedVersion.id;

                // Check version creation rules
                let canCreateVersion = false;
                let reason = '';
                let existingVersionId = null;

                console.log('Checking version status for:', {
                    selectedVersionId: selectedVersion.id,
                    parentLessonId: parentLessonId,
                    isParentLesson: !selectedVersion.parent_lesson_id,
                    versionNumber: selectedVersion.version_number || 1
                });

                // Calculate the depth level of this lesson
                const depthLevel = calculateVersionDepth(selectedVersion);
                console.log('Version depth level:', depthLevel);

                // Combine all lessons for comprehensive checking
                const allLessons = [
                    ...(window.currentLessonVersions || []),
                    ...(window.availableLessons || [])
                ];

                console.log('All lessons for checking:', allLessons.map(l => ({
                    id: l.id,
                    title: l.title,
                    parent_lesson_id: l.parent_lesson_id,
                    parent_version_id: l.parent_version_id,
                    version_number: l.version_number
                })));

                // Check if this lesson already has a child version
                const hasChildVersion = (selectedVersion.has_child_version === true) || hasChildVersions(selectedVersion.id, allLessons);

                // Additional debugging - check both parent_lesson_id and parent_version_id
                const childrenByParentLessonId = allLessons.filter(lesson =>
                    lesson.parent_lesson_id === selectedVersion.id && lesson.id !== selectedVersion.id
                );
                const childrenByParentVersionId = allLessons.filter(lesson =>
                    lesson.parent_version_id === selectedVersion.id && lesson.id !== selectedVersion.id
                );

                console.log('Children by parent_lesson_id:', childrenByParentLessonId);
                console.log('Children by parent_version_id:', childrenByParentVersionId);
                console.log('Has child version result:', hasChildVersion);

                if (hasChildVersion) {
                    // Find the child version for logging
                    const childVersion = allLessons.find(lesson =>
                        (lesson.parent_lesson_id === selectedVersion.id || lesson.parent_version_id === selectedVersion.id) &&
                        lesson.id !== selectedVersion.id
                    );
                    existingVersionId = childVersion ? childVersion.id : null;
                    console.log('Found existing child version:', childVersion);
                }

                // Apply version creation rules
                if (hasChildVersion) {
                    canCreateVersion = false;
                    reason = 'This lesson already has a version created from it. You can only create one version per lesson. Please use the existing version to create additional versions.';
                } else if (depthLevel >= 3) {
                    canCreateVersion = false;
                    reason = 'Maximum version depth reached. You cannot create more than 3 levels of versions (Original â†’ Child â†’ Grandchild).';
                } else {
                    canCreateVersion = true;
                    reason = '';
                }

                console.log('Version check result:', {
                    canCreateVersion,
                    hasChildVersion,
                    depthLevel,
                    reason,
                    existingVersionId
                });

                // Show modal with appropriate status
                showAIVersioningModal(selectedVersion, !canCreateVersion, existingVersionId, reason);

            } catch (error) {
                console.error('Error checking version status:', error);
                // Fallback to old behavior
                showAIVersioningModal(selectedVersion, false, null);
            }
        }

        // Calculate the depth level of a version in the hierarchy
        function calculateVersionDepth(lesson) {
            let depth = 1; // Start with 1 for the original lesson

            // If this lesson has a parent_lesson_id, it's a child version
            if (lesson.parent_lesson_id) {
                depth = 2; // Child level

                // Check if the parent is also a child (making this a grandchild)
                const allLessons = [
                    ...(window.currentLessonVersions || []),
                    ...(window.availableLessons || [])
                ];

                const parentLesson = allLessons.find(l => l.id === lesson.parent_lesson_id);
                if (parentLesson && parentLesson.parent_lesson_id) {
                    depth = 3; // Grandchild level
                }
            }

            return depth;
        }

        // Check if a lesson has any child versions (more comprehensive check)
        function hasChildVersions(lessonId, allLessons) {
            // Check if this lesson already has a child version
            // Each lesson can only have ONE child version
            const children = allLessons.filter(lesson =>
                (lesson.parent_lesson_id === lessonId || lesson.parent_version_id === lessonId) &&
                lesson.id !== lessonId
            );

            const hasChild = children.length > 0;

            console.log(`Checking if lesson ${lessonId} has child versions:`, {
                lessonId,
                allLessonsCount: allLessons.length,
                hasChild,
                childrenCount: children.length,
                children: children.map(l => ({
                    id: l.id,
                    title: l.title,
                    parent_lesson_id: l.parent_lesson_id,
                    parent_version_id: l.parent_version_id,
                    version_number: l.version_number || l.version
                }))
            });

            return hasChild;
        }

        // Enhanced version check that fetches fresh data from server
        async function checkVersionCreationStatusWithFreshData(selectedVersion) {
            try {
                console.log('Fetching fresh lesson data for version check...');

                // Add a small delay to ensure server has processed any recent changes
                await new Promise(resolve => setTimeout(resolve, 500));

                // Fetch fresh lesson data from server
                const response = await fetch('/api/lessons/my_lessons', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch fresh lesson data');
                }

                const data = await response.json();
                const freshLessons = data.lessons || [];

                console.log('Fresh lessons data:', freshLessons.length);

                // Check if this lesson already has a child version using fresh data
                const hasChildVersion = hasChildVersions(selectedVersion.id, freshLessons);

                // Calculate depth level
                const depthLevel = calculateVersionDepth(selectedVersion);

                let canCreateVersion = false;
                let reason = '';
                let existingVersionId = null;

                if (hasChildVersion) {
                    // Find the child version for logging
                    const childVersion = freshLessons.find(lesson =>
                        (lesson.parent_lesson_id === selectedVersion.id || lesson.parent_version_id === selectedVersion.id) &&
                        lesson.id !== selectedVersion.id
                    );
                    existingVersionId = childVersion ? childVersion.id : null;

                    canCreateVersion = false;
                    reason = 'This lesson already has a version created from it. You can only create one version per lesson. Please use the existing version to create additional versions.';
                } else if (depthLevel >= 3) {
                    canCreateVersion = false;
                    reason = 'Maximum version depth reached. You cannot create more than 3 levels of versions (Original â†’ Child â†’ Grandchild).';
                } else {
                    canCreateVersion = true;
                    reason = '';
                }

                console.log('Fresh data version check result:', {
                    canCreateVersion,
                    hasChildVersion,
                    depthLevel,
                    reason,
                    existingVersionId
                });

                // Show modal with appropriate status
                showAIVersioningModal(selectedVersion, !canCreateVersion, existingVersionId, reason);

            } catch (error) {
                console.error('Error checking version status with fresh data:', error);
                // Fallback to old behavior
                showAIVersioningModal(selectedVersion, false, null);
            }
        }

        // Refresh lesson data to ensure we have the latest information
        async function refreshLessonData() {
            try {
                // Refresh available lessons
                if (window.userInfo && window.userInfo.role === 'teacher') {
                    const response = await fetch('/api/lessons/my_lessons', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        window.availableLessons = data.lessons || [];
                        console.log('Refreshed available lessons:', window.availableLessons.length);

                        // Also refresh current lesson versions if we have a specific lesson context
                        if (window.currentLessonVersions && window.currentLessonVersions.length > 0) {
                            // Get the lesson group for the current lesson
                            const currentLessonId = window.currentLessonVersions[0].id;
                            const parentLessonId = window.currentLessonVersions[0].parent_lesson_id || currentLessonId;

                            // Find all versions of this lesson group
                            const lessonGroup = window.availableLessons.filter(lesson =>
                                lesson.id === parentLessonId || lesson.parent_lesson_id === parentLessonId
                            );

                            if (lessonGroup.length > 0) {
                                window.currentLessonVersions = lessonGroup;
                                console.log('Refreshed current lesson versions:', window.currentLessonVersions.length);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing lesson data:', error);
            }
        }

        function showAIVersioningModal(selectedVersion, versionExists = false, existingVersionId = null, reason = '') {

            // Determine if we can create a new version
            const canCreateVersion = !versionExists && selectedVersion.has_child_version !== true;
            const isParentLesson = !selectedVersion.parent_lesson_id;

            const aiModalContent = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="aiVersioningModal">
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto transition-all duration-300" id="aiVersioningModalContent">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">${canCreateVersion ? 'AI-Powered Lesson Improvement' : 'Lesson View'} - ${selectedVersion.title || 'Untitled Lesson'}</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleModalFullscreen('aiVersioningModal')" class="text-gray-500 hover:text-gray-700 p-1 rounded" title="Toggle Fullscreen">
                                <i class="fas fa-expand text-lg" id="aiVersioningModalFullscreenIcon"></i>
                            </button>
                        <button onclick="closeAIVersioningModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                        </div>
                        
                    ${canCreateVersion ? `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Improvement Request</label>
                            <textarea id="improvementPrompt" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe changes (e.g., simplify language, add examples, align to grade)"></textarea>

                            <div class="bg-blue-50 p-3 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">How it works</h4>
                            <ul class="text-blue-700 text-sm space-y-1">
                                    <li>â€¢ Current version content is shown by default</li>
                                    <li>â€¢ Apply prompts to create draft content</li>
                                    <li>â€¢ Multiple prompts update the draft iteratively</li>
                                    <li>â€¢ Finalize creates a new version from the draft</li>
                                    <li>â€¢ Only versions without child versions can create new versions</li>
                            </ul>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Current Version Content (read-only)</label>
                            <div class="bg-gray-50 p-3 rounded border max-h-56 overflow-y-auto text-sm markdown-content" id="aiCurrentVersionContentPreview">Loading...</div>

                            <label class="block text-sm font-medium text-gray-700">Draft Content (iteratively updated)</label>
                            <div class="bg-white p-3 rounded border max-h-56 overflow-y-auto text-sm markdown-content" id="aiDraftContentPreview">Draft content will appear here after applying AI prompts...</div>
                            
                            <!-- Human Edit (collapsible) -->
                            <div class="pt-2">
                                <button id="toggleHumanEditBtn" class="px-3 py-1.5 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200" onclick="toggleHumanEdit()"><i class="fas fa-user-edit mr-1"></i>Edit with Human</button>
                                <div id="humanEditContainer" class="hidden mt-2">
                                    <textarea id="humanEditTextarea" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Manually edit the draft content here..."></textarea>
                                    <div class="flex justify-end gap-2 mt-2">
                                        <button class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" onclick="cancelHumanEdit()">Cancel</button>
                                        <button class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="saveHumanEdit()"><i class="fas fa-save mr-1"></i>Save to Draft</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : `
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded border">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Version Content (read-only)</label>
                                <div class="bg-white p-3 rounded border max-h-64 overflow-y-auto text-sm markdown-content" id="aiCurrentVersionContentPreview">Loading...</div>
                            </div>
                        </div>
                    `}
                    
                    ${!canCreateVersion ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                                <div>
                                    <h4 class="text-yellow-800 font-semibold">Version Already Exists</h4>
                                    <p class="text-yellow-700 text-sm mt-1">
                                        ${reason || 'A version has already been created from this lesson. You can only create one version per lesson. Please use the existing version to create additional versions.'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button onclick="closeAIVersioningModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">${canCreateVersion ? 'Cancel' : 'Close'}</button>
                        ${canCreateVersion ? `
                                <button onclick="applyAIPromptToDraft(${selectedVersion.id}, event)" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700" id="applyAIPromptBtn"><i class="fas fa-magic mr-2"></i>Apply Prompt</button>
                                <button onclick="finalizeAIVersion(${selectedVersion.id}, event)" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" id="finalizeAIVersionBtn">Finalize New Version</button>
                        ` : `<span class="px-3 py-2 text-sm text-red-600">Versioning disabled for this lesson</span>`}
                    </div>
                </div>
            </div>
        `;

            const aiModalContainer = document.createElement('div');
            aiModalContainer.id = 'aiVersioningModal';
            aiModalContainer.innerHTML = aiModalContent;
            document.body.appendChild(aiModalContainer);

            // Version creation is now restricted - only lessons without child versions can create new versions

            // Initialize the modal with original content and any existing draft
            const setInitialState = (versionData) => {
                const meta = {
                    title: versionData?.title || '',
                    lesson_prompt: versionData?.lesson_prompt || '',
                    focus_area: versionData?.focus_area || '',
                    grade_level: versionData?.grade_level || '',
                    summary: versionData?.summary || ''
                };
                window.aiVersioningLessonMeta = meta;

                // Store the original lesson ID for versioning
                if (versionData.parent_lesson_id) {
                    window.aiVersioningOriginalLessonId = versionData.parent_lesson_id;
                } else {
                    window.aiVersioningOriginalLessonId = versionData.id;
                }

                // Load original content and any existing draft content
                loadLessonContentAndDraft(versionData.id);
            };

            // Record current lesson id for draft operations
            window.aiVersioningCurrentLessonId = selectedVersion.id;

            // Human edit helpers for Teacher View
            window.toggleHumanEdit = function () {
                const container = document.getElementById('humanEditContainer');
                const textarea = document.getElementById('humanEditTextarea');
                const draft = window.aiVersioningDraftContent || '';
                container.classList.toggle('hidden');
                if (!container.classList.contains('hidden')) {
                    textarea.value = draft && draft.trim() ? draft : (window.aiVersioningOriginalContent || '');
                }
            };

            window.cancelHumanEdit = function () {
                const container = document.getElementById('humanEditContainer');
                if (container) container.classList.add('hidden');
            };

            window.saveHumanEdit = async function () {
                const textarea = document.getElementById('humanEditTextarea');
                const draftEl = document.getElementById('aiDraftContentPreview');
                const newContent = (textarea?.value || '').trim();
                if (!newContent) {
                    showNotification('Please enter some content', 'error');
                    return;
                }
                // Save to the same draft used by Apply Prompt
                window.aiVersioningDraftContent = newContent;
                if (draftEl) {
                    draftEl.innerHTML = marked.parse(newContent);
                }
                // Persist draft to backend so finalization works
                const lessonId = window.aiVersioningCurrentLessonId;
                if (lessonId) {
                    try {
                        const resp = await fetch(`/api/lessons/lesson/${lessonId}/save_draft`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ draft_content: newContent })
                        });
                        if (!resp.ok) {
                            const err = await resp.json().catch(() => ({}));
                            showNotification(`Failed to save draft: ${err.error || 'Unknown error'}`, 'error');
                        } else {
                            showNotification('Changes saved to draft', 'success');
                            window.cancelHumanEdit();
                        }
                    } catch (e) {
                        showNotification('Network error saving draft', 'error');
                    }
                } else {
                    showNotification('Draft updated locally. Lesson id missing for save.', 'warning');
                }
            };

            // Function to load original content and draft content
            const loadLessonContentAndDraft = async (lessonId) => {
                try {
                    // Get draft content and original content
                    const response = await fetch(`/api/lessons/lesson/${lessonId}/get_draft`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const originalContent = data.original_content || ''; // Actual original content
                        const currentContent = data.current_content || '';   // Current version's content
                        const draftContent = data.draft_content || '';

                        // Store the content
                        window.aiVersioningOriginalContent = originalContent;
                        window.aiVersioningDraftContent = draftContent;

                        // Update the UI
                        const currentVersionEl = document.getElementById('aiCurrentVersionContentPreview');
                        const draftEl = document.getElementById('aiDraftContentPreview');

                        if (currentVersionEl) {
                            // Show the current version's content (not the original)
                            currentVersionEl.innerHTML = currentContent ? marked.parse(currentContent) : 'No content available';
                        }

                        if (draftEl) {
                            // All versions can have draft content
                            if (draftContent) {
                                draftEl.innerHTML = marked.parse(draftContent);
                            } else {
                                draftEl.textContent = 'Draft content will appear here after applying AI prompts...';
                            }
                        }
                    } else {
                        // Fallback to current version content
                        const currentContent = selectedVersion.content || '';
                        let originalContent = currentContent;

                        // If this is a version, try to get the original content
                        if (selectedVersion.parent_lesson_id) {
                            try {
                                const originalResponse = await fetch(`/api/lessons/lesson/${selectedVersion.parent_lesson_id}`, {
                                    method: 'GET',
                                    credentials: 'include'
                                });
                                if (originalResponse.ok) {
                                    const originalData = await originalResponse.json();
                                    originalContent = originalData.lesson.content || '';
                                }
                            } catch (error) {
                                console.error('Error fetching original lesson content:', error);
                            }
                        }

                        window.aiVersioningOriginalContent = originalContent;
                        window.aiVersioningDraftContent = '';

                        const currentVersionEl = document.getElementById('aiCurrentVersionContentPreview');
                        const draftEl = document.getElementById('aiDraftContentPreview');

                        if (currentVersionEl) {
                            // Show the current version's content (not the original)
                            currentVersionEl.innerHTML = currentContent ? marked.parse(currentContent) : 'No content available';
                        }

                        if (draftEl) {
                            // All versions can have draft content
                            draftEl.textContent = 'Draft content will appear here after applying AI prompts...';
                        }
                    }
                } catch (error) {
                    console.error('Error loading lesson content and draft:', error);
                    // Fallback to current version content
                    const currentContent = selectedVersion.content || '';
                    let originalContent = currentContent;

                    // If this is a version, try to get the original content
                    if (selectedVersion.parent_lesson_id) {
                        try {
                            const originalResponse = await fetch(`/api/lessons/lesson/${selectedVersion.parent_lesson_id}`, {
                                method: 'GET',
                                credentials: 'include'
                            });
                            if (originalResponse.ok) {
                                const originalData = await originalResponse.json();
                                originalContent = originalData.lesson.content || '';
                            }
                        } catch (fetchError) {
                            console.error('Error fetching original lesson content:', fetchError);
                        }
                    }

                    window.aiVersioningOriginalContent = originalContent;
                    window.aiVersioningDraftContent = '';

                    const currentVersionEl = document.getElementById('aiCurrentVersionContentPreview');
                    const draftEl = document.getElementById('aiDraftContentPreview');

                    if (currentVersionEl) {
                        // Show the current version's content (not the original)
                        currentVersionEl.innerHTML = currentContent ? marked.parse(currentContent) : 'No content available';
                    }

                    if (draftEl) {
                        // All versions can have draft content
                        draftEl.textContent = 'Draft content will appear here after applying AI prompts...';
                    }
                }
            };

            // Initialize with the selected version data
            if (selectedVersion) {
                setInitialState(selectedVersion);
            } else {
                // Fallback if no version data
                const fallbackData = {
                    title: 'Untitled Lesson',
                    content: '',
                    lesson_prompt: '',
                    focus_area: '',
                    grade_level: '',
                    summary: ''
                };
                setInitialState(fallbackData);

                const currentVersionEl = document.getElementById('aiCurrentVersionContentPreview');
                const draftEl = document.getElementById('aiDraftContentPreview');
                if (currentVersionEl) currentVersionEl.textContent = 'No content available';
                if (draftEl) {
                    // All versions can have draft content
                    draftEl.textContent = 'Draft content will appear here after applying AI prompts...';
                }
            }
        }

        async function applyAIPromptToDraft(lessonId, event) {
            const promptEl = document.getElementById('improvementPrompt');
            const applyBtn = document.getElementById('applyAIPromptBtn');
            const draftEl = document.getElementById('aiDraftContentPreview');
            const prompt = (promptEl?.value || '').trim();

            if (!prompt) {
                showNotification('Please enter instructions for AI', 'error');
                return;
            }

            // Get the content to edit - use draft if available, otherwise use original lesson content
            let contentToEdit = window.aiVersioningDraftContent;
            if (!contentToEdit || contentToEdit.trim() === '') {
                // If no draft content yet, use the stored original lesson content
                contentToEdit = window.aiVersioningOriginalContent || '';
            }

            if (!contentToEdit || contentToEdit === 'Draft content will appear here after applying AI prompts...') {
                showNotification('No lesson content available to edit', 'error');
                return;
            }

            // Loading state
            if (applyBtn) {
                applyBtn.disabled = true;
                applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Applying...';
            }
            // Hide finalize and modal close buttons during versioning apply
            setFinalizeAndModalCloseVisibility(true);

            // Disable all sidebar tabs during AI prompt application
            disableSidebarTabs();

            try {
                const response = await fetch(`/api/lessons/lesson/${lessonId}/apply_prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ prompt: prompt })
                });

                if (response.ok) {
                    const result = await response.json();
                    const newContent = result.draft_content || '';

                    if (!newContent.trim()) {
                        showNotification('AI returned empty content. Try a different prompt.', 'warning');
                    } else {
                        window.aiVersioningDraftContent = newContent;
                        console.log('DEBUG: applyAIPromptToDraft - draft content updated, length:', newContent.length);
                        console.log('DEBUG: applyAIPromptToDraft - draft content preview:', newContent.substring(0, 100) + '...');
                        if (draftEl) {
                            // Render markdown content properly
                            draftEl.innerHTML = marked.parse(newContent);
                        }
                        showNotification('AI prompt applied successfully!', 'success');
                    }
                    if (promptEl) promptEl.value = '';
                } else {
                    const err = await response.json().catch(() => ({}));
                    showNotification(`Error applying AI prompt: ${err.error || 'Failed'}`, 'error');
                }
            } catch (e) {
                showNotification('Network error applying AI prompt', 'error');
            } finally {
                if (applyBtn) {
                    applyBtn.disabled = false;
                    applyBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>Apply Prompt';
                }

                // Re-enable all sidebar tabs after AI prompt application completes
                enableSidebarTabs();
                // Restore finalize and modal close buttons visibility
                setFinalizeAndModalCloseVisibility(false);
            }
        }

        async function finalizeAIVersion(lessonId, event) {
            const finalizeBtn = document.getElementById('finalizeAIVersionBtn');
            const content = window.aiVersioningDraftContent || '';
            const meta = window.aiVersioningLessonMeta || {};

            console.log('DEBUG: finalizeAIVersion - content length:', content.length);
            console.log('DEBUG: finalizeAIVersion - content preview:', content.substring(0, 100) + '...');
            console.log('DEBUG: finalizeAIVersion - meta:', meta);

            if (!content.trim()) {
                showNotification('Draft is empty. Apply a prompt before finalizing.', 'error');
                return;
            }

            if (finalizeBtn) {
                finalizeBtn.disabled = true;
                finalizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Finalizing...';
            }

            // Disable all sidebar tabs during version finalization
            disableSidebarTabs();

            try {
                const response = await fetch(`/api/lessons/lesson/${lessonId}/finalize_version`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('New version created successfully!', 'success');
                    // Clear draft content after successful finalization
                    window.aiVersioningDraftContent = '';
                    // Refresh lesson data to reflect the new version
                    await refreshLessonData();
                    closeAIVersioningModal();
                    openViewLessons();
                } else {
                    const err = await response.json().catch(() => ({}));
                    showNotification(`Error creating version: ${err.error || 'Failed'}`, 'error');
                }
            } catch (e) {
                showNotification('Network error creating version', 'error');
            } finally {
                if (finalizeBtn) {
                    finalizeBtn.disabled = false;
                    finalizeBtn.innerHTML = 'Finalize New Version';
                }

                // Re-enable all sidebar tabs after version finalization completes
                enableSidebarTabs();
            }
        }

        function closeAIVersioningModal() {
            // Exit fullscreen if active
            const modalContent = document.getElementById('aiVersioningModalContent');
            if (modalContent && modalContent.classList.contains('fullscreen')) {
                toggleModalFullscreen('aiVersioningModal');
            }

            // Clear draft content when closing modal
            window.aiVersioningDraftContent = '';
            window.aiVersioningOriginalContent = '';
            window.aiVersioningLessonMeta = {};
            window.aiVersioningOriginalLessonId = null;

            const modal = document.getElementById('aiVersioningModal');
            if (modal) {
                modal.remove();
            }
        }

        async function createAIVersion(lessonId, event) {
            try {
                const improvementPrompt = document.getElementById('improvementPrompt').value;

                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating AI Version...';
                button.disabled = true;

                const response = await fetch(`/api/lessons/lesson/${lessonId}/create_ai_version`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        improvement_prompt: improvementPrompt
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification('AI-improved version created successfully!', 'success');

                    // Close modal and refresh lessons view
                    closeAIVersioningModal();
                    await refreshLessonData();
                    openViewLessons();

                } else {
                    const errorData = await response.json();
                    showNotification(`Error creating AI version: ${errorData.error || 'Creation failed'}`, 'error');
                }

            } catch (error) {
                console.error('Error creating AI version:', error);
                showNotification('Error creating AI version', 'error');
            } finally {
                // Reset button state
                const button = event.target;
                button.innerHTML = '<i class="fas fa-magic mr-2"></i>Create AI Version';
                button.disabled = false;
            }
        }
    </script>

    <!-- Emoji Picker Initialization: Place at end of body to ensure all elements exist and avoid DOMContentLoaded conflicts -->
    <script>
        (function () {
            const emojiBtn = document.getElementById('emojiBtn');
            const messageInput = document.getElementById('messageInput');
            if (emojiBtn && messageInput && window.EmojiButton) {
                const picker = new EmojiButton({ position: 'top-end', zIndex: 9999 });
                emojiBtn.addEventListener('click', function (e) {
                    picker.togglePicker(emojiBtn);
                });
                picker.on('emoji', function (emoji) {
                    const start = messageInput.selectionStart;
                    const end = messageInput.selectionEnd;
                    const text = messageInput.value;
                    messageInput.value = text.slice(0, start) + emoji + text.slice(end);
                    messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
                    messageInput.focus();
                });
            }
        })();
    </script>

    <style>
        .animate-bounce {
            animation: bounce 1s infinite;
        }

        /* Numbered lesson content styles */
        .numbered-line {
            display: flex;
            align-items: flex-start;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .numbered-line:hover {
            background-color: #f8fafc;
        }

        .line-number {
            flex-shrink: 0;
            min-width: 30px;
            font-size: 0.9em;
        }

        .line-content {
            flex: 1;
            line-height: 1.5;
        }

        .highlighted-line {
            background-color: #fef3c7 !important;
            border-left: 4px solid #f59e0b;
            animation: highlightPulse 0.5s ease-in-out;
        }

        @keyframes highlightPulse {
            0% {
                background-color: #fef3c7;
            }

            50% {
                background-color: #fde68a;
            }

            100% {
                background-color: #fef3c7;
            }
        }

        /* Zoom functionality - only affects text content */
        .zoomable-content {
            transition: font-size 0.2s ease;
        }

        /* Default zoom level */
        .zoom-100 {
            font-size: 100%;
        }

        .zoom-110 {
            font-size: 110%;
        }

        .zoom-125 {
            font-size: 125%;
        }

        .zoom-150 {
            font-size: 150%;
        }

        .zoom-175 {
            font-size: 175%;
        }

        .zoom-200 {
            font-size: 200%;
        }

        /* Apply zoom to specific content areas */
        .chat-messages,
        .lesson-content,
        .numbered-line,
        .line-content,
        .prose,
        .markdown-content,
        #lessonSummary,
        #studentLessonContent,
        .lesson-display-content {
            transition: font-size 0.2s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
            max-width: 100%;
        }

        /* Lesson content full width styles */
        #lessonDisplay,
        #humanReviewInterface,
        #aiReviewInterface {
            width: 100% !important;
            max-width: none !important;
        }

        #lessonSummary {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        #lessonSummary p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        #lessonSummary p:last-child {
            margin-bottom: 0;
        }

        /* Ensure sidebar and UI elements don't zoom */
        .sidebar,
        .sidebar-content,
        .chat-header,
        .chat-input-container,
        .modal-header,
        .modal-footer,
        .button,
        .btn,
        .nav,
        .navbar,
        .menu,
        .dropdown,
        .toolbar,
        .status-bar {
            font-size: inherit !important;
        }

        /* Selected text zoom styles */
        .selected-text-zoom {
            transition: all 0.2s ease;
            border-radius: 3px;
            display: inline-block;
        }

        .selected-text-zoom:hover {
            background-color: #fef3c7 !important;
            padding: 2px 4px !important;
        }

        @keyframes bounce {

            0%,
            20%,
            53%,
            80%,
            100% {
                transform: translate3d(0, 0, 0);
            }

            40%,
            43% {
                transform: translate3d(0, -15px, 0);
            }

            70% {
                transform: translate3d(0, -7px, 0);
            }

            90% {
                transform: translate3d(0, -2px, 0);
            }
        }

        @media (max-width: 768px) {
            .flex-1 {
                margin-left: 0 !important;
            }
        }

        /* Custom scrollbar */
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Hide scrollbar for chat messages area specifically */
        #chatMessages.overflow-y-auto::-webkit-scrollbar {
            display: none !important;
        }

        #chatMessages {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Ensure input area stays properly positioned */
        #chatInputArea {
            position: relative;
            z-index: 10;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        /* Hide scrollbar for sidebar and its dropdown */
        #sidebar {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        #sidebar::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }

        #sidebar * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        #sidebar *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }

        #dropdownContent {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        #dropdownContent::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }

        /* Fix visual connection between sidebar and main chat area */
        #sidebar {
            border-right: 1px solid #e5e7eb;
        }

        .flex.h-full {
            border: none;
        }

        /* Additional scrollbar hiding for all sidebar elements */
        #sidebar,
        #sidebar *,
        #sidebar div,
        #sidebar button,
        #sidebar .flex {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        #sidebar::-webkit-scrollbar,
        #sidebar *::-webkit-scrollbar,
        #sidebar div::-webkit-scrollbar,
        #sidebar button::-webkit-scrollbar,
        #sidebar .flex::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        /* Custom sidebar scroll class */
        .sidebar-scroll {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        .sidebar-scroll::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        /* Focus styles for accessibility */
        button:focus,
        input:focus,
        textarea:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }



        /* Enhanced hover effects */
        .hover\:shadow-md:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .hover\:shadow-xl:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Smooth transitions */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .transition-colors {
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .transition-shadow {
            transition-property: box-shadow;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        /* Token meter circular spinner */
        .token-circle {
            --size: 28px;
            --track: #e5e7eb;
            /* gray-200 */
            --fill: #05B0FC;
            /* brand */
            width: var(--size);
            height: var(--size);
            border-radius: 50%;
            background:
                conic-gradient(var(--fill) var(--p), var(--track) 0);
            display: grid;
            place-items: center;
            position: relative;
        }

        .token-circle::after {
            content: "";
            width: calc(var(--size) - 10px);
            height: calc(var(--size) - 10px);
            background: #fff;
            border-radius: 50%;
            position: absolute;
        }

        .token-percent {
            position: relative;
            font-size: 9px;
            font-weight: 600;
            color: #374151;
            /* gray-700 */
        }

        .token-spinner-overlay {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            animation: tokenSpin 1.2s linear infinite;
            background: conic-gradient(transparent 0 25%, rgba(5, 176, 252, 0.12) 0 50%, transparent 0 75%, rgba(5, 176, 252, 0.12) 0);
        }

        @keyframes tokenSpin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Header token meter styling */
        #tokenMeter {
            min-width: 120px;
            max-width: 160px;
            height: 40px;
            /* Match the height of the API key button */
            backdrop-filter: blur(8px);
            transition: all 0.2s ease-in-out;
            overflow: hidden;
        }

        #tokenMeter:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        /* Ensure text stays within bounds */
        #tokenMeter .truncate {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Compact token meter layout */
        #tokenMeter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #tokenMeter .flex-col {
            flex: 1;
            min-width: 0;
        }



        @media (max-width: 640px) {
            #tokenMeter {
                min-width: 100px;
                max-width: 140px;
                height: 40px;
                /* Maintain consistent height on mobile */
            }
        }

        /* Tab scrolling on mobile */
        .overflow-x-auto {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .overflow-x-auto::-webkit-scrollbar {
            display: none;
        }



        /* Modal overlay */
        .modal-overlay {
            backdrop-filter: blur(4px);
        }

        /* Modal animation */
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        /* Markdown content styling */
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
            color: #1f2937;
        }

        .markdown-content h1 {
            font-size: 1.25rem;
        }

        .markdown-content h2 {
            font-size: 1.125rem;
        }

        .markdown-content h3 {
            font-size: 1rem;
        }

        .markdown-content h4 {
            font-size: 0.875rem;
        }

        .markdown-content h5 {
            font-size: 0.875rem;
        }

        .markdown-content h6 {
            font-size: 0.875rem;
        }

        .markdown-content p {
            margin-bottom: 0.5rem;
            line-height: 1.4;
            font-size: 0.875rem;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 0.5rem;
            padding-left: 1rem;
        }

        .markdown-content li {
            margin-bottom: 0.125rem;
            font-size: 0.875rem;
        }

        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
        }

        .markdown-content pre {
            background-color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
            overflow-x: auto;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }

        .markdown-content blockquote {
            border-left: 2px solid #e5e7eb;
            padding-left: 0.5rem;
            margin-left: 0;
            color: #6b7280;
            font-style: italic;
            font-size: 0.875rem;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>

    <!-- FAQ Modal -->
    <div id="faqModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-[#05B0FC] to-blue-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-question-circle mr-3"></i>
                    <span id="faqModalTitle">Frequently Asked Questions</span>
                </h3>
                <button onclick="closeFaqModal()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)] min-h-[300px]">
                <div id="faqModalContent">
                    <!-- FAQ content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-[#05B0FC] to-blue-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-key mr-3"></i>
                    Update API Key
                </h3>
                <button onclick="closeApiKeyModal()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div class="text-gray-600 space-y-3 mb-6">
                    <h4 class="font-semibold text-gray-800">How to get your GROQ API Key:</h4>
                    <p class="text-sm">1. Visit <a href="https://console.groq.com/" target="_blank"
                            class="text-blue-600 hover:underline">console.groq.com</a></p>
                    <p class="text-sm">2. Sign up or log in to your account</p>
                    <p class="text-sm">3. Go to the API Keys section</p>
                    <p class="text-sm">4. Click "Create API Key"</p>
                    <p class="text-sm">5. Copy your API key and paste it below</p>
                    <p class="text-xs text-gray-500">Your API key should start with "gsk_"</p>
                </div>

                <div class="mb-6">
                    <label for="apiKeyModalInput" class="block text-sm font-medium text-gray-700 mb-2">
                        API Key
                    </label>
                    <div class="relative">
                        <input type="password" id="apiKeyModalInput" placeholder="Enter your GROQ API key..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 pr-12 text-sm" />
                        <button onclick="toggleApiKeyModalVisibility()"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye" id="apiKeyModalToggleIcon"></i>
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="clearApiKeyModal()"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Clear
                    </button>
                    <button onclick="saveApiKeyModal()" id="saveApiKeyModalBtn"
                        class="flex-1 px-4 py-2 bg-gradient-to-r from-[#05B0FC] to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-[#05B0FC] transition-all duration-200 font-semibold">
                        Save API Key
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>